<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#0a1a0f"/>
  <title>AgriUstad â€” Field Map</title>

  <link rel="icon" href="/static/icons/icon-192.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS (Synced with index.html)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --c-bg:           #080f0b;
  --c-surface-md:   rgba(255,255,255,0.06);
  --c-surface-hi:   rgba(255,255,255,0.10);
  --c-border:       rgba(255,255,255,0.08);
  --c-border-hi:    rgba(255,255,255,0.16);
  
  --c-green-900:    #0a2e14;
  --c-green-700:    #1a5c2a;
  --c-green-500:    #2d8a44;
  --c-green-400:    #3dab55;
  --c-green-300:    #5ecb74;
  
  --c-gold:         #c9a84c;
  --c-gold-light:   #e8c96a;
  --c-amber:        #f0a830;
  --c-error:        #e05252;

  --c-text:         #e8f4eb;
  --c-text-2:       rgba(232,244,235,0.65);
  --c-text-3:       rgba(232,244,235,0.38);

  --glass-blur-lg:  40px;

  --r-md:   18px;
  --r-lg:   28px;
  --r-xl:   40px;
  --r-full: 9999px;

  --shadow-sm:   0 4px 16px rgba(0,0,0,0.4);
  --shadow-md:   0 8px 24px rgba(0,0,0,0.5);
  --shadow-lg:   0 20px 60px rgba(0,0,0,0.60);
  --shadow-glow: 0 0 40px rgba(45,138,68,0.18);

  --ff-display: 'Cormorant Garamond', Georgia, serif;
  --ff-body:    'DM Sans', system-ui, sans-serif;
  --ff-mono:    'DM Mono', monospace;

  --transition: 0.3s cubic-bezier(0.4,0,0.2,1);

  --sidebar-w: 380px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--ff-body);
  font-size: 14px;
  color: var(--c-text);
  background: var(--c-bg);
  -webkit-font-smoothing: antialiased;
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP & ORBS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#map {
  position: fixed; inset: 0; z-index: 0;
  /* Removed the heavy vintage dimming effect to make it bright and clear */
  filter: brightness(0.95) saturate(1.1);
  transition: filter 0.6s ease;
}
#map.focus-mode { filter: brightness(1.0) saturate(1.2); }

.map-vignette {
  position: fixed; inset: 0; z-index: 1; pointer-events: none;
  /* Removed the central dark circle. Kept only a soft shadow behind the sidebar so text is readable */
  background: linear-gradient(to right, rgba(8,15,11,0.85) 0%, rgba(8,15,11,0.4) var(--sidebar-w), transparent calc(var(--sidebar-w) + 100px));
}

.orb { position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:2;animation:orbFloat 20s ease-in-out infinite; mix-blend-mode: screen; opacity: 0.6;}
.orb-1{width:420px;height:420px;background:radial-gradient(circle,rgba(45,138,68,0.3) 0%,transparent 70%);top:-120px;left:calc(var(--sidebar-w) - 100px);animation-delay:0s;}
.orb-2{width:320px;height:320px;background:radial-gradient(circle,rgba(201,168,76,0.15) 0%,transparent 70%);bottom:80px;right:-80px;animation-delay:-8s;}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(30px,-40px) scale(1.05);}66%{transform:translate(-20px,25px) scale(0.96);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.glass-nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 200;
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px; background: rgba(8,15,11,0.72);
  backdrop-filter: blur(24px) saturate(200%); -webkit-backdrop-filter: blur(24px) saturate(200%);
  border-bottom: 1px solid var(--c-border);
}

.nav-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; font-family: var(--ff-display); font-size: 22px; font-weight: 600; color: var(--c-text); letter-spacing: 0.01em; }
.logo-icon { display: grid; place-items: center; width: 34px; height: 34px; background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500)); border-radius: 10px; font-size: 16px; box-shadow: 0 4px 12px rgba(45,138,68,0.3), inset 0 1px 0 rgba(255,255,255,0.15); }
.nav-right { display: flex; align-items: center; gap: 12px; }

.scan-badge { display: flex; align-items: center; gap: 7px; padding: 7px 14px; border-radius: var(--r-full); background: var(--c-surface-md); border: 1px solid var(--c-border); font-size: 13px; font-family: var(--ff-mono); color: var(--c-text-2); }
.scan-badge .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--c-green-400); box-shadow: 0 0 6px var(--c-green-400); animation: blink 2s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.3;} }

.btn-new { display: flex; align-items: center; gap: 7px; padding: 9px 18px; border-radius: var(--r-full); border: none; background: linear-gradient(135deg, var(--c-green-500), var(--c-green-700)); color: #fff; font-size: 13.5px; font-weight: 600; font-family: var(--ff-body); letter-spacing: 0.03em; cursor: pointer; text-decoration: none; box-shadow: 0 6px 20px rgba(45,138,68,0.35), inset 0 1px 0 rgba(255,255,255,0.2); transition: var(--transition); }
.btn-new:hover { transform: translateY(-2px); box-shadow: 0 8px 26px rgba(45,138,68,0.45); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP OVERLAYS (SEARCH & WEATHER)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.map-search-container {
  position: fixed; top: 80px; left: calc(var(--sidebar-w) + 24px); z-index: 100;
  display: flex; gap: 8px;
}
.map-search-input {
  width: 280px; padding: 12px 16px; border-radius: var(--r-full);
  background: rgba(10,18,12,0.85); backdrop-filter: blur(20px);
  border: 1px solid var(--c-border); color: var(--c-text); font-family: var(--ff-body);
  font-size: 13.5px; outline: none; transition: var(--transition); box-shadow: var(--shadow-sm);
}
.map-search-input:focus { border-color: var(--c-green-500); box-shadow: 0 0 0 3px rgba(45,138,68,0.15); }
.map-search-input::placeholder { color: var(--c-text-3); }

.map-search-btn {
  display: grid; place-items: center; width: 44px; height: 44px; border-radius: 50%;
  background: linear-gradient(135deg, var(--c-green-500), var(--c-green-700));
  border: none; color: white; cursor: pointer; transition: var(--transition);
  box-shadow: var(--shadow-sm);
}
.map-search-btn:hover { transform: scale(1.05); }

.weather-widget {
  position: fixed; top: 136px; left: calc(var(--sidebar-w) + 24px); z-index: 100;
  display: flex; align-items: center; gap: 10px; padding: 10px 18px;
  background: rgba(10,18,12,0.85); backdrop-filter: blur(20px); border: 1px solid var(--c-border);
  border-radius: var(--r-full); cursor: pointer; box-shadow: var(--shadow-sm);
  transition: var(--transition);
}
.weather-widget:hover { background: rgba(45,138,68,0.15); border-color: var(--c-green-500); transform: translateY(-2px);}
.weather-widget span { font-family: var(--ff-mono); font-size: 15px; font-weight: 600; color: var(--c-text); }
.weather-widget .w-icon { font-size: 18px; }

.forecast-popup {
  position: fixed; top: 190px; left: calc(var(--sidebar-w) + 24px); z-index: 100;
  width: 280px; background: rgba(10,18,12,0.95); backdrop-filter: blur(30px);
  border: 1px solid var(--c-border); border-radius: var(--r-lg); padding: 16px;
  box-shadow: var(--shadow-lg); opacity: 0; transform: translateY(-10px) scale(0.95);
  pointer-events: none; transition: var(--transition);
}
.forecast-popup.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
.forecast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-family: var(--ff-display); font-size: 18px; font-weight: 600; color: var(--c-green-300); }
.forecast-header button { background: none; border: none; color: var(--c-text-3); font-size: 20px; cursor: pointer; transition: var(--transition); }
.forecast-header button:hover { color: var(--c-text); }
.forecast-day { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-family: var(--ff-mono); font-size: 12.5px; }
.forecast-day:last-child { border-bottom: none; }
.forecast-day .day-name { color: var(--c-text-2); width: 60px; }
.forecast-day .day-temps { color: var(--c-text); font-weight: 500; }
.forecast-day .day-temps span { color: var(--c-text-3); margin-left: 6px; font-weight: 400; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  position: fixed; top: 62px; left: 0; bottom: 0; width: var(--sidebar-w); z-index: 100;
  display: flex; flex-direction: column; gap: 0; padding: 24px 20px 24px;
  background: rgba(10, 18, 12, 0.75); backdrop-filter: blur(var(--glass-blur-lg)) saturate(180%);
  border-right: 1px solid var(--c-border); box-shadow: 20px 0 60px rgba(0,0,0,0.4), 0 0 40px rgba(45,138,68,0.05); overflow: hidden;
}
.sidebar::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(94,203,116,0.3), transparent); }

.sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-shrink: 0; }
.sidebar-title { font-family: var(--ff-display); font-size: 28px; font-weight: 600; color: var(--c-text); letter-spacing: -0.01em; }
.sidebar-count { font-family: var(--ff-mono); font-size: 11px; color: var(--c-text-3); letter-spacing: 0.06em; text-transform: uppercase; background: var(--c-surface-md); border: 1px solid var(--c-border); padding: 4px 10px; border-radius: var(--r-full); }

.search-wrap { position: relative; margin-bottom: 16px; flex-shrink: 0; }
.search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 14px; color: var(--c-text-3); pointer-events: none; }
.search-input { width: 100%; padding: 12px 14px 12px 40px; background: rgba(255,255,255,0.04); border: 1px solid var(--c-border); border-radius: var(--r-md); color: var(--c-text); font-size: 13.5px; font-family: var(--ff-body); outline: none; transition: var(--transition); }
.search-input::placeholder { color: var(--c-text-3); }
.search-input:focus { border-color: var(--c-green-500); background: rgba(255,255,255,0.07); box-shadow: 0 0 0 3px rgba(45,138,68,0.12); }

.filter-row { display: flex; gap: 8px; margin-bottom: 20px; flex-shrink: 0; flex-wrap: wrap; }
.chip { padding: 6px 14px; border-radius: var(--r-full); border: 1px solid var(--c-border); background: var(--c-surface-md); color: var(--c-text-3); font-size: 12px; font-weight: 500; font-family: var(--ff-body); cursor: pointer; transition: var(--transition); letter-spacing: 0.02em; white-space: nowrap; }
.chip:hover { border-color: var(--c-green-500); color: var(--c-green-300); background: rgba(45,138,68,0.08); }
.chip.active { border-color: var(--c-green-400); color: var(--c-green-300); background: rgba(45,138,68,0.15); box-shadow: inset 0 1px 0 rgba(94,203,116,0.15); }

.history-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 4px; scrollbar-width: thin; scrollbar-color: var(--c-border) transparent; }

.hist-item { position: relative; padding: 18px; background: rgba(255,255,255,0.04); border: 1px solid var(--c-border); border-radius: 20px; cursor: pointer; transition: var(--transition); animation: itemIn 0.4s ease both; overflow: hidden; margin-bottom: 12px; }
.hist-item::before { content: ''; position: absolute; left: 0; top: 16%; bottom: 16%; width: 3px; border-radius: 0 3px 3px 0; background: var(--c-green-500); opacity: 0; transition: opacity var(--transition); }
@keyframes itemIn { from { opacity:0; transform: translateX(-12px); } to { opacity:1; transform: translateX(0); } }
.hist-item:hover { background: rgba(45,138,68,0.07); border-color: rgba(45,138,68,0.3); transform: translateX(4px); box-shadow: var(--shadow-sm); }
.hist-item:hover::before { opacity: 1; }
.hist-item.selected { background: rgba(45,138,68,0.12); border-color: var(--c-green-400); box-shadow: 0 8px 24px rgba(45,138,68,0.2), inset 0 1px 0 rgba(94,203,116,0.15); }
.hist-item.selected::before { opacity: 1; }

.hist-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
.hist-name { font-size: 14px; font-weight: 600; color: var(--c-text); line-height: 1.4; flex: 1; }
.score-pill { flex-shrink: 0; display: grid; place-items: center; width: 38px; height: 38px; border-radius: 50%; font-family: var(--ff-mono); font-size: 12.5px; font-weight: 500; border: 1.5px solid; }
.score-pill.high  { background: rgba(224,82,82,0.15);  border-color: rgba(224,82,82,0.4);  color: #f08080; }
.score-pill.med   { background: rgba(240,168,48,0.12); border-color: rgba(240,168,48,0.4); color: var(--c-gold-light); }
.score-pill.low   { background: rgba(45,138,68,0.15);  border-color: rgba(45,138,68,0.45); color: var(--c-green-300); }

.hist-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.meta-chip { display: flex; align-items: center; gap: 4px; font-size: 11.5px; color: var(--c-text-3); font-family: var(--ff-mono); }

.sev-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: var(--r-full); font-size: 10.5px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; }
.sev-badge.yellow { background: rgba(240,168,48,0.12); border: 1px solid rgba(240,168,48,0.3); color: var(--c-gold-light); }
.sev-badge.red    { background: rgba(224,82,82,0.12);  border: 1px solid rgba(224,82,82,0.3);  color: #f08080; }
.sev-badge.green  { background: rgba(45,138,68,0.15);  border: 1px solid rgba(45,138,68,0.35); color: var(--c-green-300); }
.sev-badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: currentColor; }

.sev-bar-track { height: 3px; border-radius: 2px; background: rgba(255,255,255,0.08); overflow: hidden; }
.sev-bar-fill { height: 100%; border-radius: 2px; transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP CONTROLS & STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.map-controls { position: fixed; bottom: 28px; right: 28px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
.map-ctrl-btn { display: grid; place-items: center; width: 46px; height: 46px; border-radius: var(--r-md); background: rgba(10,18,12,0.85); backdrop-filter: blur(20px); border: 1px solid var(--c-border); color: var(--c-text-2); font-size: 18px; cursor: pointer; transition: var(--transition); box-shadow: var(--shadow-md); }
.map-ctrl-btn:hover { background: rgba(45,138,68,0.15); border-color: var(--c-green-500); color: var(--c-green-300); }

.map-stats { position: fixed; bottom: 28px; left: calc(var(--sidebar-w) + 24px); z-index: 100; display: flex; gap: 12px; }
.stat-pill { display: flex; align-items: center; gap: 8px; padding: 10px 18px; background: rgba(10,18,12,0.85); backdrop-filter: blur(20px); border: 1px solid var(--c-border); border-radius: var(--r-full); font-size: 13px; font-family: var(--ff-mono); color: var(--c-text-2); box-shadow: var(--shadow-sm); }
.stat-pill strong { color: var(--c-text); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL PANEL & MARKERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detail-panel {
  position: fixed; top: 62px; right: 0; bottom: 0; width: 340px; z-index: 150;
  padding: 28px 24px; background: rgba(10, 18, 12, 0.9);
  backdrop-filter: blur(var(--glass-blur-lg)) saturate(200%); border-left: 1px solid var(--c-border);
  display: flex; flex-direction: column; gap: 20px;
  transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.34,1.2,0.64,1);
  overflow-y: auto; box-shadow: -20px 0 60px rgba(0,0,0,0.5);
}
.detail-panel.open { transform: translateX(0); }
.detail-close { position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--c-border); background: var(--c-surface-md); color: var(--c-text-3); font-size: 16px; cursor: pointer; display: grid; place-items: center; transition: var(--transition); }
.detail-close:hover { color: var(--c-text); background: var(--c-surface-hi); transform: rotate(90deg);}

.detail-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.07em; color: var(--c-text-3); margin-bottom: 4px; }
.detail-val   { font-size: 14.5px; font-weight: 500; color: var(--c-text); line-height: 1.5; }
.detail-row { padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--c-border); border-radius: var(--r-md); }
.detail-title { font-family: var(--ff-display); font-size: 24px; font-weight: 600; color: var(--c-text); line-height: 1.2; margin-bottom: 8px; padding-right: 30px;}
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.detail-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 13px; border-radius: var(--r-md); border: 1px solid var(--c-green-500); background: rgba(45,138,68,0.12); color: var(--c-green-300); font-size: 13.5px; font-weight: 600; font-family: var(--ff-body); cursor: pointer; transition: var(--transition); text-decoration: none; }
.detail-btn:hover { background: rgba(45,138,68,0.25); box-shadow: 0 6px 20px rgba(45,138,68,0.25); transform: translateY(-2px); }
.detail-btn-outline { background: var(--c-surface-md); border-color: var(--c-border); color: var(--c-text-2); }
.detail-footer { margin-top: auto; font-size: 11px; text-align: center; color: var(--c-text-3); font-family: var(--ff-mono); padding-top: 20px;}

.custom-marker { position: relative; display: flex; flex-direction: column; align-items: center; }
.marker-pin { width: 42px; height: 42px; border-radius: 50% 50% 50% 4px; transform: rotate(45deg); display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.3); box-shadow: 0 8px 24px rgba(0,0,0,0.6); }
.marker-pin .inner { transform: rotate(-45deg); font-family: var(--ff-mono); font-size: 12px; font-weight: 700; color: #fff; letter-spacing: -0.02em; }
.marker-pin.high   { background: linear-gradient(135deg, #e05252, #b83535); }
.marker-pin.med    { background: linear-gradient(135deg, #f0a830, #c87a10); }
.marker-pin.low    { background: linear-gradient(135deg, #2d8a44, #1a5c2a); }

.leaflet-popup-content-wrapper { background: rgba(10,18,12,0.95) !important; backdrop-filter: blur(24px) !important; border: 1px solid rgba(255,255,255,0.12) !important; border-radius: 20px !important; box-shadow: 0 16px 48px rgba(0,0,0,0.6) !important; color: var(--c-text) !important; font-family: var(--ff-body) !important; padding: 0 !important; }
.leaflet-popup-content { margin: 0 !important; }
.leaflet-popup-tip { background: rgba(10,18,12,0.95) !important; }
.leaflet-popup-close-button { color: var(--c-text-3) !important; font-size: 20px !important; top: 10px !important; right: 12px !important; }
.popup-inner { padding: 18px 20px; min-width: 220px; }
.popup-disease { font-size: 14.5px; font-weight: 600; color: var(--c-text); margin-bottom: 8px; }
.popup-meta { font-size: 12px; color: var(--c-text-3); font-family: var(--ff-mono); margin-bottom: 12px; }
.popup-score { display: inline-block; padding: 4px 12px; border-radius: var(--r-full); font-size: 11.5px; font-family: var(--ff-mono); font-weight: 600; border: 1px solid rgba(255,255,255,0.2);}

/* Mobile */
@media (max-width: 760px) {
  :root { --sidebar-w: 100vw; }
  .sidebar { border-right: none; }
  .map-stats, .map-search-container, .weather-widget, .forecast-popup { left: 16px; }
  .detail-panel { width: 100%; }
}
</style>
</head>
<body>

<div id="map"></div>
<div class="map-vignette"></div>
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>

<nav class="glass-nav">
  <a class="nav-brand" href="/">
    <span class="logo-icon">ğŸŒ¿</span>
    AgriUstad
  </a>
  <div class="nav-right">
    <div class="scan-badge">
      <div class="dot"></div>
      <span id="totalScans">21</span> <span data-i18n="navScans">Scans</span>
    </div>
    <a href="/" class="btn-new">+ &nbsp;<span data-i18n="navNewScan">New Scan</span></a>
  </div>
</nav>

<div class="map-search-container">
  <input type="text" id="mapSearchInput" class="map-search-input" placeholder="Search location (e.g. Pune)..." onkeypress="handleMapSearch(event)"/>
  <button class="map-search-btn" onclick="executeMapSearch()" title="Search">ğŸ”</button>
</div>

<div id="weatherWidget" class="weather-widget" style="display: none;" onclick="toggleForecast()">
  <span class="w-icon" id="wwIcon">ğŸŒ¤ï¸</span>
  <span id="wwTemp">--Â°C</span>
</div>

<div id="forecastPopup" class="forecast-popup">
  <div class="forecast-header">
    7-Day Forecast
    <button onclick="toggleForecast()">Ã—</button>
  </div>
  <div id="forecastList"></div>
</div>

<aside class="sidebar">
  <div class="sidebar-header">
    <h1 class="sidebar-title" data-i18n="histTitle">Field History</h1>
    <span class="sidebar-count" id="scanCount">21 records</span>
  </div>

  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input class="search-input" id="searchInput" placeholder="Search scansâ€¦" oninput="filterScans(this.value)"/>
  </div>

  <div class="filter-row">
    <button class="chip active" onclick="filterByTag('all',this)" data-i18n="tagAll">All</button>
    <button class="chip" onclick="filterByTag('disease',this)">ğŸ¦  <span data-i18n="tagDisease">Disease</span></button>
    <button class="chip" onclick="filterByTag('soil',this)">ğŸŸ¤ <span data-i18n="tagSoil">Soil</span></button>
    <button class="chip" onclick="filterByTag('yield',this)">ğŸ‡ <span data-i18n="tagYield">Yield</span></button>
    <button class="chip" onclick="filterByTag('high',this)">ğŸ”´ <span data-i18n="tagCrit">Critical</span></button>
  </div>

  <div class="history-list" id="histList"></div>
</aside>

<div class="map-stats">
  <div class="stat-pill">ğŸ“ <strong>20.296, 85.824</strong> â€” Bhubaneswar</div>
  <div class="stat-pill">ğŸ¦  <strong id="critCount">3</strong> <span data-i18n="mapCrit">critical today</span></div>
</div>

<div class="map-controls">
  <button class="map-ctrl-btn" id="heatmapToggle" onclick="toggleHeatmap()" title="Toggle Disease Heatmap">ğŸ”¥</button>
  
  <button class="map-ctrl-btn" onclick="map.zoomIn()"  title="Zoom in">+</button>
  <button class="map-ctrl-btn" onclick="map.zoomOut()" title="Zoom out">âˆ’</button>
  <button class="map-ctrl-btn" onclick="recenter()"    title="Recenter">âŠ™</button>
</div>

<div class="detail-panel" id="detailPanel">
  <button class="detail-close" onclick="closeDetail()">Ã—</button>
  <div id="detailContent"></div>
  <div class="detail-footer">AgriUstad Â· Hacknovation 2.0 Project</div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAMPLE DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const scans = [
  { id:1,  name:"Not a crop disease â€” Natural leaf senescence and decomposition", date:"21/02/2026", lat:20.296, lon:85.824, sev:"yellow", score:100, type:"disease", treat:"No treatment needed. Remove dead matter.", eco:8 },
  { id:2,  name:"Advanced Leaf Senescence and Decomposition",                    date:"21/02/2026", lat:20.286, lon:85.834, sev:"yellow", score:100, type:"disease", treat:"Improve soil drainage.", eco:7 },
  { id:3,  name:"Severe Drought Stress / Soil Moisture Deficiency",              date:"21/02/2026", lat:20.301, lon:85.820, sev:"yellow", score:95,  type:"disease", treat:"Irrigate immediately. Apply mulch.", eco:4 },
  { id:4,  name:"Soil Analysis",                                                  date:"21/02/2026", lat:20.293, lon:85.830, sev:"green",  score:9,   type:"soil",    treat:"Balanced NPK levels. No action needed.", eco:9 },
  { id:5,  name:"Extreme Leaf Necrosis and Skeletonization (Senescence)",        date:"21/02/2026", lat:20.280, lon:85.815, sev:"yellow", score:100, type:"disease", treat:"Remove affected leaves. Apply fungicide.", eco:3 },
  { id:6,  name:"Fungal Blight â€” Early Stage",                                   date:"20/02/2026", lat:20.310, lon:85.840, sev:"red",    score:88,  type:"disease", treat:"Apply copper-based fungicide.", eco:5 },
  { id:7,  name:"Healthy Crop â€” No Anomaly Detected",                            date:"20/02/2026", lat:20.275, lon:85.810, sev:"green",  score:5,   type:"disease", treat:"Continue regular care.", eco:10 },
  { id:8,  name:"Yield Estimation â€” Mango Orchard",                              date:"19/02/2026", lat:20.295, lon:85.818, sev:"green",  score:12,  type:"yield",   treat:"Harvest readiness: 80%. Estimated 4.2 tons.", eco:9 },
  { id:9,  name:"Bacterial Leaf Spot",                                            date:"19/02/2026", lat:20.305, lon:85.825, sev:"red",    score:78,  type:"disease", treat:"Remove infected leaves. Apply bactericide.", eco:4 },
  { id:10, name:"Nitrogen Deficiency",                                            date:"18/02/2026", lat:20.288, lon:85.828, sev:"yellow", score:62,  type:"soil",    treat:"Apply urea at 25kg/acre.", eco:6 },
];

let activeTag    = 'all';
let selectedId   = null;
let markerMap    = {};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEAFLET MAP INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const map = L.map('map', {
  center: [20.296, 85.824],
  zoom: 10,
  zoomControl: false,
  attributionControl: false
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

function recenter() { map.flyTo([20.296, 85.824], 10, { duration: 1 }); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“ NEW: GPS LOCATION DETECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function locateUser() {
  map.locate({setView: true, maxZoom: 14});
}
map.on('locationfound', function(e) {
  // Add a glowing blue dot for user location
  L.circleMarker(e.latlng, {
    radius: 8, fillColor: '#00B0FF', color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
  }).addTo(map);
});
map.on('locationerror', function(e) {
  alert("Could not access your device's location.");
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ NEW: NOMINATIM GEOCODING (SEARCH)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function executeMapSearch() {
  const query = document.getElementById('mapSearchInput').value;
  if (!query) return;
  
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (data && data.length > 0) {
      const lat = parseFloat(data[0].lat);
      const lon = parseFloat(data[0].lon);
      map.flyTo([lat, lon], 12, { duration: 1.5 });
    } else {
      alert("Location not found. Try a different spelling.");
    }
  } catch(e) {
    console.error("Search error", e);
  }
}
function handleMapSearch(e) { if (e.key === 'Enter') executeMapSearch(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸŒ¤ï¸ NEW: DYNAMIC WEATHER & FORECAST (Open-Meteo)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WMO_CODES = {
  0: "â˜€ï¸", 1: "ğŸŒ¤ï¸", 2: "â›…", 3: "â˜ï¸",
  45: "ğŸŒ«ï¸", 48: "ğŸŒ«ï¸",
  51: "ğŸŒ¦ï¸", 53: "ğŸŒ¦ï¸", 55: "ğŸŒ§ï¸",
  61: "ğŸŒ§ï¸", 63: "ğŸŒ§ï¸", 65: "ğŸŒ§ï¸",
  71: "â„ï¸", 73: "â„ï¸", 75: "â„ï¸",
  95: "â›ˆï¸", 96: "â›ˆï¸", 99: "â›ˆï¸"
};

let weatherDebounce;

// Trigger weather check when map movement stops
map.on('moveend', () => {
  // Only show weather if zoomed in enough (Level 11+)
  if (map.getZoom() >= 11) {
    clearTimeout(weatherDebounce);
    weatherDebounce = setTimeout(updateWeather, 800);
  } else {
    document.getElementById('weatherWidget').style.display = 'none';
    document.getElementById('forecastPopup').classList.remove('open');
  }
});

async function updateWeather() {
  const center = map.getCenter();
  try {
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${center.lat}&longitude=${center.lng}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=auto`);
    const data = await res.json();
    
    // Update Widget
    const cw = data.current_weather;
    const icon = WMO_CODES[cw.weathercode] || "ğŸŒ¤ï¸";
    document.getElementById('wwIcon').textContent = icon;
    document.getElementById('wwTemp').textContent = `${Math.round(cw.temperature)}Â°C`;
    
    // Animate widget in
    const widget = document.getElementById('weatherWidget');
    widget.style.display = 'flex';
    widget.style.animation = 'itemIn 0.4s ease forwards';

    // Build Forecast List
    const daily = data.daily;
    let html = '';
    for (let i = 0; i < 7; i++) {
      const dateStr = new Date(daily.time[i]).toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric'});
      const dIcon = WMO_CODES[daily.weathercode[i]] || "ğŸŒ¤ï¸";
      const tMax = Math.round(daily.temperature_2m_max[i]);
      const tMin = Math.round(daily.temperature_2m_min[i]);
      html += `
        <div class="forecast-day">
          <span class="day-name">${i === 0 ? 'Today' : dateStr.split(' ')[0]}</span>
          <span>${dIcon}</span>
          <span class="day-temps"><span>H:</span>${tMax}Â° <span>L:</span>${tMin}Â°</span>
        </div>
      `;
    }
    document.getElementById('forecastList').innerHTML = html;
  } catch (e) {
    console.error("Weather fetch failed", e);
  }
}

function toggleForecast() {
  document.getElementById('forecastPopup').classList.toggle('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCORE â†’ severity CLASS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sevClass(score) {
  if (score >= 80) return 'high';
  if (score >= 40) return 'med';
  return 'low';
}
function barColor(score) {
  if (score >= 80) return 'linear-gradient(90deg,#2d8a44,#f0a830,#e05252)';
  if (score >= 40) return 'linear-gradient(90deg,#2d8a44,#f0a830)';
  return '#2d8a44';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER MARKERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMarkers(list) {
  Object.values(markerMap).forEach(m => map.removeLayer(m));
  markerMap = {};

  list.forEach(scan => {
    const cls   = sevClass(scan.score);
    const icon  = L.divIcon({
      className: '',
      html: `<div class="custom-marker">
        <div class="marker-pulse"></div>
        <div class="marker-pin ${cls}">
          <div class="inner">${scan.score}</div>
        </div>
      </div>`,
      iconSize:   [42, 42],
      iconAnchor: [21, 42],
      popupAnchor:[0, -46],
    });

    const popupHtml = `<div class="popup-inner">
      <div class="popup-disease">${escHtml(scan.name)}</div>
      <div class="popup-meta">ğŸ“… ${scan.date} &nbsp;Â·&nbsp; ğŸ“ ${scan.lat}, ${scan.lon}</div>
      <span class="popup-score sev-badge ${scan.sev}">${scan.sev.toUpperCase()}</span>
    </div>`;

    const marker = L.marker([scan.lat, scan.lon], { icon })
      .addTo(map)
      .bindPopup(popupHtml, { maxWidth: 280, closeButton: true });

    marker.on('click', () => selectScan(scan.id));
    markerMap[scan.id] = marker;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER HISTORY LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderList(list) {
  const container = document.getElementById('histList');
  container.innerHTML = '';

  if (list.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:40px 16px;color:var(--c-text-3);">
      <div style="font-size:32px;margin-bottom:10px;">ğŸ”</div>
      <div style="font-family:var(--ff-display);font-size:18px;color:var(--c-text-2);">No results</div>
      <div style="font-size:12px;margin-top:6px;">Try a different search or filter</div>
    </div>`;
    return;
  }

  list.forEach((scan, i) => {
    const cls = sevClass(scan.score);
    const item = document.createElement('div');
    item.className = 'hist-item' + (scan.id === selectedId ? ' selected' : '');
    item.dataset.id = scan.id;
    item.style.animationDelay = (i * 0.04) + 's';
    
    // Add correct icon based on scan mode
    let typeIcon = 'ğŸŒ¿';
    if(scan.type === 'soil') typeIcon = 'ğŸŸ¤';
    if(scan.type === 'yield') typeIcon = 'ğŸ‡';
    const typeName = scan.type.charAt(0).toUpperCase() + scan.type.slice(1);

    // Highly structured HTML for the card
    item.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="font-size: 10.5px; color: var(--c-green-400); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; display:flex; align-items:center; gap:5px;">
          ${typeIcon} ${typeName}
        </span>
        <span style="font-family: var(--ff-mono); font-size: 11px; color: var(--c-text-3);">
          ${scan.date}
        </span>
      </div>
      
      <div class="hist-top" style="align-items: center; margin-bottom: 12px;">
        <div class="hist-name" style="font-size: 15px; line-height: 1.3;">${escHtml(scan.name)}</div>
        <div class="score-pill ${cls}" style="width: 36px; height: 36px; font-size: 12.5px;">${scan.score}</div>
      </div>
      
      <div style="display:flex; align-items:center; gap:12px; background: rgba(0,0,0,0.25); padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.03);">
        <span class="sev-badge ${scan.sev}" style="padding: 3px 8px; font-size: 10px;">${scan.sev.toUpperCase()}</span>
        <div class="sev-bar-track" style="flex:1; height: 4px; background: rgba(255,255,255,0.08);">
          <div class="sev-bar-fill" style="width:${scan.score}%;background:${barColor(scan.score)};"></div>
        </div>
      </div>
    `;
    item.addEventListener('click', () => selectScan(scan.id));
    container.appendChild(item);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELECT A SCAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectScan(id) {
  selectedId = id;
  const scan = scans.find(s => s.id === id);
  if (!scan) return;

  document.querySelectorAll('.hist-item').forEach(el => {
    el.classList.toggle('selected', parseInt(el.dataset.id) === id);
  });

  map.flyTo([scan.lat, scan.lon], 13, { duration: 1.2 });
  if (markerMap[id]) markerMap[id].openPopup();
  document.getElementById('map').classList.add('focus-mode');

  const cls = sevClass(scan.score);
  document.getElementById('detailContent').innerHTML = `
    <div class="detail-title">${escHtml(scan.name)}</div>
    <span class="sev-badge ${scan.sev}" style="margin-bottom:20px;display:inline-flex;">${scan.sev.toUpperCase()}</span>

    <div class="detail-row">
      <div class="detail-label" data-i18n="detSev">Severity Score</div>
      <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
        <div class="score-pill ${cls}" style="width:46px;height:46px;font-size:14px;">${scan.score}</div>
        <div style="flex:1;">
          <div class="sev-bar-track">
            <div class="sev-bar-fill" style="width:${scan.score}%;background:${barColor(scan.score)};"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-row">
      <div class="detail-label" data-i18n="detTreat">Treatment Recommendation</div>
      <div class="detail-val" style="margin-top:6px;">${escHtml(scan.treat)}</div>
    </div>

    <div class="detail-grid">
      <div class="detail-row">
        <div class="detail-label" data-i18n="detDate">Date</div>
        <div class="detail-val">${scan.date}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label" data-i18n="detEco">Eco Score</div>
        <div class="detail-val" style="color:var(--c-green-300);font-family:var(--ff-mono);">${scan.eco}/10</div>
      </div>
      <div class="detail-row">
        <div class="detail-label" data-i18n="detLat">Latitude</div>
        <div class="detail-val" style="font-family:var(--ff-mono);font-size:13.5px;">${scan.lat}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label" data-i18n="detLon">Longitude</div>
        <div class="detail-val" style="font-family:var(--ff-mono);font-size:13.5px;">${scan.lon}</div>
      </div>
    </div>

    <div class="detail-grid" style="grid-template-columns:1fr 1fr; margin-top: 10px;">
      <a href="/report/${scan.id}" target="_blank" class="detail-btn">ğŸ“„ <span data-i18n="btnReport">Report</span></a>
      <button class="detail-btn detail-btn-outline" onclick="closeDetail()">â† <span data-i18n="btnBack">Back</span></button>
    </div>
  `;
  document.getElementById('detailPanel').classList.add('open');
  applyTranslations();
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
  document.getElementById('map').classList.remove('focus-mode');
  document.querySelectorAll('.hist-item').forEach(el => el.classList.remove('selected'));
  selectedId = null;
  map.flyTo([20.296, 85.824], 10, { duration: 1 });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH + FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getFiltered() {
  let list = scans;
  const q  = document.getElementById('searchInput').value.toLowerCase().trim();
  if (q)              list = list.filter(s => s.name.toLowerCase().includes(q));
  if (activeTag !== 'all') {
    if (activeTag === 'high') list = list.filter(s => s.score >= 80);
    else                      list = list.filter(s => s.type === activeTag);
  }
  return list;
}
function filterScans() {
  const list = getFiltered();
  renderList(list);
  renderMarkers(list);
  document.getElementById('scanCount').textContent = list.length + ' records';
}
function filterByTag(tag, el) {
  activeTag = tag;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  filterScans();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSLATION HYDRATION 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTranslations() {
  try {
    const savedT = sessionStorage.getItem('agri_T');
    if (savedT) {
      const T = JSON.parse(savedT);
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (key === 'navNewScan' && T.runAnalysis) el.innerText = "New Scan"; 
        if (key === 'tagDisease' && T.modeDisease) el.innerText = T.modeDisease;
        if (key === 'tagSoil' && T.modeSoil) el.innerText = T.modeSoil;
        if (key === 'tagYield' && T.modeYield) el.innerText = T.modeYield;
        if (key === 'detSev' && T.labelSeverity) el.innerText = T.labelSeverity;
        if (key === 'detTreat' && T.labelTreatment) el.innerText = T.labelTreatment;
        if (key === 'detEco' && T.ecoScore) el.innerText = T.ecoScore.replace(' ğŸŒ', '');
        if (key === 'btnBack' && T.back) el.innerText = T.back;
      });
    }
  } catch(e) {}
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”¥ NEW: REGIONAL DISEASE HEATMAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let heatLayer = null;
let heatmapActive = false;

function toggleHeatmap() {
  heatmapActive = !heatmapActive;
  const btn = document.getElementById('heatmapToggle');
  
  if (heatmapActive) {
    // 1. Style the button to look active (Red/Glowing)
    btn.style.background = 'rgba(224, 82, 82, 0.15)';
    btn.style.borderColor = 'var(--c-error)';
    btn.style.boxShadow = '0 0 20px rgba(224, 82, 82, 0.4)';
    
    // 2. Extract Data: Get only "disease" scans, use score for intensity
    const heatData = scans
      .filter(s => s.type === 'disease')
      .map(s => [s.lat, s.lon, (s.score / 100) * 1.5]); // Multiply by 1.5 for a stronger glow

    // 3. Create the glowing heat layer
    heatLayer = L.heatLayer(heatData, {
      radius: 45,       // Size of the glow
      blur: 30,         // Softness of the edges
      maxZoom: 12,      // Zoom level where intensity maxes out
      gradient: {
        0.4: '#c9a84c', // Gold for low severity
        0.6: '#f0a830', // Amber for medium
        1.0: '#e05252'  // Red for critical
      }
    }).addTo(map);

    // 4. Fade out the standard markers slightly so the heatmap pops
    Object.values(markerMap).forEach(m => m.setOpacity(0.2));
    
  } else {
    // Turn off Heatmap
    btn.style.background = '';
    btn.style.borderColor = '';
    btn.style.boxShadow = '';
    
    if (heatLayer) map.removeLayer(heatLayer);
    Object.values(markerMap).forEach(m => m.setOpacity(1)); // Bring markers back
  }
}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('totalScans').textContent = scans.length;
document.getElementById('critCount').textContent  = scans.filter(s => s.score >= 80).length;
renderList(scans);
renderMarkers(scans);
applyTranslations(); 
</script>
</body>
</html>