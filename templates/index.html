<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://fav.farm/ğŸŒ¾" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <meta name="theme-color" content="#0a1a0f" />
  <title>AgriUstaad â€” by Team AgriCore</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/static/icons/icon-192.png" type="image/png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
  <!-- jsPDF for client-side PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --c-bg:           #080f0b;
  --c-surface-md:   rgba(255,255,255,0.06);
  --c-surface-hi:   rgba(255,255,255,0.10);
  --c-border:       rgba(255,255,255,0.08);
  --c-border-hi:    rgba(255,255,255,0.16);
  --c-green-900:    #0a2e14;
  --c-green-700:    #1a5c2a;
  --c-green-500:    #2d8a44;
  --c-green-400:    #3dab55;
  --c-green-300:    #5ecb74;
  --c-green-100:    #b8f0c2;
  --c-gold:         #c9a84c;
  --c-gold-light:   #e8c96a;
  --c-amber:        #f0a830;
  --c-error:        #e05252;
  --c-error-bg:     rgba(224,82,82,0.08);
  --c-error-border: rgba(224,82,82,0.25);
  --c-text:         #e8f4eb;
  --c-text-2:       rgba(232,244,235,0.65);
  --c-text-3:       rgba(232,244,235,0.38);
  --glass-blur-lg:  40px;
  --r-md:   18px;
  --r-lg:   28px;
  --r-xl:   40px;
  --r-full: 9999px;
  --shadow-lg:   0 20px 60px rgba(0,0,0,0.60);
  --shadow-glow: 0 0 40px rgba(45,138,68,0.18);
  --ff-display: 'Cormorant Garamond', Georgia, serif;
  --ff-body:    'DM Sans', system-ui, sans-serif;
  --ff-mono:    'DM Mono', monospace;
  --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  background: var(--c-bg);
  color: var(--c-text);
  font-family: var(--ff-body);
  font-size: 15px;
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND MESH + GRAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(20,80,35,0.45) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 80%, rgba(10,50,25,0.40) 0%, transparent 55%),
    radial-gradient(ellipse 50% 70% at 60% 30%, rgba(45,138,68,0.10) 0%, transparent 50%),
    var(--c-bg);
  animation: meshDrift 18s ease-in-out infinite alternate;
}
@keyframes meshDrift { 0%{filter:hue-rotate(0deg);}100%{filter:hue-rotate(12deg);} }
body::after {
  content: ''; position: fixed; inset: 0; z-index: 1; pointer-events: none; opacity: 0.022;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  background-repeat: repeat; background-size: 128px;
}
.orb { position:fixed;border-radius:50%;filter:blur(80px);pointer-events:none;z-index:0;animation:orbFloat 20s ease-in-out infinite; }
.orb-1{width:420px;height:420px;background:radial-gradient(circle,rgba(45,138,68,0.22) 0%,transparent 70%);top:-120px;left:-120px;animation-delay:0s;}
.orb-2{width:320px;height:320px;background:radial-gradient(circle,rgba(201,168,76,0.12) 0%,transparent 70%);bottom:80px;right:-80px;animation-delay:-8s;}
.orb-3{width:250px;height:250px;background:radial-gradient(circle,rgba(30,100,50,0.18) 0%,transparent 70%);top:50%;left:60%;animation-delay:-14s;}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(30px,-40px) scale(1.05);}66%{transform:translate(-20px,25px) scale(0.96);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP WRAPPER â€” gets blurred behind language screen
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#appWrapper {
  filter: blur(18px) brightness(0.4) saturate(0.5);
  transform: scale(1.04);
  pointer-events: none;
  transition: filter 0.9s ease, transform 0.9s ease, opacity 0.6s ease;
  opacity: 0;
}
#appWrapper.revealed {
  filter: none;
  transform: scale(1);
  pointer-events: auto;
  opacity: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLASH OVERLAY â€” cinematic reveal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#flashOverlay {
  position: fixed; inset: 0; z-index: 9999;
  background: radial-gradient(ellipse at center, rgba(94,203,116,0.9) 0%, rgba(45,138,68,0.95) 40%, rgba(8,15,11,1) 100%);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}
#flashOverlay.flash-in  { opacity: 1;  pointer-events: all; }
#flashOverlay.flash-out {
  opacity: 0;
  transition: opacity 1.2s cubic-bezier(0.4,0,0.2,1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE SELECTOR OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#langOverlay {
  position: fixed; inset: 0; z-index: 99999;
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  transition: opacity 0.5s ease, transform 0.5s ease;
}
#langOverlay.hiding {
  opacity: 0;
  transform: scale(0.96);
  pointer-events: none;
}

.lang-card {
  width: 100%; max-width: 520px;
  background: rgba(10,18,12,0.82);
  backdrop-filter: blur(40px) saturate(180%);
  -webkit-backdrop-filter: blur(40px) saturate(180%);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 40px;
  padding: 44px 36px 36px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.7), 0 0 60px rgba(45,138,68,0.12), inset 0 1px 0 rgba(255,255,255,0.08);
  position: relative;
  overflow: hidden;
  animation: cardEntrance 0.7s cubic-bezier(0.34,1.3,0.64,1) both;
}
@keyframes cardEntrance {
  from { opacity:0; transform:translateY(40px) scale(0.94); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}
.lang-card::before {
  content: '';
  position: absolute; top: 0; left: 10%; right: 10%; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(94,203,116,0.4) 50%, transparent);
}

/* Decorative ring behind card */
.lang-card-glow {
  position: absolute; inset: -60px;
  background: radial-gradient(ellipse at center, rgba(45,138,68,0.08) 0%, transparent 70%);
  pointer-events: none; z-index: -1;
  animation: glowPulse 4s ease-in-out infinite alternate;
}
@keyframes glowPulse { 0%{opacity:0.6;}100%{opacity:1;} }

.lang-brand {
  display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
}
.lang-logo {
  display: grid; place-items: center;
  width: 46px; height: 46px;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  border-radius: 14px; font-size: 22px;
  box-shadow: 0 6px 18px rgba(45,138,68,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
}
.lang-brand-name {
  font-family: var(--ff-display);
  font-size: 28px; font-weight: 600;
  color: var(--c-text); letter-spacing: 0.01em;
}

.lang-tagline {
  font-size: 13px; color: var(--c-text-3);
  margin-bottom: 32px; letter-spacing: 0.01em;
  font-style: italic; font-family: var(--ff-display);
}

.lang-heading {
  font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em;
  color: var(--c-green-400); font-weight: 600; margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
}
.lang-heading::before, .lang-heading::after {
  content: ''; flex: 1; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(45,138,68,0.35));
}
.lang-heading::after { transform: scaleX(-1); }

/* Language grid */
.lang-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 28px;
}

.lang-btn {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  padding: 18px 10px 14px;
  background: rgba(255,255,255,0.04);
  border: 1.5px solid rgba(255,255,255,0.07);
  border-radius: 20px; cursor: pointer;
  transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
  position: relative; overflow: hidden;
  font-family: var(--ff-body);
}
.lang-btn::after {
  content: '';
  position: absolute; inset: 0; border-radius: inherit;
  background: linear-gradient(135deg, rgba(45,138,68,0.15) 0%, transparent 60%);
  opacity: 0; transition: opacity 0.25s ease;
}
.lang-btn:hover {
  border-color: rgba(45,138,68,0.5);
  background: rgba(45,138,68,0.06);
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(45,138,68,0.15);
}
.lang-btn:hover::after { opacity: 1; }
.lang-btn.selected {
  border-color: var(--c-green-400);
  background: rgba(45,138,68,0.14);
  box-shadow: 0 0 0 3px rgba(45,138,68,0.18), 0 8px 24px rgba(45,138,68,0.2);
  transform: translateY(-3px);
}
.lang-btn.selected::after { opacity: 1; }
.lang-btn.selected .lang-check { opacity: 1; transform: scale(1); }

.lang-native {
  font-size: 22px; font-weight: 600; color: var(--c-text);
  line-height: 1; letter-spacing: -0.01em; position: relative; z-index: 1;
}
.lang-english {
  font-size: 10.5px; color: var(--c-text-3); font-weight: 400;
  letter-spacing: 0.04em; text-transform: uppercase; position: relative; z-index: 1;
}
.lang-check {
  position: absolute; top: 8px; right: 10px;
  width: 18px; height: 18px; border-radius: 50%;
  background: var(--c-green-500);
  display: grid; place-items: center;
  font-size: 10px; color: white;
  opacity: 0; transform: scale(0.5);
  transition: opacity 0.2s ease, transform 0.25s cubic-bezier(0.34,1.56,0.64,1);
}

/* API key input */
.api-key-wrap {
  margin-bottom: 20px;
}
.api-key-label {
  font-size: 10.5px; color: var(--c-text-3); letter-spacing: 0.06em;
  text-transform: uppercase; margin-bottom: 7px; display: flex; align-items: center; gap: 6px;
}
.api-key-label .tip {
  font-size: 10px; color: var(--c-green-500); text-transform: none; letter-spacing: 0;
}
.api-key-input {
  width: 100%; padding: 11px 14px;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--c-border);
  border-radius: 14px; color: var(--c-text);
  font-size: 13px; font-family: var(--ff-mono);
  outline: none; transition: var(--transition);
  letter-spacing: 0.04em;
}
.api-key-input::placeholder { color: var(--c-text-3); letter-spacing: 0; font-family: var(--ff-body); }
.api-key-input:focus { border-color: var(--c-green-500); background: rgba(255,255,255,0.06); box-shadow: 0 0 0 3px rgba(45,138,68,0.12); }

/* Enter button */
.lang-enter-btn {
  width: 100%; padding: 17px;
  border: none; border-radius: 20px;
  cursor: pointer; font-family: var(--ff-body);
  font-size: 15px; font-weight: 600;
  letter-spacing: 0.05em; text-transform: uppercase; color: #fff;
  background: linear-gradient(135deg, var(--c-green-500) 0%, var(--c-green-700) 100%);
  box-shadow: 0 8px 28px rgba(45,138,68,0.38), inset 0 1px 0 rgba(255,255,255,0.2);
  transition: var(--transition); position: relative; overflow: hidden;
}
.lang-enter-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.14) 0%, transparent 60%);
}
.lang-enter-btn:hover { transform: translateY(-2px); box-shadow: 0 14px 36px rgba(45,138,68,0.48); }
.lang-enter-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

/* Loading state inside button */
.btn-spinner {
  display: inline-block;
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle; margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Status text under button */
.lang-status {
  text-align: center; margin-top: 14px;
  font-size: 12.5px; color: var(--c-text-3);
  font-family: var(--ff-mono); letter-spacing: 0.04em;
  min-height: 18px;
  transition: color 0.3s ease;
}
.lang-status.active { color: var(--c-green-400); }
.lang-status.error  { color: #f08080; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE CHANGE BANNER (top of app)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* lang-bar hidden â€” language button is now in the nav */
.lang-bar { display: none !important; }
.lang-bar-label { display: none; }
.lang-bar-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 7px 14px; border-radius: var(--r-full);
  border: 1px solid rgba(45,138,68,0.3);
  background: rgba(45,138,68,0.1);
  color: var(--c-green-300); font-size: 13px; font-weight: 500;
  cursor: pointer; font-family: var(--ff-body);
  transition: var(--transition); letter-spacing: 0.01em;
}
.lang-bar-btn:hover { background: rgba(45,138,68,0.2); color: var(--c-green-100); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RADAR TOAST POPUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.radar-banner {
  position: fixed;
  top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px);
  z-index: 4000;
  display: flex; align-items: center; gap: 10px;
  padding: 12px 20px;
  background: linear-gradient(135deg, rgba(10,18,12,0.96) 0%, rgba(15,26,16,0.96) 100%);
  border: 1px solid rgba(201,168,76,0.35);
  border-radius: var(--r-full);
  box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 24px rgba(201,168,76,0.12), inset 0 1px 0 rgba(255,255,255,0.06);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  font-size: 12.5px; color: var(--c-gold-light);
  font-family: var(--ff-mono); letter-spacing: 0.01em;
  white-space: nowrap;
  opacity: 0; pointer-events: none;
  transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.34,1.3,0.64,1);
  max-width: calc(100vw - 40px);
}
.radar-banner.radar-show {
  opacity: 1; pointer-events: auto;
  transform: translateX(-50%) translateY(0);
}
.radar-banner.radar-hide {
  opacity: 0;
  transform: translateX(-50%) translateY(-12px);
  transition: opacity 0.6s ease, transform 0.6s ease;
}
.radar-banner b { color: var(--c-gold); font-weight: 500; }
.radar-pulse { position:relative;width:8px;height:8px;flex-shrink:0; }
.radar-pulse::before,.radar-pulse::after{content:'';position:absolute;inset:0;border-radius:50%;background:var(--c-amber);}
.radar-pulse::before{animation:pulseRing 2s ease-out infinite;}
.radar-pulse::after{transform:scale(0.65);}
@keyframes pulseRing{0%{transform:scale(1);opacity:0.8;}100%{transform:scale(3);opacity:0;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIVE MANDI PRICE TICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mandi-ticker {
  background: rgba(10, 18, 12, 0.95);
  border-bottom: 1px solid var(--c-border);
  padding: 8px 0;
  overflow: hidden;
  position: relative;
  z-index: 85; /* Sits smoothly below the navigation */
  display: flex;
  align-items: center;
}
/* Fade the left and right edges for a premium cinematic look */
.mandi-ticker::before, .mandi-ticker::after {
  content: ''; position: absolute; top: 0; bottom: 0; width: 40px; z-index: 2; pointer-events: none;
}
.mandi-ticker::before { left: 0; background: linear-gradient(to right, rgba(8,15,11,1), transparent); }
.mandi-ticker::after { right: 0; background: linear-gradient(to left, rgba(8,15,11,1), transparent); }

.ticker-track {
  display: flex;
  gap: 50px;
  white-space: nowrap;
  animation: scrollTicker 25s linear infinite;
  padding-left: 20px;
}
.ticker-track:hover {
  animation-play-state: paused; /* Pauses when judges point at it */
}
.ticker-item {
  font-family: var(--ff-mono);
  font-size: 12.5px;
  font-weight: 500;
  color: var(--c-text-2);
  letter-spacing: 0.05em;
}
@keyframes scrollTicker {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); } 
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.glass-nav {
  position: sticky; top: 0; z-index: 90;
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px;
  background: rgba(8,15,11,0.72);
  backdrop-filter: blur(24px) saturate(200%);
  -webkit-backdrop-filter: blur(24px) saturate(200%);
  border-bottom: 1px solid var(--c-border);
}
.nav-brand { display:flex;align-items:center;gap:10px;text-decoration:none;font-family:var(--ff-display);font-size:22px;font-weight:600;color:var(--c-text);letter-spacing:0.01em; }
.logo-icon { display:grid;place-items:center;width:34px;height:34px;background:linear-gradient(135deg,var(--c-green-700) 0%,var(--c-green-500) 100%);border-radius:10px;font-size:16px;box-shadow:0 4px 12px rgba(45,138,68,0.3),inset 0 1px 0 rgba(255,255,255,0.15); }
.nav-right { display:flex;align-items:center;gap:10px; }
.nav-link { display:flex;align-items:center;gap:6px;padding:7px 16px;border-radius:var(--r-full);text-decoration:none;font-size:13.5px;font-weight:500;color:var(--c-text-2);background:var(--c-surface-md);border:1px solid var(--c-border);transition:var(--transition);letter-spacing:0.01em; }
.nav-link:hover { color:var(--c-text);background:var(--c-surface-hi);border-color:var(--c-border-hi); }
.btn-back { display:none;align-items:center;gap:6px;padding:7px 14px;border-radius:var(--r-full);font-size:13px;font-weight:500;color:var(--c-text-2);background:var(--c-surface-md);border:1px solid var(--c-border);cursor:pointer;font-family:var(--ff-body);transition:var(--transition);letter-spacing:0.01em; }
.btn-back:hover { color:var(--c-text);background:var(--c-surface-hi);border-color:var(--c-border-hi); }
.btn-back.visible { display:flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
main { position:relative;z-index:10;max-width:1100px;margin:0 auto;padding:28px 16px 100px; }

/* Two-col inside microPanel (replaces old main.two-col) */
@media(min-width:760px) {
  #microPanel.two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
  }
}
@media(max-width:759px){main{padding:18px 12px 90px;}.card{padding:22px 18px;border-radius:28px;}.card-header h2{font-size:26px;}.chatbot-container{width:calc(100vw - 32px);right:16px;}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNIFIED COMMAND DECK â€” the morphing card
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#commandDeck {
  position: relative;
  background: rgba(255,255,255,0.035);
  backdrop-filter: blur(var(--glass-blur-lg)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--glass-blur-lg)) saturate(180%);
  border: 1px solid var(--c-border);
  border-radius: var(--r-xl);
  box-shadow: var(--shadow-lg), var(--shadow-glow), inset 0 1px 0 rgba(255,255,255,0.06);
  overflow: hidden;
  width: 100%;
  margin: 0 auto;
  transition: border-color 0.4s ease, box-shadow 0.5s ease;
  animation: slideUp 0.55s cubic-bezier(0.34,1.56,0.64,1) both;
}
#commandDeck::before {
  content:'';
  position:absolute;top:0;left:10%;right:10%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12) 30%,rgba(94,203,116,0.25) 50%,rgba(255,255,255,0.12) 70%,transparent);
  pointer-events:none; z-index:2;
}
#commandDeck.wide-mode {
  border-color: rgba(45,138,68,0.25);
  box-shadow: var(--shadow-lg), 0 0 60px rgba(45,138,68,0.14), inset 0 1px 0 rgba(255,255,255,0.08);
}

/* â”€â”€ Deck Toggle Header â”€â”€ */
#deckHeader {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 16px 24px 14px;
  border-bottom: 1px solid var(--c-border);
  background: rgba(0,0,0,0.12);
  flex-wrap: wrap;
  position: relative; z-index: 3;
}
.deck-titles {
  display: flex; flex-direction: column; gap: 2px;
}
.deck-title-main {
  font-family: var(--ff-display);
  font-size: 18px; font-weight: 600;
  color: var(--c-text); line-height: 1.1;
  transition: opacity 0.25s ease;
}
.deck-title-sub {
  font-size: 11.5px; color: var(--c-text-3);
  letter-spacing: 0.02em;
  transition: opacity 0.25s ease;
}

/* â”€â”€ Toggle Tab Switch â”€â”€ */
.deck-toggle-pill {
  display: flex;
  align-items: center;
  background: rgba(0,0,0,0.18);
  border: 1px solid var(--c-border);
  border-radius: var(--r-full);
  padding: 5px;
  gap: 2px;
  flex-shrink: 0;
  position: relative;
}
.deck-toggle-track {
  position: absolute;
  top: 5px; bottom: 5px;
  border-radius: var(--r-full);
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  box-shadow: 0 2px 12px rgba(45,138,68,0.45);
  transition: left 0.38s cubic-bezier(0.34,1.2,0.64,1), width 0.38s cubic-bezier(0.34,1.2,0.64,1);
  z-index: 0;
  pointer-events: none;
}
.deck-toggle-btn {
  position: relative; z-index: 1;
  display: flex; align-items: center; gap: 6px;
  padding: 9px 20px;
  border-radius: var(--r-full);
  border: none; background: transparent;
  font-family: var(--ff-body);
  font-size: 13px; font-weight: 600;
  letter-spacing: 0.02em;
  cursor: pointer;
  transition: color 0.25s ease;
  color: var(--c-text-3);
  white-space: nowrap;
}
.deck-toggle-btn .btn-emoji { font-size: 15px; }
.deck-toggle-btn.active { color: #fff; }

/* â”€â”€ Live status indicator â”€â”€ */
.deck-live-badge {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 11px;
  background: rgba(224,82,82,0.1);
  border: 1px solid rgba(224,82,82,0.25);
  border-radius: var(--r-full);
  font-size: 11px; color: #f08080; font-weight: 600;
  letter-spacing: 0.04em; text-transform: uppercase;
  flex-shrink: 0;
}
.deck-live-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: #e05252;
  box-shadow: 0 0 6px #e05252;
  animation: blink 1s infinite;
}
.deck-diag-badge {
  display: none;
  align-items: center; gap: 6px;
  padding: 5px 11px;
  background: rgba(45,138,68,0.12);
  border: 1px solid rgba(45,138,68,0.3);
  border-radius: var(--r-full);
  font-size: 11px; color: var(--c-green-300); font-weight: 600;
  letter-spacing: 0.03em; white-space: nowrap;
}
.deck-diag-badge.visible { display: flex; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MICRO & MACRO VIEW PANELS â€” glitch-free
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Shared panel wrapper so both panels stack in the same flow space */
#panelContainer {
  position: relative;
  /* Ensures container never collapses during panel swap */
  min-height: 500px;
}

#microPanel {
  padding: 22px 24px 24px;
  opacity: 1;
  transform: translateX(0);
  transition: opacity 0.25s ease, transform 0.28s cubic-bezier(0.4,0,0.2,1);
  will-change: opacity, transform;
}
#microPanel.panel-hidden {
  opacity: 0;
  transform: translateX(-18px);
  pointer-events: none;
  position: absolute;
  top: 0; left: 0; right: 0;
  visibility: hidden;
}

/* scanCard inside commandDeck loses its own card shell */
#scanCard {
  background: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  border: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  padding: 0 !important;
  overflow: visible !important;
  animation: none !important;
}
#scanCard::before { display:none !important; }
/* resultCard inside commandDeck */
#resultCard {
  background: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  border: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  padding: 0 !important;
  overflow: visible !important;
}
#resultCard::before { display:none !important; }

/* Divider between scan and result in two-col */
#microPanel.two-col #scanCard { border-right: 1px solid var(--c-border) !important; padding-right: 24px !important; }

/* â”€â”€ Macro Panel â”€â”€ */
#macroPanel {
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateX(18px);
  transition: opacity 0.25s ease, transform 0.28s cubic-bezier(0.4,0,0.2,1);
  min-height: 580px;
  pointer-events: none;
  position: absolute;
  top: 0; left: 0; right: 0;
  visibility: hidden;
  will-change: opacity, transform;
}
#macroPanel.panel-visible {
  opacity: 1;
  transform: translateX(0);
  pointer-events: auto;
  position: relative;
  top: auto; left: auto; right: auto;
  visibility: visible;
}

/* â”€â”€ Map Container â”€â”€ */
#communityMap {
  width: 100%;
  height: 460px;
  border-radius: 0;
  z-index: 1;
  position: relative;
}
@media(max-width:759px) { #communityMap { height: 340px; } }

/* Leaflet custom overrides for dark theme */
.leaflet-container {
  background: #0a1a0f !important;
  font-family: var(--ff-body) !important;
}
.leaflet-tile-pane { filter: brightness(0.72) saturate(0.6) hue-rotate(90deg); }
.leaflet-control-zoom a {
  background: rgba(10,20,13,0.92) !important;
  color: var(--c-text) !important;
  border-color: var(--c-border) !important;
}
.leaflet-popup-content-wrapper {
  background: rgba(10,20,13,0.96) !important;
  border: 1px solid var(--c-border-hi) !important;
  border-radius: 14px !important;
  box-shadow: 0 8px 28px rgba(0,0,0,0.6) !important;
  color: var(--c-text) !important;
  backdrop-filter: blur(20px);
}
.leaflet-popup-tip { background: rgba(10,20,13,0.96) !important; }
.leaflet-popup-content { margin: 14px 18px !important; font-size: 13px !important; line-height: 1.6 !important; }
.leaflet-attribution-flag { display:none !important; }
.leaflet-control-attribution {
  background: rgba(5,10,7,0.8) !important;
  color: var(--c-text-3) !important;
  font-size: 10px !important;
  backdrop-filter: blur(10px);
}

/* â”€â”€ AI Logic Box (overlays bottom of map) â”€â”€ */
#aiLogicBox {
  padding: 18px 24px 22px;
  border-top: 1px solid var(--c-border);
  background: rgba(0,0,0,0.18);
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 18px;
  align-items: start;
}
@media(max-width:759px) {
  #aiLogicBox { grid-template-columns: 1fr; padding: 16px 18px 20px; }
}
.logic-left {}
.logic-header {
  display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
}
.logic-orb {
  width: 28px; height: 28px; border-radius: 50%;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  display: grid; place-items: center; font-size: 13px;
  box-shadow: 0 3px 10px rgba(45,138,68,0.4); flex-shrink: 0;
}
.logic-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--c-green-400); font-weight: 700;
}
.logic-text {
  font-size: 13.5px; color: var(--c-text-2); line-height: 1.65;
  margin-bottom: 12px;
}
.logic-alerts { display: flex; flex-direction: column; gap: 7px; }
.logic-alert-row {
  display: flex; align-items: flex-start; gap: 9px;
  padding: 9px 12px;
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--c-border);
  border-radius: 12px;
  font-size: 12.5px; color: var(--c-text-2); line-height: 1.4;
  transition: var(--transition);
}
.logic-alert-row:hover { background: rgba(45,138,68,0.05); border-color: rgba(45,138,68,0.2); }
.logic-alert-row .alert-ico { font-size: 15px; flex-shrink: 0; padding-top: 1px; }
.logic-alert-row .alert-txt b { color: var(--c-text); font-weight: 600; }

/* Stats column */
.logic-stats { display: flex; flex-direction: column; gap: 8px; min-width: 148px; }
@media(max-width:759px) { .logic-stats { flex-direction: row; flex-wrap: wrap; min-width: unset; } }
.logic-stat-box {
  padding: 10px 14px;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--c-border);
  border-radius: 12px; text-align: center;
  transition: var(--transition);
}
.logic-stat-box:hover { border-color: rgba(45,138,68,0.3); }
.logic-stat-val {
  font-family: var(--ff-mono); font-size: 20px; font-weight: 600;
  color: var(--c-green-300); line-height: 1; margin-bottom: 3px;
}
.logic-stat-val.amber { color: var(--c-gold-light); }
.logic-stat-val.red   { color: #f08080; }
.logic-stat-lbl { font-size: 10px; color: var(--c-text-3); text-transform: uppercase; letter-spacing: 0.05em; }

/* â”€â”€ Map overlay markers â”€â”€ */
.map-cluster-icon {
  background: rgba(224,82,82,0.85);
  border: 2px solid rgba(255,100,100,0.6);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: white;
  box-shadow: 0 0 12px rgba(224,82,82,0.5);
  backdrop-filter: blur(4px);
}
.map-pin-popup { font-size: 13px; }
.map-pin-popup .pp-disease { font-weight: 600; color: var(--c-green-300); font-size: 14px; }
.map-pin-popup .pp-meta { color: var(--c-text-3); font-size: 11.5px; margin-top: 4px; }
.map-pin-popup .pp-severity { margin-top: 8px; font-size: 11.5px; color: var(--c-gold-light); }

/* â”€â”€ Scan-linked callout (appears when diagnosis exists) â”€â”€ */
#diagMatchBanner {
  display: none;
  align-items: center; gap: 12px;
  padding: 11px 18px;
  background: linear-gradient(135deg, rgba(45,138,68,0.12), rgba(20,60,30,0.2));
  border-top: 1px solid rgba(45,138,68,0.2);
  border-bottom: 1px solid rgba(45,138,68,0.2);
  font-size: 12.5px; color: var(--c-green-300); line-height: 1.4;
}
#diagMatchBanner.visible { display: flex; }
#diagMatchBanner .dmb-pulse {
  width: 8px; height: 8px; border-radius: 50%; background: var(--c-green-400);
  box-shadow: 0 0 8px var(--c-green-400); flex-shrink: 0;
  animation: blink 1.2s infinite;
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card { position:relative;background:rgba(255,255,255,0.035);backdrop-filter:blur(var(--glass-blur-lg)) saturate(180%);-webkit-backdrop-filter:blur(var(--glass-blur-lg)) saturate(180%);border:1px solid var(--c-border);border-radius:var(--r-xl);padding:28px 24px;box-shadow:var(--shadow-lg),var(--shadow-glow),inset 0 1px 0 rgba(255,255,255,0.06);overflow:hidden; }
.card::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12) 30%,rgba(94,203,116,0.25) 50%,rgba(255,255,255,0.12) 70%,transparent);}
.slide-up{animation:slideUp 0.55s cubic-bezier(0.34,1.56,0.64,1) both;}
@keyframes slideUp{from{opacity:0;transform:translateY(32px) scale(0.97);}to{opacity:1;transform:translateY(0) scale(1);}}
.result-enter{animation:resultReveal 0.6s cubic-bezier(0.34,1.4,0.64,1) both;}
@keyframes resultReveal{from{opacity:0;transform:translateY(20px) scale(0.96);}to{opacity:1;transform:translateY(0) scale(1);}}

.card-header{margin-bottom:22px;}
.card-header h2{font-family:var(--ff-display);font-size:30px;font-weight:600;letter-spacing:-0.01em;color:var(--c-text);line-height:1.1;}
.card-header p{margin-top:4px;font-size:13.5px;color:var(--c-text-3);font-weight:400;letter-spacing:0.01em;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODE GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO SCANNER HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scanner-hero-header {
  display: flex; align-items: center; gap: 16px;
  margin-bottom: 20px;
}
.scanner-hero-icon-wrap {
  position: relative; flex-shrink: 0;
  width: 56px; height: 56px;
}
.scanner-hero-icon {
  width: 56px; height: 56px;
  display: grid; place-items: center;
  font-size: 26px;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  border-radius: 18px;
  box-shadow: 0 6px 20px rgba(45,138,68,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
  position: relative; z-index: 1;
  transition: all 0.5s cubic-bezier(0.34,1.3,0.64,1);
}
.scanner-hero-icon.mode-disease { background: linear-gradient(135deg,#1a5c2a,#2d8a44); }
.scanner-hero-icon.mode-yield   { background: linear-gradient(135deg,#5c3a1a,#8a6a2d); box-shadow: 0 6px 20px rgba(138,106,45,0.4); }
.scanner-hero-icon.mode-soil    { background: linear-gradient(135deg,#3a2a1a,#6b4c2a); box-shadow: 0 6px 20px rgba(107,76,42,0.4); }
.scanner-hero-icon.mode-crate   { background: linear-gradient(135deg,#1a2e5c,#2d558a); box-shadow: 0 6px 20px rgba(45,85,138,0.4); }
.scanner-pulse-ring {
  position: absolute; inset: -4px; border-radius: 22px;
  border: 1.5px solid rgba(45,138,68,0.4);
  animation: pulseRingScanner 2.5s ease-out infinite;
}
@keyframes pulseRingScanner {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(1.35); opacity: 0; }
}
.scanner-hero-title {
  font-family: var(--ff-display); font-size: 26px; font-weight: 600;
  letter-spacing: -0.01em; color: var(--c-text); line-height: 1.1;
}
.scanner-hero-sub {
  margin-top: 4px; font-size: 12.5px; color: var(--c-text-3);
  letter-spacing: 0.01em; transition: all 0.4s ease;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI CLASSIFY BADGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ai-classify-badge {
  border-radius: var(--r-md);
  border: 1px solid rgba(45,138,68,0.3);
  background: rgba(45,138,68,0.06);
  padding: 12px 16px;
  margin-bottom: 16px;
  min-height: 52px;
  display: flex; align-items: center; gap: 12px;
  transition: all 0.4s ease;
  animation: slideUp 0.4s ease both;
}
.ai-classify-badge.mode-yield  { border-color: rgba(138,106,45,0.4); background: rgba(138,106,45,0.08); }
.ai-classify-badge.mode-soil   { border-color: rgba(107,76,42,0.4);  background: rgba(107,76,42,0.08); }
.ai-classify-badge.mode-crate  { border-color: rgba(45,85,138,0.4);  background: rgba(45,85,138,0.08); }
.acb-spinner {
  width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0;
  border: 2px solid rgba(45,138,68,0.3); border-top-color: var(--c-green-400);
  animation: spin 0.9s linear infinite;
}
.acb-content { display: flex; align-items: center; gap: 12px; width: 100%; }
.acb-icon { font-size: 24px; line-height: 1; flex-shrink: 0; filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3)); }
.acb-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
.acb-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--c-green-400); font-weight: 700; }
.acb-category { font-size: 14px; font-weight: 600; color: var(--c-text); }
.acb-confidence { display: flex; flex-direction: column; align-items: flex-end; gap: 1px; }
.acb-conf-val { font-family: var(--ff-mono); font-size: 18px; font-weight: 600; color: var(--c-green-300); line-height: 1; }
.acb-conf-lbl { font-size: 10px; color: var(--c-text-3); text-transform: uppercase; letter-spacing: 0.05em; }
.acb-change-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--c-border);
  border-radius: 8px; color: var(--c-text-3); cursor: pointer; font-size: 14px;
  padding: 6px 8px; transition: var(--transition); flex-shrink: 0;
}
.acb-change-btn:hover { background: rgba(255,255,255,0.1); color: var(--c-text); }
.acb-thinking { display: flex; align-items: center; gap: 10px; font-size: 12.5px; color: var(--c-text-3); }
.acb-think-dots { display: flex; gap: 4px; }
.acb-think-dots span {
  width: 6px; height: 6px; border-radius: 50%; background: var(--c-green-500);
  animation: thinkBounce 1.2s ease-in-out infinite;
}
.acb-think-dots span:nth-child(2) { animation-delay: 0.2s; }
.acb-think-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes thinkBounce { 0%,80%,100%{transform:translateY(0);} 40%{transform:translateY(-6px);} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANUAL OVERRIDE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.manual-override {
  background: rgba(255,255,255,0.03);
  border: 1px dashed var(--c-border);
  border-radius: var(--r-md); padding: 14px;
  margin-bottom: 14px; animation: slideUp 0.3s ease both;
}
.mo-label {
  font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--c-text-3); margin-bottom: 10px; font-weight: 600;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO UPLOAD ZONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero-upload-zone { min-height: 260px !important; position: relative !important; }
.hero-upload-bg-rings {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  pointer-events: none; overflow: hidden;
}
.hero-upload-bg-rings .ring-1, .hero-upload-bg-rings .ring-2, .hero-upload-bg-rings .ring-3 {
  position: absolute; border-radius: 50%; border: 1px solid rgba(45,138,68,0.12);
  animation: heroRingBreath 4s ease-in-out infinite;
}
.hero-upload-bg-rings .ring-1 { width: 180px; height: 180px; animation-delay: 0s; }
.hero-upload-bg-rings .ring-2 { width: 280px; height: 280px; animation-delay: 0.7s; }
.hero-upload-bg-rings .ring-3 { width: 380px; height: 380px; animation-delay: 1.4s; }
@keyframes heroRingBreath { 0%,100%{opacity:0.6;} 50%{opacity:1;} }
.hero-cam-icon { font-size: 52px !important; }
#uploadContent h3 { font-size: 20px !important; }
.preview-overlay {
  position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
  z-index: 5;
}
.po-ai-badge {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 16px; border-radius: var(--r-full);
  background: rgba(8,15,11,0.88); border: 1px solid rgba(45,138,68,0.4);
  backdrop-filter: blur(12px); color: var(--c-green-300);
  font-size: 13px; font-weight: 500; white-space: nowrap;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
}
.po-spinner {
  width: 14px; height: 14px; border-radius: 50%;
  border: 2px solid rgba(45,138,68,0.3); border-top-color: var(--c-green-400);
  animation: spin 0.8s linear infinite; flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPACT VOICE BTN IN ACTION ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-voice-compact {
  display: grid !important; place-items: center !important;
  width: auto !important; min-width: 48px !important;
  padding: 10px 14px !important; margin-bottom: 0 !important;
  font-size: 16px !important;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO ANALYZE BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-analyze-hero {
  font-size: 16px !important; padding: 18px !important;
  border-radius: 20px !important;
  box-shadow: 0 8px 32px rgba(45,138,68,0.4), inset 0 1px 0 rgba(255,255,255,0.2) !important;
  letter-spacing: 0.03em !important;
  transition: all 0.4s cubic-bezier(0.34,1.3,0.64,1) !important;
}
.btn-analyze-hero:not(:disabled):hover { transform: translateY(-3px) !important; box-shadow: 0 14px 40px rgba(45,138,68,0.5) !important; }
.btn-analyze-hero:disabled { opacity: 0.45 !important; cursor: not-allowed !important; transform: none !important; }
.btn-analyze-icon { font-size: 18px; }
.btn-analyze-hero.ready { animation: readyPulse 2s ease-in-out infinite; }
@keyframes readyPulse { 0%,100%{box-shadow:0 8px 32px rgba(45,138,68,0.4);} 50%{box-shadow:0 8px 40px rgba(45,138,68,0.65);} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DYNAMIC DASHBOARD MORPH PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-morph-header {
  display: flex; align-items: center; gap: 14px; margin-bottom: 20px;
  padding: 16px 0 16px; border-bottom: 1px solid var(--c-border);
}
.rmh-icon {
  width: 48px; height: 48px; border-radius: 16px; display: grid; place-items: center;
  font-size: 22px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  box-shadow: 0 6px 18px rgba(45,138,68,0.4);
  transition: all 0.5s cubic-bezier(0.34,1.3,0.64,1);
}
.rmh-icon.mode-disease { background: linear-gradient(135deg,#1a5c2a,#2d8a44); }
.rmh-icon.mode-yield   { background: linear-gradient(135deg,#5c3a1a,#8a6a2d); box-shadow: 0 6px 18px rgba(138,106,45,0.4); }
.rmh-icon.mode-soil    { background: linear-gradient(135deg,#3a2a1a,#6b4c2a); box-shadow: 0 6px 18px rgba(107,76,42,0.4); }
.rmh-icon.mode-crate   { background: linear-gradient(135deg,#1a2e5c,#2d558a); box-shadow: 0 6px 18px rgba(45,85,138,0.4); }
.rmh-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; margin-bottom: 2px; }
.mode-disease .rmh-label, .rmh-label.mode-disease { color: var(--c-green-400); }
.mode-yield   .rmh-label, .rmh-label.mode-yield   { color: var(--c-gold-light); }
.mode-soil    .rmh-label, .rmh-label.mode-soil    { color: #c9813a; }
.mode-crate   .rmh-label, .rmh-label.mode-crate   { color: #6ea6e0; }

/* Auto-detected pill in result header */
.auto-detect-pill {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px; border-radius: var(--r-full);
  background: rgba(45,138,68,0.12); border: 1px solid rgba(45,138,68,0.3);
  font-size: 10px; font-weight: 600; letter-spacing: 0.05em;
  text-transform: uppercase; color: var(--c-green-300);
  margin-top: 4px; display: inline-flex;
}
.auto-detect-pill::before { content:''; width:5px;height:5px;border-radius:50%;background:var(--c-green-400);box-shadow:0 0 6px var(--c-green-400);animation:blink 2s infinite; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   (keep existing mode-grid for manual override only)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mode-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:0;}
.mode-btn{display:flex;flex-direction:column;align-items:center;gap:7px;padding:14px 8px;background:var(--c-surface-md);border:1px solid var(--c-border);border-radius:var(--r-md);cursor:pointer;color:var(--c-text-2);transition:var(--transition);font-family:var(--ff-body);position:relative;overflow:visible;}
.mode-btn[data-tip]:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:rgba(10,20,13,0.96);border:1px solid var(--c-border-hi);color:var(--c-text-2);font-size:11px;white-space:nowrap;padding:5px 10px;border-radius:8px;pointer-events:none;z-index:50;backdrop-filter:blur(12px);box-shadow:0 4px 16px rgba(0,0,0,0.4);}
.mode-btn[data-tip]:hover::before{content:'';position:absolute;bottom:calc(100% + 3px);left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--c-border-hi);pointer-events:none;z-index:51;}
.mode-btn .bg-layer{position:absolute;inset:0;border-radius:inherit;background:linear-gradient(135deg,rgba(45,138,68,0.15) 0%,transparent 60%);opacity:0;transition:opacity var(--transition);}
.mode-btn:hover{border-color:var(--c-green-500);color:var(--c-text);box-shadow:0 4px 20px rgba(45,138,68,0.2);transform:translateY(-2px);}
.mode-btn:hover .bg-layer{opacity:1;}
.mode-btn.active{background:rgba(45,138,68,0.15);border-color:var(--c-green-400);color:var(--c-green-300);box-shadow:0 4px 20px rgba(45,138,68,0.25),inset 0 1px 0 rgba(94,203,116,0.2);}
.mode-btn.active .bg-layer{opacity:1;}
.mode-btn .emoji{font-size:22px;line-height:1;position:relative;z-index:1;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.4));}
.mode-btn .label{font-size:11px;font-weight:500;letter-spacing:0.06em;text-transform:uppercase;position:relative;z-index:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VOICE BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-voice{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px 18px;margin-bottom:16px;background:rgba(201,168,76,0.07);border:1px solid rgba(201,168,76,0.2);border-radius:var(--r-md);color:var(--c-gold-light);font-size:13.5px;font-weight:500;font-family:var(--ff-body);cursor:pointer;letter-spacing:0.02em;transition:var(--transition);}
.btn-voice .icon{font-size:16px;}
.btn-voice:hover{background:rgba(201,168,76,0.13);border-color:rgba(201,168,76,0.4);box-shadow:0 4px 20px rgba(201,168,76,0.12);transform:translateY(-1px);}
.btn-voice.listening{background:rgba(201,168,76,0.18);border-color:var(--c-gold);animation:voicePulse 1.2s ease-in-out infinite;}
@keyframes voicePulse{0%,100%{box-shadow:0 0 0 0 rgba(201,168,76,0.35);}50%{box-shadow:0 0 0 8px rgba(201,168,76,0);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPLOAD ZONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.upload-zone{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:240px;border-radius:var(--r-lg);border:1.5px dashed rgba(45,138,68,0.35);background:rgba(45,138,68,0.04);cursor:pointer;overflow:hidden;margin-bottom:10px;transition:var(--transition);}
.upload-zone:hover,.upload-zone.drag-over{border-color:rgba(45,138,68,0.75);background:rgba(45,138,68,0.09);box-shadow:0 0 50px rgba(45,138,68,0.08) inset;}
.upload-zone.drag-over{border-style:solid;}
#uploadContent{display:flex;flex-direction:column;align-items:center;gap:10px;padding:24px;text-align:center;pointer-events:none;}
.upload-icon{font-size:42px;line-height:1;filter:drop-shadow(0 4px 12px rgba(45,138,68,0.5));animation:iconBob 3.5s ease-in-out infinite;}
@keyframes iconBob{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}
#uploadContent h3{font-family:var(--ff-display);font-size:22px;font-weight:500;color:var(--c-text);}
#uploadContent p{font-size:12px;color:var(--c-text-3);letter-spacing:0.03em;}
.upload-hint{font-size:11px;color:var(--c-green-500);margin-top:2px;letter-spacing:0.04em;text-transform:uppercase;}
.preview-img{display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:var(--r-lg);}
.upload-actions{display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:16px;}
.btn-upload-action{display:flex;align-items:center;justify-content:center;gap:7px;padding:10px;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-surface-md);color:var(--c-text-2);font-size:13px;font-weight:500;font-family:var(--ff-body);cursor:pointer;transition:var(--transition);letter-spacing:0.01em;}
.btn-upload-action:hover{border-color:var(--c-green-500);color:var(--c-green-300);background:rgba(45,138,68,0.07);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ERROR / PROGRESS / PRIMARY BTN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.error-box{display:none;align-items:flex-start;gap:12px;padding:16px;border-radius:var(--r-md);background:var(--c-error-bg);border:1px solid var(--c-error-border);color:#f0a0a0;font-size:13.5px;margin-bottom:14px;animation:slideUp 0.3s ease;}
.error-box.visible{display:flex;}
.error-box .icon{font-size:20px;flex-shrink:0;}
.error-title{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--c-error);margin-bottom:3px;}
.error-msg{font-size:13px;color:rgba(240,160,160,0.85);}
.error-dismiss{margin-left:auto;background:none;border:none;color:rgba(240,160,160,0.5);cursor:pointer;font-size:16px;padding:0 0 0 8px;transition:color var(--transition);flex-shrink:0;}
.error-dismiss:hover{color:rgba(240,160,160,0.9);}
.progress-wrap{display:none;flex-direction:column;gap:8px;margin-bottom:12px;}
.progress-wrap.visible{display:flex;}
.progress-label{font-size:12px;color:var(--c-text-3);font-family:var(--ff-mono);letter-spacing:0.04em;}
.progress-track{height:4px;border-radius:2px;background:rgba(255,255,255,0.06);overflow:hidden;}
.progress-bar{height:100%;width:0%;border-radius:2px;background:linear-gradient(90deg,var(--c-green-700),var(--c-green-300));transition:width 0.4s ease;box-shadow:0 0 8px rgba(94,203,116,0.5);}
.btn-primary{width:100%;padding:16px;border:none;border-radius:var(--r-md);cursor:pointer;font-family:var(--ff-body);font-size:15px;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;color:#fff;background:linear-gradient(135deg,var(--c-green-500) 0%,var(--c-green-700) 100%);box-shadow:0 6px 24px rgba(45,138,68,0.35),inset 0 1px 0 rgba(255,255,255,0.2);transition:var(--transition);position:relative;overflow:hidden;}
.btn-primary::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.12) 0%,transparent 60%);}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 32px rgba(45,138,68,0.45);}
.btn-primary:active{transform:translateY(0);}
.btn-primary:disabled{opacity:0.55;cursor:not-allowed;transform:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKELETON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.skeleton-screen{display:none;flex-direction:column;gap:14px;padding:4px 0;}
.skeleton-screen.visible{display:flex;}
.skel{border-radius:12px;background:linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.09) 50%,rgba(255,255,255,0.04) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.skel-row{height:18px;}.skel-half{width:60%;height:18px;}.skel-block{height:90px;}.skel-short{width:40%;height:14px;}.skel-metric{height:120px;border-radius:14px;}.skel-metrics{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULT HEADER + BADGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px;gap:12px;}
.result-header h2{font-family:var(--ff-display);font-size:28px;font-weight:600;color:var(--c-text);}
.badge-success{display:inline-flex;align-items:center;gap:4px;margin-top:6px;padding:3px 10px;border-radius:var(--r-full);background:rgba(45,138,68,0.18);border:1px solid rgba(45,138,68,0.35);font-size:11px;font-weight:500;color:var(--c-green-300);letter-spacing:0.04em;text-transform:uppercase;}
.badge-success::before{content:'';width:5px;height:5px;border-radius:50%;background:var(--c-green-300);box-shadow:0 0 6px var(--c-green-400);animation:blink 2s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0.3;}}
.btn-icon{display:grid;place-items:center;width:38px;height:38px;border-radius:50%;border:1px solid var(--c-border);background:var(--c-surface-md);cursor:pointer;font-size:16px;color:var(--c-text-2);transition:var(--transition);flex-shrink:0;}
.btn-icon:hover{background:var(--c-surface-hi);border-color:var(--c-border-hi);color:var(--c-text);transform:rotate(15deg);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   METRICS RINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
.metric-box{display:flex;flex-direction:column;align-items:center;gap:10px;padding:18px 14px;background:var(--c-surface-md);border:1px solid var(--c-border);border-radius:var(--r-md);text-align:center;position:relative;overflow:hidden;cursor:default;transition:border-color 0.25s ease,box-shadow 0.25s ease;}
.metric-box:hover{border-color:var(--c-green-500);box-shadow:0 0 22px rgba(45,138,68,0.18);}
.metric-tooltip{
  position:absolute;bottom:0;left:0;right:0;
  background:linear-gradient(160deg,rgba(10,46,20,0.97),rgba(8,15,11,0.99));
  border-top:1px solid rgba(94,203,116,0.18);
  padding:9px 12px 10px;
  font-size:11px;line-height:1.5;color:var(--c-text-2);
  transform:translateY(100%);
  transition:transform 0.28s cubic-bezier(0.4,0,0.2,1);
  pointer-events:none;
  border-radius:0 0 var(--r-md) var(--r-md);
}
.metric-box:hover .metric-tooltip{transform:translateY(0);}
.metric-tooltip strong{color:var(--c-green-300);display:block;font-size:10.5px;letter-spacing:0.05em;text-transform:uppercase;margin-bottom:2px;}
.metric-box::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--c-green-700),var(--c-green-400),var(--c-green-700));}
.ring-wrap{position:relative;width:72px;height:72px;}
.ring-wrap svg{transform:rotate(-90deg);}
.ring-bg{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:5;}
.ring-fill{fill:none;stroke:var(--c-green-400);stroke-width:5;stroke-linecap:round;stroke-dasharray:176;stroke-dashoffset:176;transition:stroke-dashoffset 1.2s cubic-bezier(0.4,0,0.2,1);}
.ring-fill.roi-ring{stroke:var(--c-gold);}
.ring-val{position:absolute;inset:0;display:grid;place-items:center;font-family:var(--ff-mono);font-size:13px;font-weight:500;color:var(--c-green-300);}
.ring-val.roi-val{color:var(--c-gold-light);}
.metric-label{font-size:11px;color:var(--c-text-3);font-weight:400;letter-spacing:0.04em;text-transform:uppercase;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIAGNOSIS CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.result-body{padding:0;margin-bottom:16px;}
.diagnosis-cards{display:flex;flex-direction:column;gap:10px;}
.diag-card{display:flex;align-items:flex-start;gap:14px;padding:14px 16px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.06);border-radius:var(--r-md);transition:var(--transition);opacity:0;transform:translateX(-10px);animation:cardIn 0.4s ease forwards;}
.diag-card:nth-child(1){animation-delay:0.05s;}.diag-card:nth-child(2){animation-delay:0.15s;}.diag-card:nth-child(3){animation-delay:0.25s;}
@keyframes cardIn{to{opacity:1;transform:translateX(0);}}
.diag-card:hover{background:rgba(45,138,68,0.06);border-color:rgba(45,138,68,0.22);}
.diag-icon{font-size:22px;flex-shrink:0;width:36px;text-align:center;padding-top:2px;}
.diag-info{flex:1;min-width:0;}
.diag-label{font-size:10.5px;text-transform:uppercase;letter-spacing:0.06em;color:var(--c-text-3);margin-bottom:3px;}
.diag-value{font-size:14.5px;font-weight:500;color:var(--c-text);word-break:break-word;line-height:1.4;}

/* â”€â”€ Rich treatment card (markdown rendered) â”€â”€ */
.diag-card-rich { align-items: flex-start; }
.diag-value-rich { font-size: 13px; color: var(--c-text-2); line-height: 1.6; width: 100%; }
.diag-value-rich .md-step {
  display: flex; gap: 10px; align-items: flex-start;
  margin: 7px 0; padding: 10px 12px;
  background: rgba(45,138,68,0.06);
  border: 1px solid rgba(45,138,68,0.12);
  border-radius: 10px;
}
.md-step-num {
  flex-shrink: 0; width: 22px; height: 22px; border-radius: 50%;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  color: #fff; font-size: 11px; font-weight: 700;
  display: grid; place-items: center; margin-top: 1px;
}
.md-step-content { flex: 1; display: flex; flex-direction: column; gap: 3px; }
.md-step-title { font-weight: 600; color: var(--c-text); font-size: 13px; }
.md-step-body { color: var(--c-text-3); font-size: 12.5px; line-height: 1.55; }
.diag-value-rich .md-bullet {
  padding: 4px 0 4px 10px;
  border-left: 2px solid rgba(45,138,68,0.3);
  color: var(--c-text-3); font-size: 13px; margin: 4px 0;
}
.diag-value-rich .md-para { color: var(--c-text-3); font-size: 13px; margin: 5px 0; line-height: 1.6; }
.diag-value-rich strong { color: var(--c-text); font-weight: 600; }
.diag-value-rich em { color: var(--c-green-300); font-style: italic; }
.diag-value-rich code { background: rgba(255,255,255,0.07); border-radius: 4px; padding: 1px 5px; font-size: 11.5px; }
.severity-bar-wrap{margin-top:8px;}
.severity-bar-track{height:3px;border-radius:2px;background:rgba(255,255,255,0.07);overflow:hidden;}
.severity-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--c-green-500),var(--c-amber),var(--c-error));transition:width 1s cubic-bezier(0.4,0,0.2,1);width:0%;}
.empty-state{display:none;flex-direction:column;align-items:center;gap:10px;padding:32px 16px;text-align:center;}
.empty-state.visible{display:flex;}
.empty-icon{font-size:40px;}
.empty-state h4{font-family:var(--ff-display);font-size:22px;color:var(--c-text-2);}
.empty-state p{font-size:13px;color:var(--c-text-3);max-width:240px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INFO BOXES / ACTION BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.info-box{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;border-radius:var(--r-md);margin-bottom:12px;font-size:13.5px;}
.info-box .icon{font-size:18px;flex-shrink:0;margin-top:1px;}
.info-box b{display:block;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:2px;}
.info-box.warning{background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2);color:var(--c-gold-light);}
.info-box.warning b{color:var(--c-gold);}
.info-box.info{background:rgba(45,138,68,0.06);border:1px solid rgba(45,138,68,0.18);color:var(--c-text-2);}
.info-box.info b{color:var(--c-green-300);}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.btn-outline{padding:12px;border-radius:var(--r-md);border:1px solid var(--c-border);background:var(--c-surface-md);color:var(--c-text-2);font-size:13px;font-weight:500;font-family:var(--ff-body);cursor:pointer;transition:var(--transition);letter-spacing:0.01em;}
.btn-outline:hover{background:var(--c-surface-hi);border-color:var(--c-green-500);color:var(--c-green-300);box-shadow:0 4px 16px rgba(45,138,68,0.15);transform:translateY(-2px);}
.btn-secondary{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:13px;border-radius:var(--r-md);background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.22);color:var(--c-gold-light);font-size:13.5px;font-weight:500;font-family:var(--ff-body);text-decoration:none;letter-spacing:0.02em;transition:var(--transition);}
.btn-secondary:hover{background:rgba(201,168,76,0.14);border-color:rgba(201,168,76,0.40);box-shadow:0 4px 20px rgba(201,168,76,0.12);transform:translateY(-1px);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAB + CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fab-chat {
  position: fixed !important;
  bottom: 28px !important;
  right: 24px !important;
  z-index: 9999 !important;
  width: 62px;
  height: 62px;
  border-radius: 50%;
  border: 1.5px solid rgba(45,138,68,0.45);
  background: linear-gradient(135deg, var(--c-green-600, #2d8a44) 0%, var(--c-green-900) 100%);
  box-shadow: 0 8px 28px rgba(0,0,0,0.5), 0 0 30px rgba(45,138,68,0.25);
  color: var(--c-green-100);
  font-size: 24px;
  cursor: pointer;
  display: grid;
  place-items: center;
  transition: transform 0.25s cubic-bezier(0.34,1.3,0.64,1), box-shadow 0.25s ease;
  overflow: hidden;
  user-select: none;
  -webkit-user-select: none;
}
.fab-chat:hover { transform: scale(1.08) translateY(-2px); box-shadow: 0 12px 36px rgba(0,0,0,0.5), 0 0 40px rgba(45,138,68,0.35); }
.fab-chat.voice-mode {
  background: linear-gradient(135deg, #8a2d2d 0%, #4a0f0f 100%);
  border-color: rgba(224,82,82,0.5);
  box-shadow: 0 8px 28px rgba(0,0,0,0.5), 0 0 40px rgba(224,82,82,0.3);
  animation: fabVoicePulse 1.5s ease-in-out infinite;
}
@keyframes fabVoicePulse {
  0%,100% { box-shadow: 0 8px 28px rgba(0,0,0,0.5), 0 0 30px rgba(224,82,82,0.3); }
  50%      { box-shadow: 0 8px 28px rgba(0,0,0,0.5), 0 0 55px rgba(224,82,82,0.55); }
}
.fab-icon { pointer-events: none; transition: transform 0.3s cubic-bezier(0.34,1.5,0.64,1), opacity 0.2s ease; }
.fab-ripple {
  position: absolute; inset: 0; border-radius: 50%;
  background: rgba(255,255,255,0.18);
  transform: scale(0); opacity: 0;
  pointer-events: none;
  transition: transform 0.4s ease, opacity 0.4s ease;
}
.fab-ripple.go { transform: scale(2.5); opacity: 0; }
.fab-double-hint {
  position: absolute; bottom: 110%; right: 0;
  background: rgba(8,15,11,0.92);
  border: 1px solid var(--c-border-hi);
  border-radius: 10px;
  padding: 6px 12px;
  font-size: 11px; color: var(--c-text-3);
  white-space: nowrap;
  opacity: 0; pointer-events: none;
  transform: translateY(6px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  backdrop-filter: blur(12px);
}
.fab-chat:hover .fab-double-hint {
  opacity: 1; transform: translateY(0);
}

/* â•â•â•â• VOICE OVERLAY â€” removed, voice is now inline in chat widget â•â•â•â• */
.chatbot-container{display:none;flex-direction:column;position:fixed;bottom:96px;right:20px;z-index:3000;width:340px;height:460px;border-radius:var(--r-xl);border:1px solid var(--c-border-hi);background:rgba(10,20,13,0.88);backdrop-filter:blur(32px) saturate(200%);-webkit-backdrop-filter:blur(32px) saturate(200%);box-shadow:var(--shadow-lg),var(--shadow-glow);overflow:hidden;animation:chatOpen 0.3s cubic-bezier(0.34,1.56,0.64,1) both;}
#chatTextPanel{display:flex;flex-direction:column;flex:1;min-height:0;}
@keyframes chatOpen{from{opacity:0;transform:scale(0.9) translateY(16px);transform-origin:bottom right;}to{opacity:1;transform:scale(1) translateY(0);}}
.chat-header{display:flex;align-items:center;gap:10px;padding:14px 18px;border-bottom:1px solid var(--c-border);background:rgba(255,255,255,0.03);}
.chat-header span{flex:1;font-family:var(--ff-display);font-size:17px;font-weight:600;letter-spacing:0.01em;color:var(--c-text);}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--c-green-400);box-shadow:0 0 8px var(--c-green-400);animation:blink 2s ease-in-out infinite;}
.close-chat{width:28px;height:28px;border-radius:50%;border:1px solid var(--c-border);background:var(--c-surface-md);color:var(--c-text-3);font-size:16px;cursor:pointer;display:grid;place-items:center;transition:var(--transition);}
.close-chat:hover{color:var(--c-text);background:var(--c-surface-hi);}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;scrollbar-width:thin;scrollbar-color:var(--c-border) transparent;}
.msg{max-width:82%;padding:10px 14px;border-radius:16px;font-size:13.5px;line-height:1.5;}
.msg.bot{align-self:flex-start;background:rgba(45,138,68,0.12);border:1px solid rgba(45,138,68,0.2);border-bottom-left-radius:4px;color:var(--c-text-2);}
.msg.user{align-self:flex-end;background:rgba(255,255,255,0.07);border:1px solid var(--c-border);border-bottom-right-radius:4px;color:var(--c-text);}
.msg.typing{display:flex;align-items:center;gap:5px;padding:14px 16px;}
.typing-dot{width:7px;height:7px;border-radius:50%;background:var(--c-green-400);animation:typingBounce 1.2s ease-in-out infinite;}
.typing-dot:nth-child(2){animation-delay:0.2s;}.typing-dot:nth-child(3){animation-delay:0.4s;}
@keyframes typingBounce{0%,80%,100%{transform:translateY(0);opacity:0.5;}40%{transform:translateY(-6px);opacity:1;}}
.chat-input-area{display:flex;gap:8px;padding:12px 14px;border-top:1px solid var(--c-border);background:rgba(0,0,0,0.2);}
.chat-input-area input{flex:1;padding:10px 14px;background:rgba(255,255,255,0.05);border:1px solid var(--c-border);border-radius:var(--r-full);color:var(--c-text);font-size:13.5px;font-family:var(--ff-body);outline:none;transition:var(--transition);}
.chat-input-area input::placeholder{color:var(--c-text-3);}
.chat-input-area input:focus{border-color:var(--c-green-500);background:rgba(255,255,255,0.07);box-shadow:0 0 0 3px rgba(45,138,68,0.12);}
.btn-send{width:40px;height:40px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--c-green-500),var(--c-green-700));color:white;font-size:14px;cursor:pointer;display:grid;place-items:center;flex-shrink:0;box-shadow:0 4px 12px rgba(45,138,68,0.3);transition:var(--transition);}
.btn-send:hover{transform:scale(1.08);}

/* â”€â”€ Chat mode toggle button â”€â”€ */
.chat-mode-toggle {
  width: 28px; height: 28px; border-radius: 50%;
  border: 1px solid var(--c-border);
  background: var(--c-surface-md);
  color: var(--c-text-3); font-size: 13px;
  cursor: pointer; display: grid; place-items: center;
  transition: var(--transition);
}
.chat-mode-toggle:hover { background: var(--c-surface-hi); color: var(--c-text); }
.chat-mode-toggle.voice-active {
  background: rgba(224,82,82,0.15);
  border-color: rgba(224,82,82,0.4);
  color: #f08080;
  animation: voiceTogglePulse 1.5s ease-in-out infinite;
}
@keyframes voiceTogglePulse {
  0%,100% { box-shadow: 0 0 0 0 rgba(224,82,82,0.3); }
  50%      { box-shadow: 0 0 0 5px rgba(224,82,82,0); }
}

/* â”€â”€ Voice panel â”€â”€ */
#chatVoicePanel { display: flex; flex-direction: column; flex: 1; }
.cv-body {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 14px; padding: 20px 20px 10px;
}
.cv-orb-wrap { position: relative; width: 90px; height: 90px; display: grid; place-items: center; }
.cv-orb {
  width: 72px; height: 72px; border-radius: 50%;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  display: grid; place-items: center; position: relative; z-index: 1;
  box-shadow: 0 0 24px rgba(45,138,68,0.3);
  transition: all 0.4s cubic-bezier(0.34,1.3,0.64,1);
}
.cv-orb.listening {
  background: linear-gradient(135deg, #8a2d2d, #c0392b);
  box-shadow: 0 0 30px rgba(192,57,43,0.45);
  animation: cvOrbPulse 1.1s ease-in-out infinite;
}
.cv-orb.thinking {
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-400));
  animation: cvOrbThink 1.6s ease-in-out infinite;
}
@keyframes cvOrbPulse  { 0%,100%{transform:scale(1);}   50%{transform:scale(1.08);} }
@keyframes cvOrbThink  { 0%,100%{opacity:1;}             50%{opacity:0.7;} }
.cv-ring {
  position: absolute; border-radius: 50%;
  border: 1px solid rgba(45,138,68,0.25);
  animation: cvRingExpand 2s ease-out infinite;
  pointer-events: none;
}
.cv-orb.listening .cv-ring { border-color: rgba(192,57,43,0.25); }
.cv-ring-a { width: 85px; height: 85px; animation-delay: 0s; }
.cv-ring-b { width: 105px; height: 105px; animation-delay: 0.65s; }
@keyframes cvRingExpand { 0%{transform:scale(0.9);opacity:0.6;} 100%{transform:scale(1.3);opacity:0;} }
.cv-orb-icon { font-size: 28px; line-height: 1; }
.cv-status {
  font-size: 13px; font-weight: 600; color: var(--c-text-2);
  text-align: center; letter-spacing: 0.01em;
}
.cv-transcript {
  font-size: 12.5px; color: var(--c-text-3); text-align: center;
  min-height: 36px; line-height: 1.5; padding: 0 8px;
  font-style: italic;
}
.cv-response {
  font-size: 13px; color: var(--c-green-300); text-align: center;
  line-height: 1.55; padding: 8px 12px;
  background: rgba(45,138,68,0.07);
  border: 1px solid rgba(45,138,68,0.15);
  border-radius: 12px; display: none; width: 100%;
  max-height: 100px; overflow-y: auto;
}
.cv-response.visible { display: block; }
.cv-footer {
  padding: 10px 14px 14px;
  border-top: 1px solid var(--c-border);
  background: rgba(0,0,0,0.15);
}
.cv-mic-btn {
  width: 100%; padding: 11px;
  border-radius: var(--r-md); border: 1px solid rgba(224,82,82,0.3);
  background: rgba(224,82,82,0.08);
  color: #f08080; font-size: 13px; font-weight: 600;
  cursor: pointer; font-family: var(--ff-body);
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: var(--transition);
}
.cv-mic-btn:hover { background: rgba(224,82,82,0.16); border-color: rgba(224,82,82,0.5); }
.cv-mic-btn.active {
  background: rgba(224,82,82,0.15); border-color: rgba(224,82,82,0.5);
  color: #ff8080;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-backdrop{display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.65);backdrop-filter:blur(8px);align-items:flex-end;justify-content:center;padding:20px;padding-bottom:32px;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal-card{width:100%;max-width:480px;background:rgba(12,22,15,0.96);backdrop-filter:blur(40px);border:1px solid var(--c-border-hi);border-radius:var(--r-xl);padding:28px 24px;box-shadow:var(--shadow-lg);animation:modalSlide 0.35s cubic-bezier(0.34,1.56,0.64,1) both;position:relative;overflow:hidden;}
.modal-card::before{content:'';position:absolute;top:0;left:10%;right:10%;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.12),transparent);}
@keyframes modalSlide{from{transform:translateY(40px) scale(0.96);opacity:0;}to{transform:translateY(0) scale(1);opacity:1;}}
.modal-card h3{font-family:var(--ff-display);font-size:24px;font-weight:600;margin-bottom:20px;color:var(--c-text);}
.list-group{display:flex;flex-direction:column;gap:10px;margin-bottom:18px;}
.list-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--c-surface-md);border:1px solid var(--c-border);border-radius:var(--r-md);gap:12px;transition:var(--transition);}
.list-item:hover{border-color:var(--c-green-500);background:rgba(45,138,68,0.07);}
.item-info{display:flex;flex-direction:column;gap:3px;}
.item-info b{font-size:14px;font-weight:600;color:var(--c-text);}
.item-info span{font-size:12px;color:var(--c-text-3);}
.btn-sm{padding:8px 16px;border-radius:var(--r-full);border:1px solid var(--c-green-500);background:rgba(45,138,68,0.12);color:var(--c-green-300);font-size:12px;font-weight:600;font-family:var(--ff-body);cursor:pointer;letter-spacing:0.04em;transition:var(--transition);white-space:nowrap;}
.btn-sm:hover{background:rgba(45,138,68,0.25);}
.btn-text{display:block;width:100%;padding:10px;border:none;background:none;color:var(--c-text-3);font-size:13.5px;font-family:var(--ff-body);cursor:pointer;text-align:center;transition:color var(--transition);}
.btn-text:hover{color:var(--c-text-2);}
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO LANDING SECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero-section {
  position: relative;
  padding: 80px 24px 60px;
  text-align: center;
  max-width: 860px;
  margin: 0 auto;
  z-index: 2;
}
.hero-badge {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 6px 16px; border-radius: 999px;
  background: rgba(45,138,68,0.15); border: 1px solid rgba(45,138,68,0.35);
  font-size: 11.5px; font-weight: 600; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--c-green-300);
  margin-bottom: 28px;
  animation: slideUp 0.6s cubic-bezier(0.34,1.56,0.64,1) both;
}
.hero-badge .dot { width:6px; height:6px; border-radius:50%; background:var(--c-green-400); box-shadow:0 0 8px var(--c-green-400); animation:blink 2s infinite; }
.hero-title {
  font-family: var(--ff-display);
  font-size: clamp(42px, 8vw, 78px);
  font-weight: 700; line-height: 1.05;
  color: var(--c-text); letter-spacing: -0.02em;
  margin-bottom: 12px;
  animation: slideUp 0.7s cubic-bezier(0.34,1.56,0.64,1) 0.1s both;
}
.hero-title .green { color: var(--c-green-400); }
.hero-subtitle-team {
  font-size: 13px; color: var(--c-green-500); font-weight: 600;
  letter-spacing: 0.12em; text-transform: uppercase;
  margin-bottom: 20px;
  animation: slideUp 0.7s ease 0.15s both;
}
.hero-desc {
  font-size: 16.5px; color: var(--c-text-2); line-height: 1.75;
  max-width: 620px; margin: 0 auto 40px;
  animation: slideUp 0.7s ease 0.2s both;
}
.hero-stats {
  display: flex; justify-content: center; gap: 40px; flex-wrap: wrap;
  margin-bottom: 52px;
  animation: slideUp 0.7s ease 0.25s both;
}
.hero-stat { text-align: center; }
.hero-stat-val {
  font-family: var(--ff-display); font-size: 32px; font-weight: 700;
  color: var(--c-green-300); line-height: 1;
}
.hero-stat-label { font-size: 11px; color: var(--c-text-3); text-transform: uppercase; letter-spacing: 0.08em; margin-top: 4px; }

/* â•â•â• FEATURES SECTION â•â•â• */
.features-section {
  max-width: 960px; margin: 0 auto;
  padding: 0 20px 60px;
  scroll-margin-top: 100px; /* <--- This forces it to stop right above the heading! */
}
.features-heading {
  text-align: center; margin-bottom: 36px;
}
.features-heading h2 {
  font-family: var(--ff-display); font-size: 36px; font-weight: 600;
  color: var(--c-text); margin-bottom: 8px;
}
.features-heading p { font-size: 14px; color: var(--c-text-3); }

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px; margin-bottom: 16px;
}
.feat-card {
  background: rgba(255,255,255,0.035);
  border: 1px solid var(--c-border);
  border-radius: 24px; padding: 28px 22px;
  backdrop-filter: blur(20px);
  transition: var(--transition);
  position: relative; overflow: hidden;
}
.feat-card::before {
  content: ''; position: absolute; top:0; left:15%; right:15%; height:1px;
  background: linear-gradient(90deg, transparent, rgba(94,203,116,0.3), transparent);
}
.feat-card:hover {
  border-color: rgba(45,138,68,0.45);
  transform: translateY(-4px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.4), 0 0 30px rgba(45,138,68,0.08);
}
.feat-icon { font-size: 32px; margin-bottom: 14px; line-height:1; }
.feat-title { font-family: var(--ff-display); font-size: 20px; font-weight: 600; color: var(--c-text); margin-bottom: 8px; }
.feat-desc { font-size: 13px; color: var(--c-text-2); line-height: 1.65; }
.feat-tag {
  display: inline-block; margin-top: 12px;
  padding: 3px 10px; border-radius: 999px;
  background: rgba(45,138,68,0.12); border: 1px solid rgba(45,138,68,0.25);
  font-size: 10.5px; font-weight: 600; color: var(--c-green-400);
  letter-spacing: 0.06em; text-transform: uppercase;
}

/* â•â•â• TRY IT CTA DIVIDER â•â•â• */
.try-divider {
  text-align: center; padding: 48px 20px 36px;
  position: relative;
}
.try-divider::before {
  content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
  width: 1px; height: 48px;
  background: linear-gradient(to bottom, transparent, rgba(45,138,68,0.5), transparent);
}
.try-divider h3 {
  font-family: var(--ff-display); font-size: 28px; font-weight: 600;
  color: var(--c-text); margin-bottom: 8px;
}
.try-divider p { font-size: 13.5px; color: var(--c-text-3); margin-bottom: 20px; }
.try-arrow {
  display: inline-block;
  font-size: 28px;
  animation: bounceDown 1.6s ease-in-out infinite;
  color: var(--c-green-400);
}
@keyframes bounceDown {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(10px); }
}

/* â•â•â• FOOTER â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IMPACT CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.impact-card {
  margin: 0 auto 24px;
  max-width: 860px;
  background: rgba(255,255,255,0.02);
  border: 1px solid rgba(94,203,116,0.2);
  border-radius: var(--r-xl);
  padding: 28px 32px;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.04);
  position: relative; overflow: hidden;
}
.impact-card::before {
  content: '';
  position: absolute; top: 0; left: 10%; right: 10%; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(94,203,116,0.35) 50%, transparent);
}
.impact-card-label {
  text-align: center;
  font-size: 10px; text-transform: uppercase;
  letter-spacing: 0.1em; color: var(--c-text-3);
  margin-bottom: 22px; font-weight: 500;
}
.impact-grid {
  display: grid; grid-template-columns: repeat(3, 1fr);
  text-align: center;
}
.impact-stat { padding: 8px 16px; }
.impact-stat-mid {
  border-left: 1px solid var(--c-border);
  border-right: 1px solid var(--c-border);
}
.impact-val {
  font-family: var(--ff-display);
  font-size: 32px; font-weight: 800;
  line-height: 1; margin-bottom: 6px;
  letter-spacing: -0.02em;
}
.impact-desc {
  font-size: 11px; color: var(--c-text-3);
  letter-spacing: 0.02em; line-height: 1.4;
}
@media(max-width:480px) {
  .impact-val { font-size: 26px; }
  .impact-card { padding: 22px 18px; }
}

.agri-footer {
  text-align: center;
  padding: 36px 20px 28px;
  border-top: 1px solid var(--c-border);
  margin-top: 48px;
}
.footer-hacknovation {
  font-family: var(--ff-display);
  font-size: 15px; color: var(--c-text-3);
  letter-spacing: 0.04em;
}
.footer-hacknovation span { color: var(--c-green-400); font-weight: 600; }
.footer-team {
  font-size: 12px; color: var(--c-text-3);
  margin-top: 6px; letter-spacing: 0.06em; text-transform: uppercase;
}

/* â•â•â• HERO SCROLL BUTTON â•â•â• */
.hero-scroll-btn {
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  width: 54px; 
  height: 54px; 
  margin-top: 20px;
  border-radius: 50%;
  background: rgba(255,255,255,0.03);
  backdrop-filter: blur(10px);
  border: 1px solid var(--c-border);
  color: var(--c-green-400); 
  font-size: 22px;
  text-decoration: none; 
  transition: var(--transition);
  animation: bounceFloat 2.5s ease-in-out infinite, slideUp 0.7s ease 0.3s both;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  z-index: 10;
}

.hero-scroll-btn:hover {
  background: rgba(45,138,68,0.12);
  border-color: var(--c-green-500); 
  color: var(--c-green-300);
  box-shadow: 0 8px 28px rgba(45,138,68,0.3);
}

@keyframes bounceFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(12px); }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART CULTIVATION CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Full-screen panel â”€â”€ */
#calendarPanel {
  position: fixed; inset: 0; z-index: 2000;
  background: #080f0b;
  display: none; flex-direction: column;
  overflow: hidden;
  pointer-events: none;
}
#calendarPanel.open { display: flex; pointer-events: auto; animation: calPanelIn 0.45s cubic-bezier(0.34,1.2,0.64,1) both; }
@keyframes calPanelIn {
  from { opacity:0; transform: translateY(28px) scale(0.98); }
  to   { opacity:1; transform: translateY(0) scale(1); }
}

/* â”€â”€ Calendar background mesh (matches main app) â”€â”€ */
#calendarPanel::before {
  content: '';
  position: absolute; inset: 0; z-index: 0; pointer-events: none;
  background:
    radial-gradient(ellipse 80% 60% at 20% 10%, rgba(20,80,35,0.50) 0%, transparent 60%),
    radial-gradient(ellipse 60% 50% at 80% 80%, rgba(10,50,25,0.45) 0%, transparent 55%),
    radial-gradient(ellipse 50% 70% at 60% 30%, rgba(45,138,68,0.15) 0%, transparent 50%),
    #080f0b;
  animation: meshDrift 18s ease-in-out infinite alternate;
}
#calendarPanel::after {
  content: ''; position: absolute; inset: 0; z-index: 1; pointer-events: none; opacity: 0.022;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
  background-repeat: repeat; background-size: 128px;
}

/* â”€â”€ Floating orbs inside calendar panel â”€â”€ */
.cal-orb {
  position: absolute; border-radius: 50%; filter: blur(80px);
  pointer-events: none; z-index: 0; animation: orbFloat 20s ease-in-out infinite;
}
.cal-orb-1 {
  width: 420px; height: 420px;
  background: radial-gradient(circle, rgba(45,138,68,0.28) 0%, transparent 70%);
  top: -120px; left: -120px; animation-delay: -3s;
}
.cal-orb-2 {
  width: 320px; height: 320px;
  background: radial-gradient(circle, rgba(201,168,76,0.14) 0%, transparent 70%);
  bottom: 60px; right: -80px; animation-delay: -11s;
}
.cal-orb-3 {
  width: 260px; height: 260px;
  background: radial-gradient(circle, rgba(30,100,50,0.20) 0%, transparent 70%);
  top: 45%; left: 55%; animation-delay: -6s;
}

/* â”€â”€ Ensure nav + body sit above pseudo-elements â”€â”€ */
#calendarPanel .cal-nav,
#calendarPanel .cal-body {
  position: relative; z-index: 2;
}

/* â”€â”€ Calendar Nav Bar â”€â”€ */
.cal-nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 24px;
  background: rgba(8,20,12,0.55);
  border-bottom: 1px solid rgba(94,203,116,0.12);
  flex-shrink: 0;
  backdrop-filter: blur(24px) saturate(160%);
  -webkit-backdrop-filter: blur(24px) saturate(160%);
  position: relative; z-index: 3;
}
.cal-nav-title {
  display: flex; align-items: center; gap: 10px;
  font-family: var(--ff-display); font-size: 22px; font-weight: 600;
  color: var(--c-text); letter-spacing: 0.01em;
}
.cal-nav-icon {
  width: 36px; height: 36px; border-radius: 10px;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  display: grid; place-items: center; font-size: 17px;
  box-shadow: 0 4px 14px rgba(45,138,68,0.4);
}
.cal-close-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: var(--r-full);
  border: 1px solid var(--c-border); background: var(--c-surface-md);
  color: var(--c-text-2); font-size: 13px; font-weight: 500;
  font-family: var(--ff-body); cursor: pointer; transition: var(--transition);
}
.cal-close-btn:hover { background: var(--c-surface-hi); color: var(--c-text); }

/* â”€â”€ Calendar Body â”€â”€ */
.cal-body {
  flex: 1; overflow-y: auto;
  padding: 0;
  width: 100%;
  scrollbar-width: thin; scrollbar-color: var(--c-green-700) transparent;
}
.cal-body::-webkit-scrollbar { width: 6px; }
.cal-body::-webkit-scrollbar-track { background: transparent; }
.cal-body::-webkit-scrollbar-thumb { background: var(--c-green-700); border-radius: 999px; }

/* Inner wrapper for centered content */
.cal-body-inner {
  max-width: 1100px;
  margin: 0 auto;
  padding: 28px 24px 80px;
}

/* â”€â”€ Setup Card â”€â”€ */
.cal-setup {
  background: rgba(255,255,255,0.035);
  border: 1px solid var(--c-border);
  border-radius: var(--r-xl); padding: 26px 24px;
  margin-bottom: 24px; position: relative; overflow: hidden;
  backdrop-filter: blur(20px);
}
.cal-setup::before {
  content: ''; position: absolute; top:0; left:10%; right:10%; height:1px;
  background: linear-gradient(90deg, transparent, rgba(94,203,116,0.3), transparent);
}
.cal-setup-title {
  font-family: var(--ff-display); font-size: 20px; font-weight: 600;
  color: var(--c-text); margin-bottom: 18px; display: flex; align-items: center; gap: 8px;
}
.cal-form-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 14px; margin-bottom: 18px;
}
.cal-field { display: flex; flex-direction: column; gap: 6px; }
.cal-label {
  font-size: 10.5px; text-transform: uppercase; letter-spacing: 0.07em;
  color: var(--c-text-3); font-weight: 600;
}
.cal-input, .cal-select {
  padding: 11px 14px;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--c-border);
  border-radius: 14px; color: var(--c-text);
  font-size: 13.5px; font-family: var(--ff-body);
  outline: none; transition: var(--transition);
  appearance: none;
}
.cal-input:focus, .cal-select:focus {
  border-color: var(--c-green-500); background: rgba(255,255,255,0.06);
  box-shadow: 0 0 0 3px rgba(45,138,68,0.12);
}
.cal-select option { background: #0a1a0f; }
.cal-input::placeholder { color: var(--c-text-3); }
.cal-generate-btn {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  width: 100%; padding: 15px;
  border: none; border-radius: 16px; cursor: pointer;
  font-family: var(--ff-body); font-size: 14.5px; font-weight: 600;
  letter-spacing: 0.04em; text-transform: uppercase; color: #fff;
  background: linear-gradient(135deg, var(--c-green-500) 0%, var(--c-green-700) 100%);
  box-shadow: 0 6px 24px rgba(45,138,68,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
  transition: var(--transition); position: relative; overflow: hidden;
}
.cal-generate-btn::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 60%);
}
.cal-generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 32px rgba(45,138,68,0.45); }
.cal-generate-btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

/* â”€â”€ Location Row â”€â”€ */
.cal-location-row {
  display: flex; gap: 8px; align-items: flex-end;
}
.cal-location-row .cal-input { flex: 1; }
.cal-detect-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 11px 14px; border-radius: 14px;
  border: 1px solid rgba(45,138,68,0.3); background: rgba(45,138,68,0.08);
  color: var(--c-green-300); font-size: 12.5px; font-weight: 500;
  font-family: var(--ff-body); cursor: pointer; transition: var(--transition);
  white-space: nowrap; flex-shrink: 0;
}
.cal-detect-btn:hover { background: rgba(45,138,68,0.18); }
.cal-detect-btn.detecting { animation: voicePulse 1.2s infinite; }

/* â”€â”€ Weather Hero Banner â”€â”€ */
.cal-weather-banner {
  display: none; align-items: center; gap: 16px;
  padding: 20px 24px;
  background: linear-gradient(135deg, rgba(10,25,15,0.9) 0%, rgba(15,35,20,0.9) 100%);
  border: 1px solid rgba(45,138,68,0.22);
  border-radius: var(--r-lg); margin-bottom: 22px;
  backdrop-filter: blur(20px);
}
.cal-weather-banner.visible { display: flex; flex-wrap: wrap; gap: 20px; }
.cal-weather-main {
  display: flex; align-items: center; gap: 14px; flex: 1; min-width: 200px;
}
.cal-weather-icon { font-size: 44px; line-height: 1; filter: drop-shadow(0 4px 12px rgba(45,138,68,0.3)); }
.cal-weather-info h3 {
  font-family: var(--ff-display); font-size: 28px; font-weight: 700;
  color: var(--c-text); line-height: 1; margin-bottom: 4px;
}
.cal-weather-info p { font-size: 12.5px; color: var(--c-text-3); letter-spacing: 0.04em; }
.cal-weather-stats {
  display: flex; gap: 16px; flex-wrap: wrap; align-items: center;
}
.cal-weather-stat {
  display: flex; flex-direction: column; gap: 3px; min-width: 70px;
  padding: 10px 14px; background: rgba(255,255,255,0.04);
  border: 1px solid var(--c-border); border-radius: 12px; text-align: center;
}
.cal-weather-stat .val { font-family: var(--ff-mono); font-size: 15px; font-weight: 500; color: var(--c-green-300); }
.cal-weather-stat .lbl { font-size: 10px; color: var(--c-text-3); text-transform: uppercase; letter-spacing: 0.05em; }

/* â”€â”€ Overall Risk Banner â”€â”€ */
.cal-risk-banner {
  display: none;
  align-items: flex-start; gap: 14px;
  padding: 18px 20px; border-radius: var(--r-md);
  margin-bottom: 22px; animation: slideUp 0.4s ease both;
}
.cal-risk-banner.visible { display: flex; }
.cal-risk-banner.risk-low    { background: rgba(45,138,68,0.1); border: 1px solid rgba(45,138,68,0.3); }
.cal-risk-banner.risk-medium { background: rgba(201,168,76,0.1); border: 1px solid rgba(201,168,76,0.3); }
.cal-risk-banner.risk-high   { background: rgba(224,82,82,0.1); border: 1px solid rgba(224,82,82,0.3); }
.cal-risk-banner .risk-icon { font-size: 24px; flex-shrink: 0; padding-top: 2px; }
.cal-risk-banner .risk-title {
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 4px;
}
.risk-low .risk-title    { color: var(--c-green-400); }
.risk-medium .risk-title { color: var(--c-gold); }
.risk-high .risk-title   { color: var(--c-error); }
.cal-risk-banner .risk-desc { font-size: 13.5px; color: var(--c-text-2); line-height: 1.5; }
.risk-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px; border-radius: var(--r-full);
  font-size: 11px; font-weight: 600; letter-spacing: 0.04em;
  text-transform: uppercase; flex-shrink: 0; margin-top: 2px;
}
.risk-badge.low    { background: rgba(45,138,68,0.18); color: var(--c-green-300); border: 1px solid rgba(45,138,68,0.35); }
.risk-badge.medium { background: rgba(201,168,76,0.18); color: var(--c-gold-light); border: 1px solid rgba(201,168,76,0.35); }
.risk-badge.high   { background: rgba(224,82,82,0.18); color: #f08080; border: 1px solid rgba(224,82,82,0.35); }
.risk-dot { width: 6px; height: 6px; border-radius: 50%; }
.risk-dot.low    { background: var(--c-green-400); box-shadow: 0 0 6px var(--c-green-400); animation: blink 2s infinite; }
.risk-dot.medium { background: var(--c-gold); box-shadow: 0 0 6px var(--c-gold); animation: blink 2s infinite; }
.risk-dot.high   { background: var(--c-error); box-shadow: 0 0 6px var(--c-error); animation: blink 1s infinite; }

/* â”€â”€ AI Insight Card â”€â”€ */
.cal-ai-card {
  display: none;
  background: rgba(45,138,68,0.06);
  border: 1px solid rgba(45,138,68,0.2);
  border-radius: var(--r-lg); padding: 20px 22px;
  margin-bottom: 24px; position: relative; overflow: hidden;
}
.cal-ai-card.visible { display: block; animation: slideUp 0.5s ease both; }
.cal-ai-card::before {
  content: ''; position: absolute; top:0; left:5%; right:5%; height:1px;
  background: linear-gradient(90deg, transparent, rgba(94,203,116,0.4), transparent);
}
.cal-ai-header {
  display: flex; align-items: center; gap: 10px; margin-bottom: 14px;
}
.cal-ai-orb {
  width: 32px; height: 32px; border-radius: 50%;
  background: linear-gradient(135deg, var(--c-green-700), var(--c-green-500));
  display: grid; place-items: center; font-size: 15px; flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(45,138,68,0.4);
  animation: orbFloat 4s ease-in-out infinite;
}
.cal-ai-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: var(--c-green-400); font-weight: 600; }
.cal-ai-text { font-size: 14px; color: var(--c-text-2); line-height: 1.7; margin-bottom: 14px; }
.cal-prob-row {
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
}
.cal-prob-item {
  display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 120px;
}
.cal-prob-label { font-size: 11px; color: var(--c-text-3); letter-spacing: 0.04em; text-transform: uppercase; }
.cal-prob-bar-track {
  height: 6px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden;
}
.cal-prob-bar-fill {
  height: 100%; border-radius: 3px;
  transition: width 1.2s cubic-bezier(0.4,0,0.2,1);
  width: 0%;
}
.cal-prob-bar-fill.low    { background: linear-gradient(90deg, var(--c-green-700), var(--c-green-400)); }
.cal-prob-bar-fill.medium { background: linear-gradient(90deg, #8a7020, var(--c-gold)); }
.cal-prob-bar-fill.high   { background: linear-gradient(90deg, #8a2020, var(--c-error)); box-shadow: 0 0 8px rgba(224,82,82,0.4); }
.cal-prob-pct { font-family: var(--ff-mono); font-size: 13px; color: var(--c-text-2); font-weight: 500; }

/* â”€â”€ Week Cards â”€â”€ */
.cal-weeks-title {
  font-family: var(--ff-display); font-size: 18px; font-weight: 600;
  color: var(--c-text); margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.cal-weeks-title span { font-size: 12px; color: var(--c-text-3); font-family: var(--ff-body); font-weight: 400; letter-spacing: 0.04em; }
.cal-weeks-grid {
  display: flex; flex-direction: column; gap: 12px;
}
.cal-week-card {
  background: rgba(255,255,255,0.03);
  border: 1px solid var(--c-border);
  border-radius: 22px; overflow: hidden;
  transition: var(--transition);
  animation: slideUp 0.45s cubic-bezier(0.34,1.4,0.64,1) both;
}
.cal-week-card:nth-child(1) { animation-delay: 0.05s; }
.cal-week-card:nth-child(2) { animation-delay: 0.12s; }
.cal-week-card:nth-child(3) { animation-delay: 0.19s; }
.cal-week-card:nth-child(4) { animation-delay: 0.26s; }
.cal-week-card:hover { border-color: rgba(45,138,68,0.35); box-shadow: 0 8px 28px rgba(0,0,0,0.3); }

.cal-week-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px; cursor: pointer;
  border-bottom: 1px solid transparent; transition: var(--transition);
}
.cal-week-card.expanded .cal-week-header { border-bottom-color: var(--c-border); }
.cal-week-left { display: flex; align-items: center; gap: 14px; }
.cal-week-num {
  width: 36px; height: 36px; border-radius: 10px;
  background: rgba(45,138,68,0.12); border: 1px solid rgba(45,138,68,0.25);
  display: grid; place-items: center;
  font-family: var(--ff-mono); font-size: 12px; color: var(--c-green-400);
  font-weight: 600; flex-shrink: 0;
}
.cal-week-info h4 {
  font-family: var(--ff-display); font-size: 17px; font-weight: 600;
  color: var(--c-text); margin-bottom: 2px;
}
.cal-week-info p { font-size: 11.5px; color: var(--c-text-3); letter-spacing: 0.02em; }
.cal-week-right { display: flex; align-items: center; gap: 10px; }
.cal-week-weather {
  font-size: 12px; color: var(--c-text-3); font-family: var(--ff-mono);
  background: rgba(255,255,255,0.04); padding: 5px 10px; border-radius: 8px;
  border: 1px solid var(--c-border);
}
.cal-week-chevron {
  font-size: 13px; color: var(--c-text-3);
  transition: transform 0.3s ease;
}
.cal-week-card.expanded .cal-week-chevron { transform: rotate(180deg); }

/* â”€â”€ Week Body (expandable) â”€â”€ */
.cal-week-body {
  max-height: 0; overflow: hidden;
  transition: max-height 0.5s cubic-bezier(0.4,0,0.2,1);
}
.cal-week-card.expanded .cal-week-body { max-height: 600px; }
.cal-week-inner { padding: 18px 20px 20px; }

.cal-week-sections { display: flex; flex-direction: column; gap: 14px; }
.cal-week-section {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 14px; border-radius: 14px;
  background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.05);
  transition: var(--transition);
}
.cal-week-section:hover { background: rgba(45,138,68,0.05); border-color: rgba(45,138,68,0.15); }
.cal-ws-icon { font-size: 18px; flex-shrink: 0; width: 28px; text-align: center; padding-top: 1px; }
.cal-ws-content { flex: 1; min-width: 0; }
.cal-ws-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.07em; color: var(--c-text-3); margin-bottom: 4px; font-weight: 600; }
.cal-ws-text { font-size: 13.5px; color: var(--c-text-2); line-height: 1.5; }
.cal-ws-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 7px; }
.cal-ws-tag {
  display: inline-block; padding: 2px 9px; border-radius: var(--r-full);
  font-size: 10.5px; font-weight: 500; letter-spacing: 0.04em;
  background: rgba(45,138,68,0.12); border: 1px solid rgba(45,138,68,0.22);
  color: var(--c-green-300);
}
.cal-ws-tag.warn { background: rgba(201,168,76,0.12); border-color: rgba(201,168,76,0.3); color: var(--c-gold-light); }
.cal-ws-tag.danger { background: rgba(224,82,82,0.12); border-color: rgba(224,82,82,0.25); color: #f08080; }

/* â”€â”€ Day Strip inside week â”€â”€ */
.cal-day-strip {
  display: grid; grid-template-columns: repeat(7, 1fr);
  gap: 5px; margin-top: 14px;
}
.cal-day-pip {
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  padding: 8px 4px; border-radius: 10px;
  background: rgba(0,0,0,0.2); border: 1px solid var(--c-border);
  font-size: 10px; cursor: default; transition: var(--transition);
}
.cal-day-pip:hover { background: rgba(45,138,68,0.07); border-color: rgba(45,138,68,0.25); }
.cal-day-pip .d-name { color: var(--c-text-3); text-transform: uppercase; letter-spacing: 0.04em; }
.cal-day-pip .d-rain { font-family: var(--ff-mono); color: var(--c-text-2); font-size: 10.5px; }
.cal-day-pip .d-tmp { font-family: var(--ff-mono); color: var(--c-green-300); font-size: 10.5px; }
.cal-day-pip .d-risk {
  width: 8px; height: 8px; border-radius: 50%; margin-top: 2px;
}
.d-risk.low    { background: var(--c-green-400); box-shadow: 0 0 5px var(--c-green-500); }
.d-risk.medium { background: var(--c-gold); box-shadow: 0 0 5px var(--c-gold); }
.d-risk.high   { background: var(--c-error); box-shadow: 0 0 5px var(--c-error); animation: blink 1s infinite; }

/* â”€â”€ Empty / loading states â”€â”€ */
.cal-placeholder {
  display: flex; flex-direction: column; align-items: center; gap: 14px;
  padding: 60px 24px; text-align: center; color: var(--c-text-3);
}
.cal-placeholder .ph-icon { font-size: 52px; opacity: 0.5; animation: iconBob 3.5s ease-in-out infinite; }
.cal-placeholder h3 { font-family: var(--ff-display); font-size: 22px; color: var(--c-text-2); font-weight: 500; }
.cal-placeholder p { font-size: 13px; max-width: 300px; }
.cal-loading {
  display: none; flex-direction: column; align-items: center; gap: 18px;
  padding: 60px 24px; text-align: center;
}
.cal-loading.visible { display: flex; }
.cal-loader {
  width: 52px; height: 52px; border-radius: 50%;
  border: 3px solid rgba(45,138,68,0.2);
  border-top-color: var(--c-green-400);
  animation: spin 0.9s linear infinite;
}
.cal-loading-text {
  font-family: var(--ff-mono); font-size: 13px; color: var(--c-green-400);
  letter-spacing: 0.04em; animation: calLoadPulse 1.5s ease-in-out infinite;
}
@keyframes calLoadPulse { 0%,100%{opacity:0.5;} 50%{opacity:1;} }

/* â”€â”€ Crop stage pill â”€â”€ */
.cal-stage-pill {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: var(--r-full);
  font-size: 11.5px; font-weight: 600; letter-spacing: 0.04em;
  background: rgba(201,168,76,0.12); border: 1px solid rgba(201,168,76,0.3);
  color: var(--c-gold-light);
}

@media (max-width: 759px) {
  .cal-form-grid { grid-template-columns: 1fr; }
  .cal-weather-banner.visible { flex-direction: column; gap: 14px; }
  .cal-day-strip { grid-template-columns: repeat(7, 1fr); gap: 3px; }
  .cal-body-inner { padding: 18px 14px 80px; }
  .cal-week-header { padding: 14px 16px; }
  .cal-week-inner { padding: 14px 16px; }
  .cal-weather-stats { gap: 8px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEALTH PASSPORT EXPORT BUTTON
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn-passport {
  display: flex; align-items: center; gap: 14px;
  width: 100%; padding: 16px 20px; margin-top: 14px;
  background: linear-gradient(135deg, #0a2e14 0%, #1a5c2a 60%, #2d8a44 100%);
  border: 1px solid rgba(94,203,116,0.35);
  border-radius: 18px; cursor: pointer;
  color: var(--c-text); font-family: var(--ff-body);
  box-shadow: 0 8px 28px rgba(0,0,0,0.4), 0 0 30px rgba(45,138,68,0.18), inset 0 1px 0 rgba(255,255,255,0.08);
  transition: transform 0.22s cubic-bezier(0.34,1.3,0.64,1), box-shadow 0.22s ease;
  position: relative; overflow: hidden;
}
.btn-passport::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(94,203,116,0.12) 0%, transparent 60%);
  opacity: 0; transition: opacity 0.3s ease;
}
.btn-passport:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 14px 40px rgba(0,0,0,0.5), 0 0 50px rgba(45,138,68,0.28), inset 0 1px 0 rgba(255,255,255,0.12); }
.btn-passport:hover::before { opacity: 1; }
.btn-passport:active { transform: scale(0.98); }
.btn-passport.passport-ready { animation: passportPop 0.55s cubic-bezier(0.34,1.4,0.64,1) both; }
@keyframes passportPop { from { opacity:0; transform:translateY(12px) scale(0.95); } to { opacity:1; transform:none; } }

.passport-btn-icon {
  font-size: 30px; flex-shrink: 0;
  filter: drop-shadow(0 2px 8px rgba(45,138,68,0.5));
}
.passport-btn-text { flex: 1; text-align: left; }
.passport-btn-title { display: block; font-size: 15px; font-weight: 600; color: var(--c-green-100); letter-spacing: 0.01em; }
.passport-btn-sub { display: block; font-size: 11.5px; color: var(--c-text-3); margin-top: 2px; }
.passport-btn-arrow { font-size: 20px; color: var(--c-green-300); flex-shrink: 0; font-weight: 300; }

/* Generating spinner state */
.btn-passport.generating { opacity: 0.7; pointer-events: none; }
.btn-passport.generating .passport-btn-title::after { content: ' â€¦'; animation: dotPulse 1s infinite; }
@keyframes dotPulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }


.metric-box{cursor:default;transition:border-color 0.25s,box-shadow 0.25s;}
.metric-box:hover{border-color:var(--c-green-500);box-shadow:0 0 22px rgba(45,138,68,0.18);}
.metric-tooltip{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(160deg,rgba(10,46,20,0.97),rgba(8,15,11,0.99));border-top:1px solid rgba(94,203,116,0.18);padding:9px 12px 10px;font-size:11px;line-height:1.5;color:var(--c-text-2);transform:translateY(100%);transition:transform 0.28s cubic-bezier(0.4,0,0.2,1);pointer-events:none;border-radius:0 0 var(--r-md) var(--r-md);}
.metric-box:hover .metric-tooltip{transform:translateY(0);}
.metric-tooltip strong{color:var(--c-green-300);display:block;font-size:10.5px;letter-spacing:0.05em;text-transform:uppercase;margin-bottom:2px;}

/* â•â•â•â• REDESIGNED RESULT ANALYSIS â•â•â•â• */
.ra-section{border-radius:16px;border:1px solid var(--c-border);background:rgba(255,255,255,0.03);overflow:hidden;margin-bottom:10px;transition:border-color 0.25s;}
.ra-section:hover{border-color:rgba(94,203,116,0.2);}
.ra-section-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:rgba(255,255,255,0.04);border-bottom:1px solid var(--c-border);}
.ra-icon{width:32px;height:32px;border-radius:9px;display:grid;place-items:center;font-size:15px;flex-shrink:0;}
.ra-icon.detect{background:rgba(94,203,116,0.15);}
.ra-icon.cause{background:rgba(240,168,48,0.15);}
.ra-icon.remedy{background:rgba(45,138,68,0.2);}
.ra-icon.govt{background:rgba(201,168,76,0.15);}
.ra-icon.prevent{background:rgba(224,82,82,0.12);}
.ra-icon.timing{background:rgba(100,180,255,0.12);}
.ra-icon.resources{background:rgba(150,100,255,0.12);}
.ra-section-title{font-size:11px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;color:var(--c-text-3);}
.ra-section-body{padding:14px 16px;}
.ra-value{font-size:15px;font-weight:600;color:var(--c-text);line-height:1.5;}
.ra-value.large{font-family:var(--ff-display);font-size:20px;}
.ra-sub{font-size:12px;color:var(--c-text-3);margin-top:4px;line-height:1.5;}
.ra-severity-bar{margin-top:10px;background:rgba(255,255,255,0.06);border-radius:99px;height:6px;overflow:hidden;}
.ra-severity-fill{height:100%;border-radius:99px;transition:width 1s cubic-bezier(0.4,0,0.2,1);background:linear-gradient(90deg,var(--c-green-500),var(--c-green-300));}
.ra-severity-fill.warn{background:linear-gradient(90deg,#e09020,#f0c030);}
.ra-severity-fill.danger{background:linear-gradient(90deg,#c03030,#e05050);}
.ra-list{list-style:none;display:flex;flex-direction:column;gap:7px;}
.ra-list li{display:flex;gap:10px;align-items:flex-start;font-size:13px;color:var(--c-text-2);line-height:1.5;}
.ra-list li::before{content:'â†’';color:var(--c-green-400);font-weight:700;flex-shrink:0;margin-top:1px;}
.ra-list.prevent li::before{content:'âœ•';color:#e05252;}
.ra-scheme-card{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2);border-radius:12px;}
.ra-scheme-name{font-size:13px;font-weight:600;color:var(--c-gold);}
.ra-scheme-link{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;color:#080f0b;background:var(--c-gold);border-radius:99px;padding:5px 12px;text-decoration:none;white-space:nowrap;}
.ra-weather-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.ra-weather-pill{display:flex;flex-direction:column;align-items:center;padding:8px 12px;border-radius:12px;min-width:60px;flex:1;background:rgba(255,255,255,0.04);border:1px solid var(--c-border);font-size:11px;color:var(--c-text-3);gap:3px;}
.ra-weather-pill .pill-val{font-family:var(--ff-mono);font-size:14px;font-weight:600;color:var(--c-green-300);}
.ra-spray-status{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:99px;font-size:12px;font-weight:700;margin-top:6px;}
.ra-spray-status.green{background:rgba(45,138,68,0.2);color:var(--c-green-300);border:1px solid rgba(45,138,68,0.3);}
.ra-spray-status.yellow{background:rgba(240,168,48,0.15);color:#f0c030;border:1px solid rgba(240,168,48,0.3);}
.ra-spray-status.red{background:rgba(224,82,82,0.12);color:#e05252;border:1px solid rgba(224,82,82,0.25);}
.ra-resource-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.ra-resource-btn{display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 8px;border-radius:14px;border:1px solid var(--c-border);background:rgba(255,255,255,0.04);font-family:var(--ff-body);cursor:pointer;color:var(--c-text-2);font-size:12px;font-weight:600;transition:all 0.22s;}
.ra-resource-btn:hover{border-color:var(--c-green-500);background:rgba(45,138,68,0.1);color:var(--c-text);}
.ra-resource-btn .rb-icon{font-size:22px;}
.ra-action-bar{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
.ra-share-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 10px;border-radius:16px;border:none;cursor:pointer;font-family:var(--ff-body);font-size:13px;font-weight:700;background:linear-gradient(135deg,#25D366,#128C7E);color:white;transition:transform 0.2s,box-shadow 0.2s;box-shadow:0 6px 20px rgba(37,211,102,0.25);}
.ra-share-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(37,211,102,0.35);}
.ra-no-scheme{font-size:12px;color:var(--c-text-3);font-style:italic;}
.scan-invalid-msg{display:none;align-items:center;gap:10px;padding:12px 16px;margin:8px 0;background:rgba(224,82,82,0.1);border:1px solid rgba(224,82,82,0.3);border-radius:14px;color:#e05252;font-size:13px;font-weight:600;}
.scan-invalid-msg.show{display:flex;}
/* 7-day weather dashboard */
#weatherDashboard{margin:16px 14px 0;padding-bottom:20px;}
.wd-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.wd-title{font-family:var(--ff-display);font-size:18px;font-weight:600;color:var(--c-text);}
.wd-location{font-size:11px;color:var(--c-text-3);display:flex;align-items:center;gap:4px;}
.wd-location a{color:var(--c-green-300);text-decoration:none;font-weight:600;}
.wd-today{display:flex;align-items:center;gap:16px;padding:18px;border-radius:20px;margin-bottom:14px;background:linear-gradient(135deg,rgba(10,46,20,0.8),rgba(20,80,35,0.6));border:1px solid rgba(94,203,116,0.2);position:relative;overflow:hidden;}
.wd-today-icon{font-size:52px;line-height:1;}
.wd-today-info{flex:1;}
.wd-today-temp{font-family:var(--ff-display);font-size:36px;font-weight:600;color:var(--c-text);line-height:1;}
.wd-today-desc{font-size:13px;color:var(--c-text-2);margin:4px 0;}
.wd-today-stats{display:flex;gap:14px;flex-wrap:wrap;margin-top:8px;}
.wd-stat{font-size:11px;color:var(--c-text-3);display:flex;align-items:center;gap:4px;}
.wd-stat span{color:var(--c-green-300);font-weight:600;font-family:var(--ff-mono);}
.wd-7day{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;scrollbar-width:none;}
.wd-7day::-webkit-scrollbar{display:none;}
.wd-day-card{flex:0 0 auto;width:70px;padding:12px 8px;border-radius:16px;border:1px solid var(--c-border);background:rgba(255,255,255,0.04);display:flex;flex-direction:column;align-items:center;gap:5px;text-align:center;transition:border-color 0.2s,background 0.2s;}
.wd-day-card:hover{border-color:var(--c-green-500);background:rgba(45,138,68,0.08);}
.wd-day-card.today-card{border-color:var(--c-green-400);background:rgba(45,138,68,0.12);}
.wd-day-name{font-size:11px;font-weight:700;color:var(--c-text-3);text-transform:uppercase;letter-spacing:0.04em;}
.wd-day-icon{font-size:22px;}
.wd-day-hi{font-size:14px;font-weight:700;color:var(--c-text);font-family:var(--ff-mono);}
.wd-day-lo{font-size:11px;color:var(--c-text-3);font-family:var(--ff-mono);}
.wd-day-rain{font-size:10px;color:#7ab8f5;}
.wd-loading{text-align:center;padding:30px;color:var(--c-text-3);font-size:13px;}
@media(max-width:480px){.ra-action-bar{grid-template-columns:1fr;}.wd-today{flex-direction:column;align-items:flex-start;}.wd-today-temp{font-size:28px;}}
</style> </head>
<body>

<!-- â•â•â• BACKGROUND ORBS â•â•â• -->
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div class="orb orb-3"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LANGUAGE SELECTOR OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="langOverlay">
  <div class="lang-card">
    <div class="lang-card-glow"></div>

    <div class="lang-brand">
      <div class="lang-logo">ğŸŒ¿</div>
      <div class="lang-brand-name">AgriUstaad</div>
    </div>
    <div class="lang-tagline">by Team AgriCore Â· Your intelligent farming companion</div>

    <div class="lang-heading">Select Your Language</div>

    <div class="lang-grid">
      <button class="lang-btn selected" data-lang="en" data-name="English" onclick="selectLang(this)">
        <div class="lang-check">âœ“</div>
        <div class="lang-native">English</div>
        <div class="lang-english">English</div>
      </button>
      <button class="lang-btn" data-lang="hi" data-name="Hindi" onclick="selectLang(this)">
        <div class="lang-check">âœ“</div>
        <div class="lang-native">à¤¹à¤¿à¤‚à¤¦à¥€</div>
        <div class="lang-english">Hindi</div>
      </button>
      <button class="lang-btn" data-lang="or" data-name="Odia" onclick="selectLang(this)">
        <div class="lang-check">âœ“</div>
        <div class="lang-native">à¬“à¬¡à¬¼à¬¿à¬†</div>
        <div class="lang-english">Odia</div>
      </button>
      <button class="lang-btn" data-lang="te" data-name="Telugu" onclick="selectLang(this)">
        <div class="lang-check">âœ“</div>
        <div class="lang-native">à°¤à±†à°²à±à°—à±</div>
        <div class="lang-english">Telugu</div>
      </button>
      <button class="lang-btn" data-lang="ta" data-name="Tamil" onclick="selectLang(this)">
        <div class="lang-check">âœ“</div>
        <div class="lang-native">à®¤à®®à®¿à®´à¯</div>
        <div class="lang-english">Tamil</div>
      </button>
      <button class="lang-btn" data-lang="pa" data-name="Punjabi" onclick="selectLang(this)">
        <div class="lang-check">âœ“</div>
        <div class="lang-native">à¨ªà©°à¨œà¨¾à¨¬à©€</div>
        <div class="lang-english">Punjabi</div>
      </button>
    </div>


    <button class="lang-enter-btn" id="enterBtn" onclick="enterApp()">
      Enter AgriUstaad â†’
    </button>
    <div class="lang-status" id="langStatus"></div>
  </div>
</div>

<!-- â•â•â• FLASH OVERLAY â•â•â• -->
<div id="flashOverlay"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN APP (blurred behind language screen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- â•â•â•â• SMART CULTIVATION CALENDAR PANEL â€” outside appWrapper so fixed pos works â•â•â•â• -->
  <div id="calendarPanel">
    <!-- Nav Bar -->
    <div class="cal-nav">
      <div class="cal-nav-title">
        <div class="cal-nav-icon">ğŸ—“ï¸</div>
        <span>Smart Cultivation Calendar</span>
      </div>
      <button class="cal-close-btn" onclick="closeCalendar()">â† Back to App</button>
    </div>

    <!-- Floating orbs for green gloss background -->
    <div class="cal-orb cal-orb-1"></div>
    <div class="cal-orb cal-orb-2"></div>
    <div class="cal-orb cal-orb-3"></div>

    <!-- Scrollable Body (edge-to-edge scroll zone) -->
    <div class="cal-body" id="calBody">
      <div class="cal-body-inner">

      <!-- Setup Card -->
      <div class="cal-setup">
        <div class="cal-setup-title">ğŸŒ± Setup Your Calendar</div>
        <div class="cal-form-grid">
          <div class="cal-field">
            <label class="cal-label">Crop Type</label>
            <select class="cal-select" id="calCrop">
              <option value="">â€” Select Crop â€”</option>
              <option value="rice">ğŸŒ¾ Rice / Paddy</option>
              <option value="wheat">ğŸŒ¿ Wheat</option>
              <option value="tomato">ğŸ… Tomato</option>
              <option value="cotton">ğŸŒ¸ Cotton</option>
              <option value="maize">ğŸŒ½ Maize / Corn</option>
              <option value="soybean">ğŸ«˜ Soybean</option>
              <option value="potato">ğŸ¥” Potato</option>
              <option value="onion">ğŸ§… Onion</option>
              <option value="sugarcane">ğŸ‹ Sugarcane</option>
              <option value="groundnut">ğŸ¥œ Groundnut</option>
            </select>
          </div>
          <div class="cal-field">
            <label class="cal-label">Sowing Date</label>
            <input type="date" class="cal-input" id="calSowDate">
          </div>
          <div class="cal-field">
            <label class="cal-label">Location (City or Lat,Lon)</label>
            <div class="cal-location-row">
              <input type="text" class="cal-input" id="calLocation" placeholder="e.g. Bhubaneswar">
              <button class="cal-detect-btn" id="calDetectBtn" onclick="detectCalLocation()">ğŸ“ Auto</button>
            </div>
          </div>
        </div>
        <button class="cal-generate-btn" id="calGenerateBtn" onclick="generateCalendar()">
          <span>ğŸš€</span> <span id="calGenBtnText">Generate My Calendar</span>
        </button>
      </div>

      <!-- Loading Spinner -->
      <div class="cal-loading" id="calLoading">
        <div class="cal-loader"></div>
        <div class="cal-loading-text" id="calLoadText">Fetching weather dataâ€¦</div>
      </div>

      <!-- Placeholder (initial state) -->
      <div class="cal-placeholder" id="calPlaceholder">
        <div class="ph-icon">ğŸ—“ï¸</div>
        <h3>Your Intelligent Farm Calendar</h3>
        <p>Select your crop, sowing date, and location above to generate a weather-integrated cultivation plan with real-time disease risk alerts.</p>
      </div>

      <!-- Dynamic Content (hidden until generated) -->
      <div id="calDynamicContent" style="display:none;">

        <!-- Weather Banner -->
        <div class="cal-weather-banner" id="calWeatherBanner">
          <div class="cal-weather-main">
            <div class="cal-weather-icon" id="calWxIcon">ğŸŒ¤ï¸</div>
            <div class="cal-weather-info">
              <h3 id="calWxTemp">--Â°C</h3>
              <p id="calWxDesc">Loading weatherâ€¦</p>
            </div>
          </div>
          <div class="cal-weather-stats">
            <div class="cal-weather-stat">
              <div class="val" id="calWxHum">--%</div>
              <div class="lbl">Humidity</div>
            </div>
            <div class="cal-weather-stat">
              <div class="val" id="calWxRain">--mm</div>
              <div class="lbl">Rainfall</div>
            </div>
            <div class="cal-weather-stat">
              <div class="val" id="calWxMin">--Â°C</div>
              <div class="lbl">Min Temp</div>
            </div>
            <div class="cal-weather-stat">
              <div class="val" id="calWxMax">--Â°C</div>
              <div class="lbl">Max Temp</div>
            </div>
          </div>
        </div>

        <!-- Overall Risk Banner -->
        <div class="cal-risk-banner" id="calRiskBanner">
          <div class="risk-icon" id="calRiskIcon">âš ï¸</div>
          <div style="flex:1">
            <div class="risk-title" id="calRiskTitle">Risk Level</div>
            <div class="risk-desc" id="calRiskDesc">Calculatingâ€¦</div>
          </div>
          <div class="risk-badge" id="calRiskBadge"><span class="risk-dot" id="calRiskDot"></span> <span id="calRiskBadgeText">â€”</span></div>
        </div>

        <!-- AI Insight -->
        <div class="cal-ai-card" id="calAiCard">
          <div class="cal-ai-header">
            <div class="cal-ai-orb">ğŸ¤–</div>
            <div>
              <div class="cal-ai-label">AI Cultivation Intelligence</div>
            </div>
          </div>
          <div class="cal-ai-text" id="calAiText">Generating AI analysisâ€¦</div>
          <div class="cal-prob-row" id="calProbRow"></div>
        </div>

        <!-- Weekly View -->
        <div class="cal-weeks-title">
          ğŸ“† 4-Week Field Schedule <span id="calWeekSubtitle"></span>
        </div>
        <div class="cal-weeks-grid" id="calWeeksGrid"></div>

      </div><!-- /calDynamicContent -->
      </div><!-- /cal-body-inner -->
    </div><!-- /cal-body -->
  </div><!-- /calendarPanel -->

<div id="appWrapper">

  <!-- Language change bar (hidden â€” button moved to nav) -->
  <div class="lang-bar" id="langBar" style="display:none;">
    <span class="lang-bar-label" data-i18n="langBarLabel">Language:</span>
    <button class="lang-bar-btn" id="langBarBtn" onclick="resetLanguage()">
      ğŸŒ <span id="langBarName">English</span> Â· Change
    </button>
  </div>

  <!-- Community Radar â€” toast popup (auto-shows on open, auto-dismisses) -->
  <div class="radar-banner" id="radarToast">
    <div class="radar-pulse"></div>
    <span data-i18n="radarBanner"><b>Community Radar:</b> 3 cases of "Leaf Blast" detected within 5km today.</span>
  </div>

  <nav class="glass-nav">
    <a class="nav-brand" href="/">
      <span class="logo-icon">ğŸŒ¿</span>
      AgriUstaad
    </a>
    <div class="nav-right">
      <button class="btn-back" id="btnBack" onclick="goBack()">â† <span data-i18n="back">Back</span></button>
      <button class="lang-bar-btn" id="langNavBtn" onclick="resetLanguage()" style="display:none;">
        ğŸŒ <span id="langNavName">English</span> Â· Change
      </button>
      <button class="nav-link" id="calNavBtn" onclick="openCalendar()" style="border:none;cursor:pointer;"><span>ğŸ—“ï¸</span> <span data-i18n="calNav">Calendar</span></button>
      <!-- Notification Bell -->
      <button class="nav-notif-btn" id="navNotifBtn" onclick="toggleNotifPanel()" aria-label="Notifications">
        <span class="notif-bell">ğŸ””</span>
        <span class="notif-badge" id="notifBadge">3</span>
      </button>
      <button class="nav-auth-btn" id="navAuthBtn" onclick="openAuthPanel()"><span id="navAuthIcon">ğŸ‘¤</span><span id="navAuthLabel">Login</span></button>
    </div>
  </nav>

  <div class="mandi-ticker">
    <div class="ticker-track">
      <span class="ticker-item">ğŸŸ¢ Paddy (Common): â‚¹2,369/qtl (Karanjia)</span>
      <span class="ticker-item">ğŸ”´ Tomato: â‚¹1,800/qtl (Cuttack)</span>
      <span class="ticker-item">ğŸŸ¢ Rice: â‚¹3,550/qtl (Mayurbhanj)</span>
      <span class="ticker-item">ğŸŸ¢ Onion: â‚¹2,500/qtl (Bhubaneswar)</span>
      <span class="ticker-item">ğŸ”´ Potato: â‚¹1,400/qtl (Balasore)</span>
      <span class="ticker-item">ğŸŸ¢ Green Gram: â‚¹8,550/qtl (Bargarh)</span>
      
      <span class="ticker-item">ğŸŸ¢ Paddy (Common): â‚¹2,369/qtl (Karanjia)</span>
      <span class="ticker-item">ğŸ”´ Tomato: â‚¹1,800/qtl (Cuttack)</span>
      <span class="ticker-item">ğŸŸ¢ Rice: â‚¹3,550/qtl (Mayurbhanj)</span>
      <span class="ticker-item">ğŸŸ¢ Onion: â‚¹2,500/qtl (Bhubaneswar)</span>
      <span class="ticker-item">ğŸ”´ Potato: â‚¹1,400/qtl (Balasore)</span>
      <span class="ticker-item">ğŸŸ¢ Green Gram: â‚¹8,550/qtl (Bargarh)</span>
    </div>
  </div>

  <main id="mainGrid">

    <!-- â•â•â•â• HERO LANDING SECTION â•â•â•â• -->
    <div class="hero-section" id="heroSection">
      <div class="hero-badge"><span class="dot"></span> <span data-i18n="heroBadge">Hacknovation 2.0 Â· Team AgriCore</span></div>
      <h1 class="hero-title">Agri<span class="green">Ustaad</span></h1>
      <div class="hero-subtitle-team" data-i18n="heroSubteam">by Team AgriCore</div>
      <p class="hero-desc" data-i18n="heroDesc">
        An AI-powered super app for Indian farmers â€” diagnose crop diseases, estimate yields, analyse soil health, and get real-time advisory in your own language. Built for the field, by people who care about it.
      </p>
      <div class="hero-stats">
        <div class="hero-stat">
          <div class="hero-stat-val">5+</div>
          <div class="hero-stat-label" data-i18n="statLang">Languages</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-val">4</div>
          <div class="hero-stat-label" data-i18n="statModes">AI Scan Modes</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-val" data-i18n="statWeatherVal">Real-time</div>
          <div class="hero-stat-label" data-i18n="statWeather">Weather Advisory</div>
        </div>
        <div class="hero-stat">
          <div class="hero-stat-val" data-i18n="statFreeVal">Free</div>
          <div class="hero-stat-label" data-i18n="statFree">For Every Farmer</div>
        </div>
      </div>

      <a href="#featuresSection" class="hero-scroll-btn" title="Scroll Down">â†“</a>
      
    </div>

    <!-- â•â•â•â• FEATURES SECTION â•â•â•â• -->
    <div class="features-section" id="featuresSection">
      <div class="features-heading">
        <h2 data-i18n="featHeading">What AgriUstaad Can Do</h2>
        <p data-i18n="featSub">Powerful AI tools designed for real farm conditions</p>
      </div>
      <div class="features-grid">
        <div class="feat-card">
          <div class="feat-icon">ğŸŒ¿</div>
          <div class="feat-title" data-i18n="feat1Title">Disease Detection</div>
          <div class="feat-desc" data-i18n="feat1Desc">Photograph any crop and get an instant AI diagnosis â€” disease name, severity score, and treatment advice in seconds.</div>
          <span class="feat-tag" data-i18n="feat1Tag">AI Vision</span>
        </div>
        <div class="feat-card">
          <div class="feat-icon">ğŸ‡</div>
          <div class="feat-title" data-i18n="feat2Title">Yield Estimator</div>
          <div class="feat-desc" data-i18n="feat2Desc">Know your harvest readiness and get smart market advice before you cut â€” so you sell at the right time, at the right price.</div>
          <span class="feat-tag" data-i18n="feat2Tag">Harvest AI</span>
        </div>
        <div class="feat-card">
          <div class="feat-icon">ğŸŸ¤</div>
          <div class="feat-title" data-i18n="feat3Title">Soil Analysis</div>
          <div class="feat-desc" data-i18n="feat3Desc">Understand your soil type, moisture levels, and get personalised treatment plans to improve your field's health.</div>
          <span class="feat-tag" data-i18n="feat3Tag">Soil Intel</span>
        </div>
        <div class="feat-card">
          <div class="feat-icon">ğŸ“¦</div>
          <div class="feat-title" data-i18n="feat4Title">Crate Inspector</div>
          <div class="feat-desc" data-i18n="feat4Desc">Scan produce crates for quality grading â€” perfect for supply chain decisions and post-harvest management.</div>
          <span class="feat-tag" data-i18n="feat4Tag">Quality AI</span>
        </div>
        <div class="feat-card">
          <div class="feat-icon">ğŸŒ¤ï¸</div>
          <div class="feat-title" data-i18n="feat5Title">Weather Advisory</div>
          <div class="feat-desc" data-i18n="feat5Desc">Hyperlocal weather insights tied to your GPS location, with actionable farming guidance for the week ahead.</div>
          <span class="feat-tag" data-i18n="feat5Tag">Live Data</span>
        </div>
        <div class="feat-card">
          <div class="feat-icon">ğŸ¤–</div>
          <div class="feat-title" data-i18n="feat6Title">AI Ustaad Chat</div>
          <div class="feat-desc" data-i18n="feat6Desc">Ask anything, anytime. Your AI Ustaad is available 24/7 to answer questions about crops, pests, and farming practices.</div>
          <span class="feat-tag" data-i18n="feat6Tag">Always On</span>
        </div>
      </div>
    </div>

    <!-- â•â•â•â• TRY IT DIVIDER â•â•â•â• -->
    <div class="try-divider">
      <h3 data-i18n="tryTitle">Ready to Scan Your Field?</h3>
      <p>Just drop a photo â€” AI automatically detects what it is and runs the right analysis</p>
      <div class="try-arrow">â†“</div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         UNIFIED COMMAND DECK â€” Macro-to-Micro Toggle
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="commandDeck">

      <!-- â”€â”€ Deck Header: Toggle + Status â”€â”€ -->
      <div id="deckHeader">
        <!-- Hidden title elements kept for JS compatibility -->
        <div class="deck-titles" style="display:none;">
          <div class="deck-title-main" id="deckTitleMain">ğŸ”¬ AI Field Scanner</div>
          <div class="deck-title-sub" id="deckTitleSub">Select a tool to begin analysis</div>
        </div>

        <!-- Diagnosis match badge (shows when result exists) -->
        <div class="deck-diag-badge" id="deckDiagBadge">
          <span>âœ“</span><span id="deckDiagLabel">Scan Complete</span>
        </div>
        <!-- Live badge (macro mode) -->
        <div class="deck-live-badge" id="deckLiveBadge" style="display:none;">
          <div class="deck-live-dot"></div> LIVE RADAR
        </div>
        <!-- Toggle Pill â€” centered -->
        <div class="deck-toggle-pill" id="deckTogglePill">
          <div class="deck-toggle-track" id="deckTrack"></div>
          <button class="deck-toggle-btn active" id="btnMicro" onclick="activateMicroView()">
            <span class="btn-emoji">ğŸ”¬</span> Field Scanner
          </button>
          <button class="deck-toggle-btn" id="btnMacro" onclick="activateMacroView()">
            <span class="btn-emoji">ğŸŒ</span> Community Radar
          </button>
        </div>
      </div>

      <!-- â”€â”€ Diagnosis Match Banner (shown in macro mode when scan result exists) â”€â”€ -->
      <div id="diagMatchBanner">
        <div class="dmb-pulse"></div>
        <span id="diagMatchText">Your last scan matches <b>3 nearby community reports</b> within 5 km â€” tap a cluster for details.</span>
      </div>

      <!-- â”€â”€ MICRO PANEL â€” AI Scanner â”€â”€ -->
      <div id="panelContainer">
      <div id="microPanel">

        <!-- â•â•â•â• SCAN CARD â•â•â•â• -->
        <section class="card slide-up" id="scanCard">
          <!-- Hero Scanner Header -->
          <div class="scanner-hero-header">
            <div class="scanner-hero-icon-wrap">
              <div class="scanner-hero-icon" id="scannerHeroIcon">ğŸ”¬</div>
              <div class="scanner-pulse-ring"></div>
            </div>
            <div class="scanner-hero-text">
              <h2 class="scanner-hero-title" data-i18n="scanTitle">AI Field Scanner</h2>
              <p class="scanner-hero-sub" id="scannerStatusText">Drop an image â€” AI will automatically detect what it is</p>
            </div>
          </div>

          <!-- AI Classification Badge (hidden until image is loaded) -->
          <div class="ai-classify-badge" id="aiClassifyBadge" style="display:none;">
            <div class="acb-spinner" id="acbSpinner"></div>
            <div class="acb-content" id="acbContent" style="display:none;">
              <span class="acb-icon" id="acbIcon">ğŸŒ¿</span>
              <div class="acb-info">
                <span class="acb-label">AI Detected</span>
                <span class="acb-category" id="acbCategory">Crop Disease</span>
              </div>
              <div class="acb-confidence" id="acbConfidence">
                <span class="acb-conf-val" id="acbConfVal">97%</span>
                <span class="acb-conf-lbl">confidence</span>
              </div>
              <button class="acb-change-btn" onclick="toggleManualOverride()" title="Override AI detection">âš™</button>
            </div>
            <div class="acb-thinking" id="acbThinking">
              <div class="acb-think-dots"><span></span><span></span><span></span></div>
              <span>AI is classifying your imageâ€¦</span>
            </div>
          </div>

          <!-- Manual Override (collapsed by default) -->
          <div class="manual-override" id="manualOverride" style="display:none;">
            <div class="mo-label">Manual Override</div>
            <div class="mode-grid">
              <button class="mode-btn" onclick="setModeManual('field',this)">
                <div class="bg-layer"></div>
                <span class="emoji">ğŸŒ¿</span><span class="label">Disease</span>
              </button>
              <button class="mode-btn" onclick="setModeManual('yield',this)">
                <div class="bg-layer"></div>
                <span class="emoji">ğŸ‡</span><span class="label">Yield</span>
              </button>
              <button class="mode-btn" onclick="setModeManual('soil',this)">
                <div class="bg-layer"></div>
                <span class="emoji">ğŸŸ¤</span><span class="label">Soil</span>
              </button>
              <button class="mode-btn" onclick="setModeManual('crate',this)">
                <div class="bg-layer"></div>
                <span class="emoji">ğŸ“¦</span><span class="label">Crate</span>
              </button>
            </div>
          </div>

          <!-- Hero Upload Zone -->
          <div class="upload-zone hero-upload-zone" id="uploadZone"
               onclick="document.getElementById('fileIn').click()"
               ondragover="handleDragOver(event)"
               ondragleave="handleDragLeave(event)"
               ondrop="handleDrop(event)">
            <input type="file" id="fileIn" hidden accept="image/*" onchange="previewFile(this.files[0])">
            <input type="file" id="cameraIn" hidden accept="image/*" capture="environment" onchange="previewFile(this.files[0])">
            <div id="uploadContent">
              <div class="hero-upload-bg-rings">
                <div class="ring-1"></div>
                <div class="ring-2"></div>
                <div class="ring-3"></div>
              </div>
              <div class="upload-icon hero-cam-icon">ğŸ“¸</div>
              <h3 data-i18n="uploadTitle">Drop Your Field Photo</h3>
              <p>Disease Â· Yield Â· Soil Â· Crate â€” AI will figure it out</p>
              <span class="upload-hint">â†‘ Tap or drop image here â†‘</span>
            </div>
            <img id="preview" class="preview-img" alt="Field preview" />
            <!-- Overlay badge shown on top of preview -->
            <div class="preview-overlay" id="previewOverlay" style="display:none;">
              <div class="po-ai-badge">
                <div class="po-spinner" id="poSpinner"></div>
                <span id="poStatusText">Classifyingâ€¦</span>
              </div>
            </div>
          </div>

          <!-- Action Buttons Row -->
          <div class="upload-actions">
            <button class="btn-upload-action" onclick="event.stopPropagation();document.getElementById('cameraIn').click()">ğŸ“· <span data-i18n="camera">Camera</span></button>
            <button class="btn-voice btn-voice-compact" id="voiceBtn" onclick="startVoiceScan()">ğŸ¤</button>
          </div>

          <div id="scanInvalidMsg" class="scan-invalid-msg"><span style="font-size:20px;flex-shrink:0">ğŸŒ¿</span><span>Please scan a valid plant or crop image.</span></div>
          <div class="error-box" id="scanError">
            <span class="icon">âš ï¸</span>
            <div>
              <div class="error-title" data-i18n="errTitle">Analysis Failed</div>
              <div class="error-msg" id="scanErrorMsg">Something went wrong.</div>
            </div>
            <button class="error-dismiss" onclick="dismissError('scanError')">âœ•</button>
          </div>

          <div class="progress-wrap" id="progressWrap">
            <div class="progress-label" id="progressLabel" data-i18n="uploading">Uploading imageâ€¦</div>
            <div class="progress-track"><div class="progress-bar" id="progressBar"></div></div>
          </div>

          <input type="hidden" id="lat" value="20.296">
          <input type="hidden" id="lon" value="85.824">

          <button class="btn-primary btn-analyze-hero" id="btnAnalyze" onclick="runAnalysis()" disabled>
            <span class="btn-analyze-icon" id="btnAnalyzeIcon">ğŸ“·</span>
            &nbsp;<span id="btnAnalyzeText">Upload a photo to begin</span>
          </button>
        </section>

        <!-- â•â•â•â• RESULT CARD â•â•â•â• -->
        <section class="card" id="resultCard" style="display:none;">
          
          <div class="skeleton-screen" id="skelScreen">
            <div class="result-header" style="margin-bottom: 8px;">
              <div>
                <h2 style="color: var(--c-text-2);" data-i18n="skelAnalyzing">AI is Analyzing...</h2>
                <div class="skel" style="width: 110px; height: 16px; margin-top: 8px; border-radius: 20px;"></div>
              </div>
              <div class="skel" style="width: 38px; height: 38px; border-radius: 50%;"></div>
            </div>
            <div class="skel-metrics"><div class="skel skel-metric"></div><div class="skel skel-metric"></div></div>
            <div class="skel skel-row"></div><div class="skel skel-block"></div>
            <div class="skel skel-half"></div><div class="skel skel-short"></div>
          </div>

          <div id="resultContent" style="display:none;">
            <div class="result-morph-header" id="resultMorphHeader">
              <div class="rmh-icon mode-disease" id="rmhIcon">ğŸ¦ </div>
              <div style="flex:1">
                <div class="rmh-label mode-disease" id="rmhLabel">Disease Analysis</div>
                <h2 data-i18n="diagTitle" style="font-family:var(--ff-display);font-size:22px;font-weight:600;color:var(--c-text);line-height:1.2;">Diagnosis Complete</h2>
                <div style="margin-top:4px;">
                  <span class="auto-detect-pill" id="autoDetectPill">âœ¦ Auto-detected</span>
                  <span class="badge-success" data-i18n="aiVerified" style="margin-left:6px;">AI Verified</span>
                </div>
              </div>
              <button onclick="location.reload()" class="btn-icon" title="New scan" style="margin-left:auto;flex-shrink:0;">ğŸ”„</button>
            </div>

            <div class="metrics-grid" id="metricsRow">
              <div class="metric-box">
                <div class="ring-wrap">
                  <svg width="72" height="72" viewBox="0 0 72 72" style="transform:rotate(-90deg)">
                    <circle class="ring-bg" cx="36" cy="36" r="28"/>
                    <circle class="ring-fill" cx="36" cy="36" r="28" id="ecoRing" style="stroke-dasharray:176;stroke-dashoffset:176;"/>
                  </svg>
                  <div class="ring-val" id="scoreEco">--</div>
                </div>
                <span class="metric-label" data-i18n="ecoScore">Eco Score ğŸŒ</span>
                <div class="metric-tooltip"><strong>Eco Score</strong>How environmentally safe this treatment is (0â€“10). Higher = less harm to soil &amp; insects.</div>
              </div>
              <div class="metric-box">
                <div class="ring-wrap">
                  <svg width="72" height="72" viewBox="0 0 72 72" style="transform:rotate(-90deg)">
                    <circle class="ring-bg" cx="36" cy="36" r="28"/>
                    <circle class="ring-fill roi-ring" cx="36" cy="36" r="28" id="roiRing" style="stroke-dasharray:176;stroke-dashoffset:176;"/>
                  </svg>
                  <div class="ring-val roi-val" id="scoreRoi">--</div>
                </div>
                <span class="metric-label" data-i18n="roiEst">ROI Est. ğŸ’°</span>
                <div class="metric-tooltip"><strong>ROI Estimate</strong>"High" means early treatment saves significant crop value &amp; prevents yield loss.</div>
              </div>
            </div>

            <!-- 1. DETECTION -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon detect">ğŸ”¬</div><div class="ra-section-title">1 Â· Detection</div></div>
              <div class="ra-section-body">
                <div class="ra-value large" id="ra-disease-name">â€”</div>
                <div class="ra-sub" id="ra-confidence-text"></div>
                <div class="ra-severity-bar" id="ra-sev-bar-wrap"><div class="ra-severity-fill" id="ra-sev-fill" style="width:0%"></div></div>
                <div class="ra-sub" id="ra-severity-label" style="margin-top:5px;"></div>
              </div>
            </div>
            <!-- 2. EXPECTED CAUSE -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon cause">ğŸ§¬</div><div class="ra-section-title">2 Â· Expected Cause</div></div>
              <div class="ra-section-body"><div class="ra-value" id="ra-cause-text">â€”</div></div>
            </div>
            <!-- 3. REMEDIES -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon remedy">ğŸ’Š</div><div class="ra-section-title">3 Â· Remedies â€” What to Do</div></div>
              <div class="ra-section-body"><ul class="ra-list" id="ra-remedy-list"></ul></div>
            </div>
            <!-- 4. GOVT SCHEMES -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon govt">ğŸ›ï¸</div><div class="ra-section-title">4 Â· Related Government Schemes</div></div>
              <div class="ra-section-body" id="ra-govt-body"><p class="ra-no-scheme">No specific scheme linked to this diagnosis.</p></div>
            </div>
            <!-- 5. PREVENTION -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon prevent">ğŸš«</div><div class="ra-section-title">5 Â· Prevention â€” What Not to Do</div></div>
              <div class="ra-section-body"><ul class="ra-list prevent" id="ra-prevent-list"></ul></div>
            </div>
            <!-- 6. WHEN TO ACT -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon timing">â°</div><div class="ra-section-title">6 Â· When to Act</div></div>
              <div class="ra-section-body">
                <div class="ra-weather-row" id="ra-wx-pills"></div>
                <div id="ra-spray-badge" class="ra-spray-status green">âœ… Conditions safe for spraying</div>
                <div class="ra-sub" id="ra-wx-reason" style="margin-top:8px;"></div>
              </div>
            </div>
            <!-- 7. RESOURCES -->
            <div class="ra-section">
              <div class="ra-section-header"><div class="ra-icon resources">ğŸ›’</div><div class="ra-section-title">7 Â· Where to Get Resources</div></div>
              <div class="ra-section-body">
                <div class="ra-resource-grid">
                  <button class="ra-resource-btn" onclick="openModal('shop')"><span class="rb-icon">ğŸ’Š</span><span>Buy Medicine</span></button>
                  <button class="ra-resource-btn" onclick="openModal('sprayer')"><span class="rb-icon">ğŸšœ</span><span>Rent Sprayer</span></button>
                </div>
              </div>
            </div>
            <!-- 8+9. DOWNLOAD + SHARE -->
            <div class="ra-action-bar">
              <button id="exportPassportBtn" onclick="exportHealthPassport()" class="btn-passport" style="display:none;margin:0;" aria-label="Export Health Passport">
                <span style="font-size:20px;">ğŸ¥</span>
                <div style="flex:1;text-align:left;">
                  <span style="display:block;font-size:13px;font-weight:700;">Download PDF</span>
                  <span style="display:block;font-size:10px;color:var(--c-text-3);">Health Passport</span>
                </div>
              </button>
              <button class="ra-share-btn" onclick="shareReport()">
                <span style="font-size:18px;">ğŸ’¬</span><span data-i18n="shareWhatsapp">Share via WhatsApp</span>
              </button>
            </div>

            <!-- hidden legacy elements kept for JS compatibility -->
            <a id="pdfLink" href="#" target="_blank" style="display:none;"></a>
            <div id="diagCards" style="display:none;"></div>
            <div id="emptyState" style="display:none;"></div>
            <div id="resBody" style="display:none;"></div>
            <div id="subsidyBox" style="display:none;"><span id="subsidyName"></span><a id="schemeLink" href="#" target="_blank"></a></div>
            <div id="weatherBox" style="display:none;"><span id="weatherText"></span></div>
            <div id="marketGrid" style="display:none;"></div>
          </div></section>

      </div><!-- /#microPanel -->

      <!-- â”€â”€ MACRO PANEL â€” Community Disease Radar â”€â”€ -->
      <div id="macroPanel">

        <!-- Leaflet Map -->
        <div id="communityMap"></div>

        <!-- 7-Day Weather Dashboard -->
        <div id="weatherDashboard">
          <div class="wd-header">
            <div class="wd-title">ğŸŒ¦ï¸ Live Weather Forecast</div>
            <div class="wd-location"><span id="wd-loc-text">Detecting locationâ€¦</span>&nbsp;<a id="wd-maps-link" href="#" target="_blank">ğŸ“</a></div>
          </div>
          <div class="wd-today" id="wd-today">
            <div class="wd-today-icon" id="wd-today-icon">ğŸŒ¤ï¸</div>
            <div class="wd-today-info">
              <div class="wd-today-temp" id="wd-today-temp">--Â°C</div>
              <div class="wd-today-desc" id="wd-today-desc">Loading forecastâ€¦</div>
              <div class="wd-today-stats">
                <div class="wd-stat">ğŸ’§ Humidity <span id="wd-hum">--%</span></div>
                <div class="wd-stat">ğŸŒ§ Rain <span id="wd-rain">--mm</span></div>
                <div class="wd-stat">ğŸ’¨ Wind <span id="wd-wind">--km/h</span></div>
                <div class="wd-stat">â˜€ï¸ UV <span id="wd-uv">--</span></div>
              </div>
            </div>
          </div>
          <div class="wd-7day" id="wd-7day"><div class="wd-loading">Loading 7-day forecastâ€¦</div></div>
        </div>
        <!-- AI Logic Box -->
        <div id="aiLogicBox">
          <div class="logic-left">
            <div class="logic-header">
              <div class="logic-orb">ğŸ¤–</div>
              <div class="logic-label">AI Community Intelligence</div>
            </div>
            <div class="logic-text" id="logicMainText">
              Analysing 847 field reports across the region. <b>3 active disease clusters</b> identified within 50km of your location. Conditions remain elevated for fungal spread in the next 48 hours.
            </div>
            <div class="logic-alerts" id="logicAlerts">
              <div class="logic-alert-row">
                <span class="alert-ico">ğŸ”´</span>
                <div class="alert-txt"><b>Leaf Blast (Pyricularia):</b> 3 new cases within 5km today. High humidity (88%) driving rapid spread.</div>
              </div>
              <div class="logic-alert-row">
                <span class="alert-ico">ğŸŸ¡</span>
                <div class="alert-txt"><b>Brown Plant Hopper:</b> 7 reports in Mayurbhanj district. Escalating â€” threshold reached in 2 blocks.</div>
              </div>
              <div class="logic-alert-row">
                <span class="alert-ico">ğŸŸ¢</span>
                <div class="alert-txt"><b>Early Blight (Tomato):</b> Stable. 2 cases in Cuttack area. No new reports in last 24 hours.</div>
              </div>
            </div>
          </div>
          <div class="logic-stats">
            <div class="logic-stat-box">
              <div class="logic-stat-val red" id="lsActiveThreats">3</div>
              <div class="logic-stat-lbl">Active Threats</div>
            </div>
            <div class="logic-stat-box">
              <div class="logic-stat-val amber" id="lsNearbyReports">12</div>
              <div class="logic-stat-lbl">50km Reports</div>
            </div>
            <div class="logic-stat-box">
              <div class="logic-stat-val" id="lsFarmersAlerted">847</div>
              <div class="logic-stat-lbl">Farmers Alerted</div>
            </div>
            <div class="logic-stat-box">
              <div class="logic-stat-val amber" id="lsRiskScore">62%</div>
              <div class="logic-stat-lbl">Regional Risk</div>
            </div>
          </div>
        </div>

      </div><!-- /#macroPanel -->
      </div><!-- /#panelContainer -->

    </div><!-- /#commandDeck -->

  </main>

  

  <div class="modal-backdrop" id="mockModal" onclick="closeModal(event)">
    <div class="modal-card">
      <h3 id="modalTitle">Services</h3>
      <div class="list-group">
        <div class="list-item">
          <div class="item-info">
            <b>Ramesh Drone Service</b>
            <span>ğŸ“ 2km away Â· â‚¹400/acre</span>
          </div>
          <button class="btn-sm" data-i18n="book">BOOK</button>
        </div>
        <div class="list-item">
          <div class="item-info">
            <b>Suresh Manual Spray</b>
            <span>ğŸ“ 1.5km away Â· â‚¹150/hr</span>
          </div>
          <button class="btn-sm" data-i18n="call">CALL</button>
        </div>
      </div>
      <button class="btn-text" onclick="document.getElementById('mockModal').style.display='none'" data-i18n="close">Close</button>
    </div>
  </div>

  <!-- â•â•â•â• FOOTER â•â•â•â• -->
  <!-- â•â•â•â• IMPACT CARD â•â•â•â• -->
  <div class="impact-card">
    <div class="impact-card-label">Market Validation & Projections</div>
    <div class="impact-grid">
      <div class="impact-stat">
        <div class="impact-val" style="color: var(--c-green-400);">30%</div>
        <div class="impact-desc">Potential Input Savings</div>
      </div>
      <div class="impact-stat impact-stat-mid">
        <div class="impact-val" style="color: var(--c-gold);">â‚¹45k</div>
        <div class="impact-desc">Revenue Saved / Hectare</div>
      </div>
      <div class="impact-stat">
        <div class="impact-val" style="color: var(--c-green-300);">2.4k</div>
        <div class="impact-desc">Target Radar Capacity</div>
      </div>
    </div>
  </div>

  <footer class="agri-footer">
    <div class="footer-hacknovation" data-i18n="footerHack">Hacknovation 2.0 project by <span>Team AgriCore</span> ğŸ’š</div>
    <div class="footer-team" data-i18n="footerTeam">Built with â¤ï¸ for Indian Farmers Â· AgriUstaad Â© 2026</div>
  </footer>

</div>

<!-- â•â•â•â• AI ASSISTANT FAB â•â•â•â• -->
<button class="fab-chat" id="fabChat" aria-label="AI Assistant">
  <span class="fab-icon" id="fabIcon">ğŸ’¬</span>
  <div class="fab-ripple" id="fabRipple"></div>
  <div class="fab-double-hint" id="fabHint">Double-tap for voice</div>
</button>

<div class="chatbot-container" id="chatbotWidget">
  <!-- Header â€” shared -->
  <div class="chat-header">
    <div class="status-dot" id="chatStatusDot"></div>
    <span id="chatHeaderTitle">AI Ustaad</span>
    <div style="display:flex;align-items:center;gap:6px;margin-left:auto;">
      <button class="chat-mode-toggle" id="chatModeToggle" title="Switch to voice mode" onclick="switchChatMode()">ğŸ¤</button>
      <button class="close-chat" onclick="toggleChat()">Ã—</button>
    </div>
  </div>

  <!-- TEXT PANEL -->
  <div id="chatTextPanel">
    <div class="chat-messages" id="chatBody">
      <div class="msg bot" data-i18n="chatWelcome">Hello! I'm your AI Ustaad. I can see what's on your screen â€” ask me about your crop, weather, disease risks, or spray recommendations! ğŸŒ±</div>
    </div>
    <div class="chat-input-area">
      <input type="text" id="chatInput" data-i18n-placeholder="chatPlaceholder" placeholder="Ask a questionâ€¦" onkeypress="handleChatKey(event)">
      <button class="btn-send" onclick="sendChat()">â¤</button>
    </div>
  </div>

  <!-- VOICE PANEL -->
  <div id="chatVoicePanel" style="display:none;">
    <div class="cv-body">
      <div class="cv-orb-wrap">
        <div class="cv-orb" id="cvOrb">
          <div class="cv-ring cv-ring-a"></div>
          <div class="cv-ring cv-ring-b"></div>
          <div class="cv-orb-icon" id="cvOrbIcon">ğŸ¤</div>
        </div>
      </div>
      <div class="cv-status" id="cvStatus">Tap the mic to start</div>
      <div class="cv-transcript" id="cvTranscript"></div>
      <div class="cv-response" id="cvResponse"></div>
    </div>
    <div class="cv-footer">
      <button class="cv-mic-btn" id="cvMicBtn" onclick="toggleVoiceListening()">
        <span id="cvMicIcon">ğŸ¤</span> <span id="cvMicLabel">Start Listening</span>
      </button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSLATION STRINGS â€” ALL UI TEXT IN ONE PLACE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BASE_STRINGS = {
  // --- Hero Section ---
  heroBadge:      "Hacknovation 2.0 Â· Team AgriCore",
  heroSubteam:    "by Team AgriCore",
  heroDesc:       "An AI-powered super app for Indian farmers â€” diagnose crop diseases, estimate yields, analyse soil health, and get real-time advisory in your own language. Built for the field, by people who care about it.",
  statLang:       "Languages",
  statModes:      "AI Scan Modes",
  statWeatherVal: "Real-time",
  statWeather:    "Weather Advisory",
  statFreeVal:    "Free",
  statFree:       "For Every Farmer",
  // --- Features Section ---
  featHeading:    "What AgriUstaad Can Do",
  featSub:        "Powerful AI tools designed for real farm conditions",
  feat1Title:     "Disease Detection",
  feat1Desc:      "Photograph any crop and get an instant AI diagnosis â€” disease name, severity score, and treatment advice in seconds.",
  feat1Tag:       "AI Vision",
  feat2Title:     "Yield Estimator",
  feat2Desc:      "Know your harvest readiness and get smart market advice before you cut â€” so you sell at the right time, at the right price.",
  feat2Tag:       "Harvest AI",
  feat3Title:     "Soil Analysis",
  feat3Desc:      "Understand your soil type, moisture levels, and get personalised treatment plans to improve your field's health.",
  feat3Tag:       "Soil Intel",
  feat4Title:     "Crate Inspector",
  feat4Desc:      "Scan produce crates for quality grading â€” perfect for supply chain decisions and post-harvest management.",
  feat4Tag:       "Quality AI",
  feat5Title:     "Weather Advisory",
  feat5Desc:      "Hyperlocal weather insights tied to your GPS location, with actionable farming guidance for the week ahead.",
  feat5Tag:       "Live Data",
  feat6Title:     "AI Ustaad Chat",
  feat6Desc:      "Ask anything, anytime. Your AI Ustaad is available 24/7 to answer questions about crops, pests, and farming practices.",
  feat6Tag:       "Always On",
  // --- Try Divider ---
  tryTitle:       "Ready to Scan Your Field?",
  trySub:         "Pick a mode below and upload a photo â€” results in under 10 seconds",
  // --- Footer ---
  footerHack:     "Hacknovation 2.0 project by <span>Team AgriCore</span> ğŸ’š",
  footerTeam:     "Built with â¤ï¸ for Indian Farmers Â· AgriUstaad Â© 2026",
  // --- Lang Bar ---
  langBarLabel:   "Language:",
  radarBanner:    '<b>Community Radar:</b> 3 cases of "Leaf Blast" detected within 5km today.',
  back:           "Back",
  map:            "Map",
  // --- Scan Card ---
  scanTitle:      "AI Field Scanner",
  scanSubtitle:   "Select a tool to begin analysis",
  modeDisease:    "Disease",
  modeYield:      "Yield",
  modeSoil:       "Soil",
  modeCrate:      "Crate",
  tipDisease:     "Detect crop diseases",
  tipYield:       "Estimate harvest yield",
  tipSoil:        "Analyse soil health",
  tipCrate:       "Inspect crate quality",
  voiceCmd:       "Voice Command",
  uploadTitle:    "Drag & Drop or Tap",
  uploadSub:      "Supports JPG, PNG Â· AI Analysis",
  uploadHint:     "â†‘ Drop image here â†‘",
  gallery:        "Gallery",
  camera:         "Camera",
  errTitle:       "Analysis Failed",
  uploading:      "Uploading imageâ€¦",
  runAnalysis:    "Run Analysis",
  // --- Results ---
  skelAnalyzing:  "AI is Analyzing...",
  diagTitle:      "Diagnosis Complete",
  aiVerified:     "AI Verified",
  ecoScore:       "Eco Score ğŸŒ",
  roiEst:         "ROI Est. ğŸ’°",
  emptyTitle:     "No Data Returned",
  emptyDesc:      "The analysis didn't return usable results. Try with a clearer image.",
  govtScheme:     "Govt Scheme",
  weatherAdv:     "Weather Advisory",
  rentTool:       "ğŸšœ Rent Tool",
  buyMeds:        "ğŸ’Š Buy Meds",
  downloadPdf:    "ğŸ“„  Download Health Passport (PDF)",
  shareWhatsapp:  "Share to WhatsApp",
  // --- Chat ---
  chatTitle:      "AI Ustaad",
  chatWelcome:    "Hello! I'm your AI Ustaad. How can I help your farm today? ğŸŒ±",
  chatPlaceholder:"Ask a questionâ€¦",
  chatError:      "âš ï¸ Couldn't reach the server.",
  // --- Modal ---
  book:           "BOOK",
  call:           "CALL",
  close:          "Close",
  // --- Diag card labels ---
  labelCondition: "Condition",
  labelSeverity:  "Severity Score",
  labelTreatment: "Treatment",
  labelYield:     "Yield Estimate",
  labelReadiness: "Harvest Readiness",
  labelMarket:    "Market Advice",
  labelSoilType:  "Soil Type",
  labelMoisture:  "Moisture Level",
  labelTreatAdv:  "Treatment Advice",
  // --- Progress ---
  progUpload:     "Uploading imageâ€¦",
  progSending:    "Sending to AIâ€¦",
  progProcessing: "Processing resultsâ€¦",
  progDone:       "Done!",
  // --- Errors & alerts ---
  errNoPhoto:     "Please capture or select a photo first!",
  errServer:      "Server error. Please try again.",
  offlineSaved:   "ğŸ“± No Internet! Your scan is saved securely to your device. It will automatically analyze in the background when you reconnect.",
  offlineErrSave: "âŒ Error saving offline: ",
  syncingScans:   "ğŸ”„ Internet restored! Syncing offline scans to the cloud...",
  syncDone:       "âœ… All offline scans have been successfully analyzed and saved to your History Map!",
  shareNotSupported: "Sharing is not supported on this browser. Copying to clipboard instead!",
  // --- Button states ---
  btnProcessing:  "â³  Processingâ€¦",
  btnReady:       "ğŸš€  Run Analysis",
  high:           "High",
  calNav:         "Calendar",
  radarNav:       "Radar",
};

/* Currently active strings (gets replaced after translation) */
let T = { ...BASE_STRINGS };

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LANGUAGE SELECTOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selectLang(el) {
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  selectedLang     = el.dataset.lang;
  selectedLangName = el.dataset.name;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENTER APP â€” translate then reveal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function enterApp() {
  const btn    = document.getElementById('enterBtn');
  const status = document.getElementById('langStatus');

  if (selectedLang === 'en') {
    await launchApp();
    return;
  }

  btn.disabled = true;
  btn.innerHTML = `<span class="btn-spinner"></span> Translating to ${selectedLangName}â€¦`;
  status.className = 'lang-status active';
  status.textContent = 'Translating interfaceâ€¦';

  try {
    T = await translateStrings(BASE_STRINGS, selectedLang);
    status.textContent = 'âœ“ Done â€” launchingâ€¦';
    await new Promise(r => setTimeout(r, 400));
    await launchApp();
  } catch(err) {
    btn.disabled = false;
    btn.innerHTML = 'Enter AgriUstaad â†’';
    status.className = 'lang-status error';
    status.textContent = 'Launchingâ€¦';
    await launchApp();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FREE GOOGLE TRANSLATE â€” no API key required
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function translateStrings(strings, langCode) {
  const keys    = Object.keys(strings);
  const values  = Object.values(strings);
  const DELIM   = ' ||| ';

  const stripped = values.map(v => v.replace(/<[^>]+>/g, m => `[[${m}]]`));
  const joined   = stripped.join(DELIM);

  const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${langCode}&dt=t&q=${encodeURIComponent(joined)}`;
  const controller = new AbortController();
  const timeoutId  = setTimeout(() => controller.abort(), 8000);
  let res;
  try { res = await fetch(url, { signal: controller.signal }); }
  finally { clearTimeout(timeoutId); }
  if (!res.ok) throw new Error(`Google Translate HTTP ${res.status}`);

  const data = await res.json();
  let translated = '';
  for (const seg of data[0]) { if (seg && seg[0]) translated += seg[0]; }

  const parts  = translated.split(/\s*\|\|\|\s*/);
  const result = {};
  keys.forEach((key, i) => {
    let val = parts[i] || values[i];
    val = val.replace(/\[\[(<[^>]+>)\]\]/g, '$1');
    result[key] = val;
  });
  return { ...BASE_STRINGS, ...result };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APPLY TRANSLATIONS TO DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTranslations() {
  // Text content
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (T[key]) el.innerHTML = T[key];
  });

  // Placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.dataset.i18nPlaceholder;
    if (T[key]) el.placeholder = T[key];
  });

  // data-tip on mode buttons (translated)
  document.querySelectorAll('[data-tip-key]').forEach(el => {
    const key = el.dataset.tipKey;
    if (T[key]) el.setAttribute('data-tip', T[key]);
  });

  // Update lang bar (hidden top bar kept for compat)
  document.getElementById('langBarName').textContent = selectedLangName;
  document.getElementById('langBar').style.display = 'flex';
  // Show language button in nav
  const langNavBtn = document.getElementById('langNavBtn');
  if (langNavBtn) {
    document.getElementById('langNavName').textContent = selectedLangName;
    langNavBtn.style.display = 'flex';
  }

  // Reset chat welcome message in the selected language
  const chatBody = document.getElementById('chatBody');
  if (chatBody) {
    const welcomeMsg = chatBody.querySelector('.msg.bot[data-i18n="chatWelcome"]');
    if (welcomeMsg) welcomeMsg.textContent = T.chatWelcome || BASE_STRINGS.chatWelcome;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CINEMATIC LAUNCH SEQUENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function launchApp() {
  applyTranslations();

  const overlay = document.getElementById('langOverlay');
  const flash   = document.getElementById('flashOverlay');
  const app     = document.getElementById('appWrapper');

  // 1. Hide language overlay with fade
  overlay.classList.add('hiding');

  // 2. Flash â€” green burst
  await new Promise(r => setTimeout(r, 250));
  flash.classList.add('flash-in');

  // 3. Hold flash briefly
  await new Promise(r => setTimeout(r, 180));

  // 4. Remove lang overlay from flow
  overlay.style.display = 'none';

  // 5. Fade flash out while app reveals underneath
  flash.classList.remove('flash-in');
  flash.classList.add('flash-out');
  app.classList.add('revealed');

  // 6. Clean up flash
  await new Promise(r => setTimeout(r, 1400));
  flash.style.display = 'none';

  // 7. Show community radar as toast notification, auto-dismiss after 5s
  const radarToast = document.getElementById('radarToast');
  if (radarToast) {
    // Slight delay after app reveal for better UX
    setTimeout(() => {
      radarToast.classList.add('radar-show');
      setTimeout(() => {
        radarToast.classList.add('radar-hide');
        radarToast.classList.remove('radar-show');
      }, 5000);
    }, 800);
  }

  // 7. Save lang so map/history return doesn't re-show popup
  try {
    sessionStorage.setItem('agri_lang', selectedLang);
    sessionStorage.setItem('agri_lang_name', selectedLangName);
    sessionStorage.setItem('agri_T', JSON.stringify(T));
  } catch(e) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET LANGUAGE â€” re-show selector
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resetLanguage() {
  const overlay = document.getElementById('langOverlay');
  const app     = document.getElementById('appWrapper');
  const flash   = document.getElementById('flashOverlay');

  app.classList.remove('revealed');
  flash.style.display = '';
  flash.classList.remove('flash-out');
  overlay.style.display = '';
  overlay.classList.remove('hiding');

  try { sessionStorage.clear(); } catch(e) {}

  document.getElementById('enterBtn').disabled = false;
  document.getElementById('enterBtn').innerHTML = 'Enter AgriUstaad â†’';
  document.getElementById('langStatus').textContent = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” show lang popup only on fresh visit,
   skip if returning from map/history (same session)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API_BASE = ''; // Set to your Render URL for Netlify deploy
let geminiKey = ''; // kept for compat, unused
let selectedLang = 'en';
let selectedLangName = 'English';

(async function init() {
  try {
    const savedLang = sessionStorage.getItem('agri_lang');
    const savedName = sessionStorage.getItem('agri_lang_name');
    const savedT    = sessionStorage.getItem('agri_T');

    if (savedLang && savedName) {
      // Returning from map/history â€” skip popup, restore state instantly
      selectedLang     = savedLang;
      selectedLangName = savedName;
      if (savedT) {
        try { T = { ...BASE_STRINGS, ...JSON.parse(savedT) }; } catch(e) {}
      }
      // Pre-select correct lang button
      document.querySelectorAll('.lang-btn').forEach(b => {
        b.classList.toggle('selected', b.dataset.lang === savedLang);
      });
      // Skip animation â€” just reveal app directly
      document.getElementById('langOverlay').style.display = 'none';
      const app = document.getElementById('appWrapper');
      app.style.transition = 'none';
      app.classList.add('revealed');
      applyTranslations();
      // Show lang button in nav (no radar toast on return)
      const langNavBtn = document.getElementById('langNavBtn');
      if (langNavBtn) {
        document.getElementById('langNavName').textContent = selectedLangName;
        langNavBtn.style.display = 'flex';
      }
      return;
    }
  } catch(e) {}
  // Fresh visit â€” show language selector (default English pre-selected)
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP LOGIC (all backend calls untouched)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currMode = 'field';
let aiClassifiedMode = null; // set by Gemini auto-classify
let manualOverrideActive = false;

/* â”€â”€â”€ Mode metadata â”€â”€â”€ */
const MODE_META = {
  field: { emoji: 'ğŸŒ¿', label: 'Crop Disease',   icon: 'ğŸ¦ ', heroIcon: 'ğŸŒ¿', conf: 94, colorClass: 'mode-disease' },
  yield: { emoji: 'ğŸ‡', label: 'Yield / Harvest', icon: 'ğŸ‡', heroIcon: 'ğŸ‡', conf: 91, colorClass: 'mode-yield'   },
  soil:  { emoji: 'ğŸŸ¤', label: 'Soil Health',     icon: 'ğŸŸ¤', heroIcon: 'ğŸŒ', conf: 88, colorClass: 'mode-soil'    },
  crate: { emoji: 'ğŸ“¦', label: 'Crate / Produce', icon: 'ğŸ“¦', heroIcon: 'ğŸ“¦', conf: 96, colorClass: 'mode-crate'   },
};

/* â”€â”€â”€ Apply a mode (updates hero icon, badge, etc.) â”€â”€â”€ */
function applyMode(mode) {
  currMode = mode;
  const meta = MODE_META[mode] || MODE_META.field;

  // Update hero icon
  const heroIcon = document.getElementById('scannerHeroIcon');
  if (heroIcon) {
    heroIcon.textContent = meta.heroIcon;
    heroIcon.className = 'scanner-hero-icon ' + meta.colorClass;
  }

  // Update scanner status text
  const statusEl = document.getElementById('scannerStatusText');
  if (statusEl) statusEl.textContent = `AI detected: ${meta.label} â€” ready to analyse`;

  // Update classify badge
  const badge = document.getElementById('aiClassifyBadge');
  if (badge) {
    badge.style.display = 'flex';
    badge.className = 'ai-classify-badge ' + meta.colorClass;
    document.getElementById('acbSpinner').style.display = 'none';
    document.getElementById('acbThinking').style.display = 'none';
    const content = document.getElementById('acbContent');
    content.style.display = 'flex';
    document.getElementById('acbIcon').textContent = meta.emoji;
    document.getElementById('acbCategory').textContent = meta.label;
    document.getElementById('acbConfVal').textContent = meta.conf + '%';
  }

  // Enable analyze button
  const btn = document.getElementById('btnAnalyze');
  if (btn) {
    btn.disabled = false;
    btn.classList.add('ready');
    document.getElementById('btnAnalyzeIcon').textContent = 'ğŸš€';
    document.getElementById('btnAnalyzeText').textContent = 'Run Analysis â€” ' + meta.label;
  }
}

/* â”€â”€â”€ Manual override: user picks a mode â”€â”€â”€ */
function setModeManual(mode, el) {
  manualOverrideActive = true;
  document.querySelectorAll('.manual-override .mode-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  applyMode(mode);
}

/* Legacy setMode stub for compatibility */
function setMode(mode, el) { setModeManual(mode, el); }

/* â”€â”€â”€ Toggle manual override panel â”€â”€â”€ */
function toggleManualOverride() {
  const panel = document.getElementById('manualOverride');
  if (!panel) return;
  const showing = panel.style.display !== 'none';
  panel.style.display = showing ? 'none' : 'block';
}

/* â”€â”€â”€ AI Auto-classify via Gemini â”€â”€â”€ */
async function autoClassifyImage(file) {
  // Show badge in "thinking" state
  const badge = document.getElementById('aiClassifyBadge');
  badge.style.display = 'flex';
  badge.className = 'ai-classify-badge';
  document.getElementById('acbSpinner').style.display = 'block';
  document.getElementById('acbContent').style.display = 'none';
  document.getElementById('acbThinking').style.display = 'flex';

  // Show overlay on preview
  document.getElementById('previewOverlay').style.display = 'flex';
  document.getElementById('poStatusText').textContent = 'AI is classifyingâ€¦';

  // Update button state
  const btn = document.getElementById('btnAnalyze');
  btn.disabled = true;
  btn.classList.remove('ready');
  document.getElementById('btnAnalyzeIcon').textContent = 'ğŸ§ ';
  document.getElementById('btnAnalyzeText').textContent = 'AI Classifyingâ€¦';

  try {
    // Convert file to base64
    const b64 = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });

    const mimeType = file.type || 'image/jpeg';

    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDummyKeyForDemo', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [
            { inline_data: { mime_type: mimeType, data: b64 } },
            { text: `You are an agricultural AI validator. First check: is this image of a plant, crop, leaf, soil, or agricultural produce? If NOT (e.g. phone, table, chair, person, wall, random object), reply exactly: "invalid". If YES, classify into ONE of: "field" (crop disease/leaf problem), "yield" (harvest-ready crop/fruit/plant), "soil" (soil or ground), "crate" (produce crate/box/batch). Reply ONLY the single keyword.` }
          ]
        }],
        generationConfig: { temperature: 0.1, maxOutputTokens: 10 }
      })
    });

    if (!response.ok) throw new Error('API error ' + response.status);
    const data = await response.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toLowerCase() || '';
    if (text === 'invalid') {
      showInvalidScanMsg('ğŸŒ¿ Please scan a valid plant or crop image. Non-agricultural objects cannot be analysed.');
      _selectedFile = null;
      document.getElementById('fileIn').value = '';
      document.getElementById('preview').src = '';
      document.getElementById('preview').style.display = 'none';
      document.getElementById('uploadContent').style.display = '';
      document.getElementById('btnAnalyze').disabled = true;
      return;
    }
    hideInvalidScanMsg();
    const detected = ['field','yield','soil','crate'].includes(text) ? text : 'field';
    aiClassifiedMode = detected;
    applyMode(detected);

  } catch(err) {
    // Fallback: use heuristic or default to 'field'
    console.warn('Gemini classify failed, using heuristic fallback:', err.message);
    const filename = (file.name || '').toLowerCase();
    let fallback = 'field';
    if (filename.includes('soil') || filename.includes('dirt') || filename.includes('ground')) fallback = 'soil';
    else if (filename.includes('crate') || filename.includes('box') || filename.includes('harvest')) fallback = 'crate';
    else if (filename.includes('yield') || filename.includes('fruit')) fallback = 'yield';
    aiClassifiedMode = fallback;
    applyMode(fallback);
  } finally {
    document.getElementById('previewOverlay').style.display = 'none';
  }
}

let _selectedFile = null; // always use this as the source of truth

function previewFile(file) {
  if (!file) return;
  _selectedFile = file; // store reliably
  const img = document.getElementById('preview');
  img.src = URL.createObjectURL(file);
  img.style.display = 'block';
  document.getElementById('uploadContent').style.display = 'none';
  try {
    const dt = new DataTransfer(); dt.items.add(file);
    document.getElementById('fileIn').files = dt.files;
  } catch(e) {}

  // Trigger AI auto-classification (skip if manual override active)
  if (!manualOverrideActive) {
    autoClassifyImage(file);
  }
}

function handleDragOver(e) { e.preventDefault(); e.stopPropagation(); document.getElementById('uploadZone').classList.add('drag-over'); }
function handleDragLeave(e) { e.stopPropagation(); document.getElementById('uploadZone').classList.remove('drag-over'); }
function handleDrop(e) {
  e.preventDefault(); e.stopPropagation();
  document.getElementById('uploadZone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) previewFile(file);
}

function openModal(type) {
  document.getElementById('mockModal').style.display = 'flex';
  document.getElementById('modalTitle').innerText = type === 'sprayer' ? "ğŸšœ " + (T.rentTool||'Rent Tool').replace(/ğŸšœ\s*/,'') : "ğŸ’Š " + (T.buyMeds||'Buy Meds').replace(/ğŸ’Š\s*/,'');
}
function closeModal(e) { if (e.target.id === 'mockModal') e.target.style.display = 'none'; }
function toggleChat() {
  const w = document.getElementById('chatbotWidget');
  const isOpen = w.style.display === 'flex';
  w.style.display = isOpen ? 'none' : 'flex';
  if (isOpen && currentChatMode === 'voice') {
    stopVoiceListening();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FAB â€” SINGLE TAP: text chat | DOUBLE TAP: voice mode
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentChatMode = 'text'; // 'text' | 'voice'

(function initFab() {
  const fab     = document.getElementById('fabChat');
  const fabIcon = document.getElementById('fabIcon');
  const ripple  = document.getElementById('fabRipple');

  let tapCount = 0, tapTimer = null;

  function triggerRipple() {
    ripple.classList.remove('go');
    void ripple.offsetWidth;
    ripple.classList.add('go');
    setTimeout(() => ripple.classList.remove('go'), 450);
  }

  fab.addEventListener('click', () => {
    tapCount++;
    if (tapCount === 1) {
      tapTimer = setTimeout(() => {
        tapCount = 0;
        // Single tap â€” open in text mode
        triggerRipple();
        const w = document.getElementById('chatbotWidget');
        if (w.style.display === 'flex' && currentChatMode === 'voice') {
          // already open in voice â€” close it
          toggleChat();
        } else {
          w.style.display = 'flex';
          if (currentChatMode !== 'text') switchToTextMode();
        }
      }, 260);
    } else if (tapCount === 2) {
      clearTimeout(tapTimer);
      tapCount = 0;
      // Double tap â€” open in voice mode
      triggerRipple();
      const w = document.getElementById('chatbotWidget');
      if (w.style.display === 'flex' && currentChatMode === 'voice') {
        toggleChat(); // already in voice mode, close
      } else {
        w.style.display = 'flex';
        switchToVoiceMode();
      }
    }
  });
})();

/* â”€â”€ Switch between text and voice panels â”€â”€ */
function switchChatMode() {
  if (currentChatMode === 'text') switchToVoiceMode();
  else switchToTextMode();
}

function switchToTextMode() {
  currentChatMode = 'text';
  document.getElementById('chatTextPanel').style.display = 'flex';
  document.getElementById('chatTextPanel').style.flexDirection = 'column';
  document.getElementById('chatVoicePanel').style.display = 'none';
  document.getElementById('chatHeaderTitle').textContent = 'AI Ustaad';
  document.getElementById('chatModeToggle').textContent = 'ğŸ¤';
  document.getElementById('chatModeToggle').classList.remove('voice-active');
  document.getElementById('chatModeToggle').title = 'Switch to voice mode';
  document.getElementById('chatStatusDot').style.background = 'var(--c-green-400)';
  document.getElementById('chatStatusDot').style.boxShadow = '0 0 8px var(--c-green-400)';
  stopVoiceListening();
}

function switchToVoiceMode() {
  currentChatMode = 'voice';
  document.getElementById('chatTextPanel').style.display = 'none';
  document.getElementById('chatVoicePanel').style.display = 'flex';
  document.getElementById('chatVoicePanel').style.flexDirection = 'column';
  document.getElementById('chatHeaderTitle').textContent = 'Voice Mode';
  document.getElementById('chatModeToggle').textContent = 'ğŸ’¬';
  document.getElementById('chatModeToggle').classList.add('voice-active');
  document.getElementById('chatModeToggle').title = 'Switch to text mode';
  document.getElementById('chatStatusDot').style.background = '#e05252';
  document.getElementById('chatStatusDot').style.boxShadow = '0 0 8px #e05252';
  resetVoicePanel();
}

/* â•â•â•â• VOICE PANEL LOGIC â•â•â•â• */
let voiceRecognition = null;
let isListening = false;

function resetVoicePanel() {
  const orb = document.getElementById('cvOrb');
  orb.className = 'cv-orb';
  document.getElementById('cvOrbIcon').textContent = 'ğŸ¤';
  document.getElementById('cvStatus').textContent = 'Tap the mic to start';
  document.getElementById('cvTranscript').textContent = '';
  document.getElementById('cvResponse').classList.remove('visible');
  document.getElementById('cvResponse').textContent = '';
  document.getElementById('cvMicBtn').classList.remove('active');
  document.getElementById('cvMicIcon').textContent = 'ğŸ¤';
  document.getElementById('cvMicLabel').textContent = 'Start Listening';
}

function toggleVoiceListening() {
  if (isListening) stopVoiceListening();
  else startVoiceListening();
}

function startVoiceListening() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    document.getElementById('cvStatus').textContent = 'Not supported in this browser';
    document.getElementById('cvTranscript').textContent = 'Try Chrome or Safari';
    return;
  }

  isListening = true;
  document.getElementById('cvOrb').className = 'cv-orb listening';
  document.getElementById('cvOrbIcon').textContent = 'ğŸ™ï¸';
  document.getElementById('cvStatus').textContent = 'Listeningâ€¦';
  document.getElementById('cvTranscript').textContent = '';
  document.getElementById('cvResponse').classList.remove('visible');
  document.getElementById('cvMicBtn').classList.add('active');
  document.getElementById('cvMicIcon').textContent = 'â¹';
  document.getElementById('cvMicLabel').textContent = 'Stop';

  voiceRecognition = new SR();
  voiceRecognition.lang = selectedLang === 'en' ? 'en-IN' : selectedLang;
  voiceRecognition.interimResults = true;
  voiceRecognition.maxAlternatives = 1;

  voiceRecognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    document.getElementById('cvTranscript').textContent = '"' + transcript + '"';
    if (e.results[e.results.length - 1].isFinal) {
      processVoiceQuery(transcript);
    }
  };

  voiceRecognition.onerror = () => {
    isListening = false;
    document.getElementById('cvOrb').className = 'cv-orb';
    document.getElementById('cvOrbIcon').textContent = 'ğŸ¤';
    document.getElementById('cvStatus').textContent = 'Couldn\'t hear you â€” try again';
    document.getElementById('cvMicBtn').classList.remove('active');
    document.getElementById('cvMicIcon').textContent = 'ğŸ¤';
    document.getElementById('cvMicLabel').textContent = 'Try Again';
  };

  voiceRecognition.onend = () => { isListening = false; };
  voiceRecognition.start();
}

function stopVoiceListening() {
  isListening = false;
  if (voiceRecognition) { try { voiceRecognition.stop(); } catch(e){} }
  if ('speechSynthesis' in window) window.speechSynthesis.cancel();
  document.getElementById('cvOrb').className = 'cv-orb';
  document.getElementById('cvMicBtn').classList.remove('active');
  document.getElementById('cvMicIcon').textContent = 'ğŸ¤';
  document.getElementById('cvMicLabel').textContent = 'Start Listening';
}

async function processVoiceQuery(text) {
  if (!text.trim()) return;
  stopVoiceListening();

  document.getElementById('cvOrb').className = 'cv-orb thinking';
  document.getElementById('cvOrbIcon').textContent = 'ğŸ§ ';
  document.getElementById('cvStatus').textContent = 'Thinkingâ€¦';
  document.getElementById('cvMicLabel').textContent = 'Processingâ€¦';

  try {
    const res  = await fetch(API_BASE + '/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text, lang: selectedLang, lang_name: selectedLangName, system_note: '' })
    });
    const data = await res.json();
    const reply = data.reply || 'Sorry, no response.';

    document.getElementById('cvOrb').className = 'cv-orb';
    document.getElementById('cvOrbIcon').textContent = 'âœ…';
    document.getElementById('cvStatus').textContent = 'AI Ustaad says:';
    document.getElementById('cvResponse').textContent = reply;
    document.getElementById('cvResponse').classList.add('visible');
    document.getElementById('cvMicIcon').textContent = 'ğŸ¤';
    document.getElementById('cvMicLabel').textContent = 'Ask Another';

    if ('speechSynthesis' in window) {
      const utter = new SpeechSynthesisUtterance(reply);
      utter.lang = selectedLang === 'en' ? 'en-IN' : selectedLang;
      utter.rate = 0.95;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
      utter.onend = () => {
        if (currentChatMode === 'voice') {
          document.getElementById('cvMicLabel').textContent = 'Ask Another';
        }
      };
    }
  } catch(e) {
    document.getElementById('cvOrb').className = 'cv-orb';
    document.getElementById('cvOrbIcon').textContent = 'âš ï¸';
    document.getElementById('cvStatus').textContent = 'Error â€” try again';
    document.getElementById('cvMicIcon').textContent = 'ğŸ¤';
    document.getElementById('cvMicLabel').textContent = 'Retry';
  }
}

function showError(boxId, msg) {
  document.getElementById(boxId).classList.add('visible');
  const m = document.getElementById(boxId + 'Msg');
  if (m) m.textContent = msg;
}
function dismissError(boxId) { document.getElementById(boxId).classList.remove('visible'); }

function setProgress(pct, label) {
  document.getElementById('progressBar').style.width = pct + '%';
  if (label) document.getElementById('progressLabel').textContent = label;
}
function showProgress() { document.getElementById('progressWrap').classList.add('visible'); }
function hideProgress() { document.getElementById('progressWrap').classList.remove('visible'); setProgress(0); }

function goBack() {
  if (window.innerWidth < 760) {
    document.getElementById('scanCard').style.display   = 'block';
    document.getElementById('resultCard').style.display = 'none';
  }
  document.getElementById('microPanel').classList.remove('two-col');
  document.getElementById('btnBack').classList.remove('visible');
  dismissError('scanError');
  // Reset file + preview so next scan starts fresh
  _selectedFile = null;
  document.getElementById('fileIn').value = '';
  document.getElementById('cameraIn').value = '';
  const preview = document.getElementById('preview');
  preview.src = ''; preview.style.display = 'none';
  document.getElementById('uploadContent').style.display = 'flex';
  // Reset analyse button
  document.getElementById('btnAnalyzeIcon').textContent = 'ğŸ“·';
  document.getElementById('btnAnalyzeText').textContent = 'Upload a photo to begin';
  document.getElementById('btnAnalyze').disabled = true;
  // Reset AI classification badge
  const badge = document.getElementById('aiClassifyBadge');
  if (badge) badge.className = 'ai-classify-badge';
}

function animateRing(ringId, valId, displayText, fraction) {
  document.getElementById(ringId).style.strokeDashoffset = 176 * (1 - Math.min(fraction, 1));
  document.getElementById(valId).textContent = displayText;
}

/* â”€â”€ Simple markdown â†’ HTML for treatment text â”€â”€ */
function renderMarkdown(text) {
  if (!text) return 'â€”';
  return text
    // **bold**
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    // numbered list items: "1. ", "2. " etc â†’ proper list items
    .replace(/(?:^|\n)\s*(\d+)\.\s+/g, (_, n) => `\n<div class="md-step"><span class="md-step-num">${n}</span><span class="md-step-body">`)
    // close open step spans (every new numbered item or end closes the previous)
    .replace(/(<div class="md-step">(?!.*<\/span><\/div>))/g, '$1') // placeholder
    // bullet points
    .replace(/(?:^|\n)\s*[-â€¢]\s+/g, '\n<div class="md-bullet">â€¢ ')
    // line breaks
    .replace(/\n/g, '</span></div>\n')
    // clean up unclosed spans from plain lines
    .replace(/<\/span><\/div>\n(?!<div class="md-)/g, '\n')
    .trim();
}

/* Cleaner approach â€” parse line by line */
function parseToHTML(text) {
  if (!text) return '<span class="diag-empty">â€”</span>';
  const lines = text.split(/\n+/).map(l => l.trim()).filter(Boolean);
  let html = '';
  lines.forEach(line => {
    // Numbered step: "1. Title: body" or "1. body"
    const stepMatch = line.match(/^(\d+)\.\s+\*\*(.+?)\*\*[:\s]*(.*)/);
    const stepPlain = line.match(/^(\d+)\.\s+(.*)/);
    if (stepMatch) {
      html += `<div class="md-step">
        <span class="md-step-num">${stepMatch[1]}</span>
        <div class="md-step-content">
          <span class="md-step-title">${stepMatch[2]}</span>
          ${stepMatch[3] ? `<span class="md-step-body">${inlineMd(stepMatch[3])}</span>` : ''}
        </div>
      </div>`;
    } else if (stepPlain) {
      html += `<div class="md-step">
        <span class="md-step-num">${stepPlain[1]}</span>
        <div class="md-step-content">
          <span class="md-step-body">${inlineMd(stepPlain[2])}</span>
        </div>
      </div>`;
    } else if (line.startsWith('-') || line.startsWith('â€¢')) {
      html += `<div class="md-bullet">${inlineMd(line.replace(/^[-â€¢]\s*/, ''))}</div>`;
    } else {
      html += `<p class="md-para">${inlineMd(line)}</p>`;
    }
  });
  return html;
}

function inlineMd(text) {
  return text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>');
}


/* â•â•â•â• RENDER RESULT SECTIONS â•â•â•â• */
function renderResultSections(mode, d) {
  const el = id => document.getElementById(id);
  const diseaseName = mode==='yield'?(d.yield_estimate||'Yield Analysis'):mode==='soil'?(d.soil_type||'Soil Analysis'):(d.disease_name||'Unknown');
  el('ra-disease-name').textContent = diseaseName;
  const conf = d.confidence;
  el('ra-confidence-text').textContent = conf!=null?`AI Confidence: ${conf}% Â· Mode: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`:`Analysis Mode: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`;
  const sev = parseFloat(d.severity_score)||0;
  const sevWrap = el('ra-sev-bar-wrap'), sevFill = el('ra-sev-fill'), sevLabel = el('ra-severity-label');
  if (mode!=='yield'&&mode!=='soil'&&sev>0) {
    sevWrap.style.display='';
    sevFill.style.width=Math.min(sev,100)+'%';
    sevFill.className='ra-severity-fill'+(sev>66?' danger':sev>33?' warn':'');
    sevLabel.textContent=`Severity: ${sev}% â€” ${sev>66?'High â€” Act immediately':sev>33?'Moderate â€” Monitor closely':'Low â€” Early stage'}`;
  } else { sevWrap.style.display='none'; sevLabel.textContent=mode==='yield'?`Harvest Readiness: ${d.harvest_readiness||'â€”'}`:''; }

  el('ra-cause-text').textContent = d.expected_cause||(mode==='soil'?`Soil: ${d.soil_type||'â€”'}. Moisture: ${d.moisture_level||'â€”'}.`:mode==='yield'?`Market: ${d.market_advice||'â€”'}`:d.disease_name?`Likely caused by fungal/bacterial/pest infection. Environmental stress (humidity, temperature) may accelerate spread.`:'â€”');

  const remedyList = el('ra-remedy-list'); remedyList.innerHTML='';
  const raw = d.treatment_advice||d.market_advice||'';
  const remedies = raw.split(/(?<=[.!?])\s+(?=[A-Z])|\n/).map(s=>s.trim()).filter(s=>s.length>8).slice(0,6);
  if(!remedies.length) remedies.push(raw||'Consult your local agricultural extension officer.');
  remedies.forEach(r=>{const li=document.createElement('li');li.textContent=r.replace(/^[-â€¢]\s*/,'');remedyList.appendChild(li);});

  const govtBody = el('ra-govt-body'); govtBody.innerHTML='';
  if(d.govt_subsidy){
    const url = d.govt_scheme_url||'https://pmfby.gov.in';
    govtBody.innerHTML=`<div class="ra-scheme-card"><div><div class="ra-scheme-name">ğŸ›ï¸ ${escapeHtml(d.govt_subsidy)}</div><div class="ra-sub" style="margin-top:3px;">Government scheme related to this diagnosis</div></div><a href="${url}" target="_blank" class="ra-scheme-link">Know More â†—</a></div>`;
    document.getElementById('subsidyName').innerText=d.govt_subsidy;
  } else {
    govtBody.innerHTML='<p class="ra-no-scheme">No specific scheme linked. Visit <a href="https://pmfby.gov.in" target="_blank" style="color:var(--c-gold);">pmfby.gov.in</a> for crop insurance.</p>';
  }

  const preventList = el('ra-prevent-list'); preventList.innerHTML='';
  const preventItems = d.prevention_tips?(Array.isArray(d.prevention_tips)?d.prevention_tips:d.prevention_tips.split(/[.\n]/).filter(s=>s.trim().length>5)):['Avoid overhead irrigation which spreads spores.','Do not apply treatments during rain or high winds.','Do not ignore early symptoms â€” delayed action worsens spread.','Avoid overcrowding plants; maintain proper spacing.','Do not reuse infected crop debris as compost.'];
  preventItems.slice(0,5).forEach(p=>{const li=document.createElement('li');li.textContent=p.trim().replace(/^[-â€¢]\s*/,'');preventList.appendChild(li);});
}

/* â•â•â•â• SCAN VALIDATION â•â•â•â• */
function showInvalidScanMsg(msg){const el=document.getElementById('scanInvalidMsg');if(el){el.querySelector('span:last-child').textContent=msg;el.classList.add('show');}}
function hideInvalidScanMsg(){const el=document.getElementById('scanInvalidMsg');if(el)el.classList.remove('show');}

/* â•â•â•â• 7-DAY WEATHER DASHBOARD â•â•â•â• */
const WX_ICONS={0:'â˜€ï¸',1:'ğŸŒ¤ï¸',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«ï¸',48:'ğŸŒ«ï¸',51:'ğŸŒ¦ï¸',53:'ğŸŒ¦ï¸',55:'ğŸŒ§ï¸',61:'ğŸŒ§ï¸',63:'ğŸŒ§ï¸',65:'ğŸŒ§ï¸',71:'â„ï¸',73:'â„ï¸',75:'â„ï¸',80:'ğŸŒ¦ï¸',81:'ğŸŒ§ï¸',82:'â›ˆï¸',95:'â›ˆï¸',96:'â›ˆï¸',99:'â›ˆï¸'};
const WX_DESC={0:'Clear sky',1:'Mainly clear',2:'Partly cloudy',3:'Overcast',45:'Foggy',51:'Light drizzle',53:'Drizzle',55:'Heavy drizzle',61:'Light rain',63:'Moderate rain',65:'Heavy rain',80:'Showers',81:'Heavy showers',82:'Violent showers',95:'Thunderstorm'};

async function initWeatherDashboard(){
  let lat=parseFloat(document.getElementById('lat')?.value)||20.296;
  let lon=parseFloat(document.getElementById('lon')?.value)||85.824;
  try{if(navigator.geolocation)await new Promise(res=>navigator.geolocation.getCurrentPosition(p=>{lat=p.coords.latitude;lon=p.coords.longitude;res();},res,{timeout:4000}));}catch(e){}
  const mapsLink=document.getElementById('wd-maps-link');
  if(mapsLink)mapsLink.href=`https://www.google.com/maps?q=${lat},${lon}`;
  try{const geo=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);if(geo.ok){const gd=await geo.json();const locText=document.getElementById('wd-loc-text');const city=gd.address?.city||gd.address?.town||gd.address?.village||'Your Location';const state=gd.address?.state||'';if(locText)locText.textContent=`${city}${state?', '+state:''} ğŸ“`;}}catch(e){}
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max,uv_index_max&hourly=relativehumidity_2m&timezone=auto&forecast_days=7`;
    const res=await fetch(url);const data=await res.json();
    const daily=data.daily;if(!daily)return;
    const todayCode=daily.weathercode[0];
    document.getElementById('wd-today-icon').textContent=WX_ICONS[todayCode]||'ğŸŒ¤ï¸';
    document.getElementById('wd-today-temp').textContent=Math.round(daily.temperature_2m_max[0])+'Â°C';
    document.getElementById('wd-today-desc').textContent=(WX_DESC[todayCode]||'Weather')+' Â· Low '+Math.round(daily.temperature_2m_min[0])+'Â°C';
    const hourlyHum=data.hourly?.relativehumidity_2m?.slice(0,24)||[];
    const avgHum=hourlyHum.length?Math.round(hourlyHum.reduce((a,b)=>a+b,0)/hourlyHum.length):'--';
    document.getElementById('wd-hum').textContent=avgHum+'%';
    document.getElementById('wd-rain').textContent=(daily.precipitation_sum[0]?.toFixed(1)||'0')+'mm';
    document.getElementById('wd-wind').textContent=Math.round(daily.windspeed_10m_max[0])+'km/h';
    document.getElementById('wd-uv').textContent=daily.uv_index_max?.[0]?.toFixed(1)||'--';
    const strip=document.getElementById('wd-7day');strip.innerHTML='';
    for(let i=0;i<daily.time.length;i++){
      const date=new Date(daily.time[i]+'T12:00:00');
      const dayName=i===0?'Today':date.toLocaleDateString('en-IN',{weekday:'short'});
      const code=daily.weathercode[i];const rain=daily.precipitation_sum[i]?.toFixed(1)||'0';
      const card=document.createElement('div');card.className='wd-day-card'+(i===0?' today-card':'');
      card.innerHTML=`<div class="wd-day-name">${dayName}</div><div class="wd-day-icon">${WX_ICONS[code]||'ğŸŒ¤ï¸'}</div><div class="wd-day-hi">${Math.round(daily.temperature_2m_max[i])}Â°</div><div class="wd-day-lo">${Math.round(daily.temperature_2m_min[i])}Â°</div>${parseFloat(rain)>0?`<div class="wd-day-rain">ğŸ’§${rain}mm</div>`:''}`;
      strip.appendChild(card);
    }
  }catch(e){document.getElementById('wd-7day').innerHTML='<div class="wd-loading">Could not load forecast.</div>';}
}

function buildDiagCards(mode, d) {
  renderResultSections(mode, d);
  const container = document.getElementById('diagCards');
  const empty     = document.getElementById('emptyState');
  container.innerHTML = '';

  let rows = [];
  if (mode === 'yield') {
    rows = [
      { icon:'ğŸ', labelKey:'labelYield',     value: d.yield_estimate,    rich: false },
      { icon:'ğŸ“‰', labelKey:'labelReadiness',  value: d.harvest_readiness, rich: false },
      { icon:'ğŸ’¡', labelKey:'labelMarket',     value: d.market_advice,     rich: true  },
    ];
  } else if (mode === 'soil') {
    rows = [
      { icon:'ğŸŸ¤', labelKey:'labelSoilType',  value: d.soil_type,        rich: false },
      { icon:'ğŸ’§', labelKey:'labelMoisture',  value: d.moisture_level,   rich: false },
      { icon:'ğŸ§ª', labelKey:'labelTreatAdv',  value: d.treatment_advice, rich: true  },
    ];
  } else {
    rows = [
      { icon:'ğŸ¦ ', labelKey:'labelCondition', value: d.disease_name,     rich: false },
      { icon:'âš ï¸', labelKey:'labelSeverity',  value: d.severity_score != null ? d.severity_score + '%' : null, severity: d.severity_score, rich: false },
      { icon:'ğŸ’Š', labelKey:'labelTreatment', value: d.treatment_advice, rich: true  },
    ];
  }

  const hasData = rows.some(r => r.value != null && r.value !== '');
  if (!hasData) { empty.classList.add('visible'); return; }
  empty.classList.remove('visible');

  rows.forEach(row => {
    const card = document.createElement('div');
    card.className = 'diag-card' + (row.rich ? ' diag-card-rich' : '');
    const label = T[row.labelKey] || row.labelKey;
    let extra = '';
    if (row.severity != null) extra = `<div class="severity-bar-wrap"><div class="severity-bar-track"><div class="severity-bar-fill" style="width:${Math.min(row.severity,100)}%"></div></div></div>`;

    const valueHTML = row.rich
      ? `<div class="diag-value diag-value-rich">${parseToHTML(row.value)}</div>`
      : `<div class="diag-value">${row.value != null ? escapeHtml(String(row.value)) : 'â€”'}</div>`;

    card.innerHTML = `<div class="diag-icon">${row.icon}</div><div class="diag-info"><div class="diag-label">${escapeHtml(label)}</div>${valueHTML}${extra}</div>`;
    container.appendChild(card);
  });
}

async function runAnalysis() {
  const file = _selectedFile
             || document.getElementById('fileIn').files[0]
             || document.getElementById('cameraIn').files[0];
  if (!file) { showError('scanError', T.errNoPhoto || 'Please capture a photo first!'); return; }
  dismissError('scanError');

  const btn     = document.getElementById('btnAnalyze');
  const btnText = document.getElementById('btnAnalyzeText');
  const btnIcon = document.getElementById('btnAnalyzeIcon');
  btnText.textContent = 'Processingâ€¦';
  btnIcon.textContent = 'â³';
  btn.disabled = true;

  // â”€â”€â”€ OFFLINE INTERCEPTION â”€â”€â”€
  if (!navigator.onLine) {
    showProgress();
    setProgress(50, 'Saving to offline storage...');
    const reader = new FileReader();
    reader.onload = async function(e) {
      try {
        await saveOfflineScan({ image: e.target.result, mode: currMode,
          lat: document.getElementById('lat').value, lon: document.getElementById('lon').value });
        hideProgress();
        btnText.textContent = 'Run Analysis'; btnIcon.textContent = 'ğŸš€'; btn.disabled = false;
        showError('scanError', T.offlineSaved || 'ğŸ“± Saved offline â€” will sync when reconnected.');
      } catch(err) {
        hideProgress(); btn.disabled = false;
        showError('scanError', 'âŒ Error saving offline: ' + err);
      }
    };
    reader.readAsDataURL(file);
    return;
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // On wide screens, show scan + result side by side
  const isWide = window.innerWidth >= 760;
  const resultCard = document.getElementById('resultCard');
  const skelScreen = document.getElementById('skelScreen');
  const resultContent = document.getElementById('resultContent');

  if (isWide) {
    document.getElementById('microPanel').classList.add('two-col');
    resultCard.style.display = 'block';
    resultCard.classList.add('result-enter');
    skelScreen.classList.add('visible');
    resultContent.style.display = 'none';
  }

  showProgress();
  setProgress(15, T.progUpload || 'Uploading imageâ€¦');

  const fd = new FormData();
  fd.append('image', file);
  fd.append('mode', currMode);
  fd.append('lat', document.getElementById('lat').value);
  fd.append('lon', document.getElementById('lon').value);

  try {
    setProgress(40, T.progSending || 'Sending to AIâ€¦');
    const res  = await fetch(API_BASE + '/analyze', { method: 'POST', body: fd });
    setProgress(75, T.progProcessing || 'Processing resultsâ€¦');
    const data = await res.json();
    setProgress(100, T.progDone || 'Done!');

    // On narrow screens: hide scan card, show result card
    if (!isWide) {
      document.getElementById('scanCard').style.display = 'none';
      resultCard.style.display = 'block';
      resultCard.classList.add('result-enter');
    }

    skelScreen.classList.remove('visible');
    resultContent.style.display = 'block';
    document.getElementById('pdfLink').href = `/report/${data.scan_id}`;

    // â”€â”€ Store full passport data for client-side PDF export â”€â”€
    const _imageUrl = await new Promise(resolve => {
      const fr = new FileReader();
      fr.onload = e => resolve(e.target.result);
      fr.readAsDataURL(file);
    });
    lastPassportData = {
      imageDataUrl: _imageUrl,
      diagnosis: data.diagnosis || {},
      weather: data.weather || {},
      mode: currMode,
      scanId: data.scan_id,
      timestamp: new Date(),
      lat: document.getElementById('lat').value,
      lon: document.getElementById('lon').value,
    };
    // Show the export passport button
    const ppBtn = document.getElementById('exportPassportBtn');
    if (ppBtn) { ppBtn.style.display = 'flex'; ppBtn.classList.add('passport-ready'); }
    document.getElementById('btnBack').classList.add('visible');

    const d = data.diagnosis || {};
    const w = data.weather   || {};

    // Translate dynamic fields if needed
    if (selectedLang !== 'en') {
      const dynFields = ['disease_name','treatment_advice','market_advice','harvest_readiness',
        'yield_estimate','soil_type','moisture_level','govt_subsidy'];
      const fieldsToTranslate = dynFields.filter(k => d[k]);
      if (fieldsToTranslate.length > 0 || w.status_reason) {
        const allTexts = [...fieldsToTranslate.map(k => d[k]), w.status_reason || ''].filter(Boolean);
        try {
          const DELIM = ' ||| ';
          const turl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${selectedLang}&dt=t&q=${encodeURIComponent(allTexts.join(DELIM))}`;
          const tres = await fetch(turl);
          if (tres.ok) {
            const tdata = await tres.json();
            let translated = '';
            for (const seg of tdata[0]) { if (seg && seg[0]) translated += seg[0]; }
            const parts = translated.split(/\s*\|\|\|\s*/);
            let idx = 0;
            fieldsToTranslate.forEach(k => { if (parts[idx]) d[k] = parts[idx]; idx++; });
            if (parts[idx] && w.status_reason) w.status_reason = parts[idx];
          }
        } catch(e) { /* use original if translation fails */ }
      }
    }

    document.getElementById('weatherText').innerText = w.status_reason || "Unavailable";
    buildDiagCards(currMode, d);

    // â”€â”€ Populate "When to Act" weather pills â”€â”€
    // Try multiple backend field-name variants, then fall back to Open-Meteo
    const _lat = parseFloat(document.getElementById('lat').value) || 20.296;
    const _lon = parseFloat(document.getElementById('lon').value) || 85.824;
    async function populateWxPills(wxData) {
      const wxPills = document.getElementById('ra-wx-pills');
      if (!wxPills) return;
      const temp  = wxData.temp_max ?? wxData.temperature ?? wxData.temp ?? null;
      const hum   = wxData.humidity ?? wxData.humidity_pct ?? wxData.relative_humidity ?? null;
      const rain  = wxData.rainfall ?? wxData.rainfall_mm ?? wxData.precipitation ?? null;
      const wind  = wxData.wind_speed ?? wxData.wind_kmh ?? wxData.wind ?? null;
      wxPills.innerHTML = '';
      [{icon:'ğŸŒ¡',label:'Temp',    val: temp  != null ? Math.round(temp)+'Â°C' : '--'},
       {icon:'ğŸ’§',label:'Humidity',val: hum   != null ? Math.round(hum)+'%'  : '--'},
       {icon:'ğŸŒ§',label:'Rain',    val: rain  != null ? parseFloat(rain).toFixed(1)+'mm' : '--'},
       {icon:'ğŸ’¨',label:'Wind',    val: wind  != null ? Math.round(wind)+'km/h' : '--'},
      ].forEach(s=>{
        const p = document.createElement('div');
        p.className = 'ra-weather-pill';
        p.innerHTML = `<span>${s.icon}</span><span class="pill-val">${s.val}</span><span>${s.label}</span>`;
        wxPills.appendChild(p);
      });
      // Update spray badge & reason using merged data
      const sprayBadge = document.getElementById('ra-spray-badge');
      if (sprayBadge) {
        const st = (wxData.spray_status||'').toLowerCase();
        // If spray_status not set by backend, compute it from wind/rain
        let badge = 'red', badgeText = 'ğŸš« Do not spray now';
        if (st === 'green') { badge='green'; badgeText='âœ… Conditions safe for spraying'; }
        else if (st === 'yellow') { badge='yellow'; badgeText='âš ï¸ Caution â€” check before spraying'; }
        else if (!st) {
          const w2 = wind ?? 0, r2 = rain ?? 0, h2 = hum ?? 0;
          if (w2 < 15 && r2 < 5) { badge='green'; badgeText='âœ… Conditions safe for spraying'; }
          else if (w2 < 25 && r2 < 10) { badge='yellow'; badgeText='âš ï¸ Caution â€” check before spraying'; }
        }
        sprayBadge.className = 'ra-spray-status ' + badge;
        sprayBadge.textContent = badgeText;
      }
      const wxReason = document.getElementById('ra-wx-reason');
      if (wxReason) wxReason.textContent = wxData.status_reason || '';
    }

    // If backend supplied enough, use it; otherwise fetch live from Open-Meteo
    const backendHasWx = (w.temp_max ?? w.temperature ?? w.temp) != null;
    if (backendHasWx) {
      await populateWxPills(w);
    } else {
      // Show dashes immediately, then update once Open-Meteo responds
      await populateWxPills(w); // renders with dashes
      try {
        const omUrl = `https://api.open-meteo.com/v1/forecast?latitude=${_lat}&longitude=${_lon}` +
          `&daily=temperature_2m_max,precipitation_sum,windspeed_10m_max&hourly=relativehumidity_2m&timezone=auto&forecast_days=1`;
        const omRes  = await fetch(omUrl);
        if (omRes.ok) {
          const omData = await omRes.json();
          const omWind = omData.daily?.windspeed_10m_max?.[0];
          const merged = {
            ...w,
            temp_max:    omData.daily?.temperature_2m_max?.[0],
            humidity:    omData.hourly?.relativehumidity_2m
                           ? Math.round(omData.hourly.relativehumidity_2m.slice(0,12).reduce((a,b)=>a+b,0)/12)
                           : null,
            rainfall:    omData.daily?.precipitation_sum?.[0],
            wind_speed:  omWind,
            spray_status: w.spray_status || (omWind < 15 ? 'green' : omWind < 25 ? 'yellow' : 'red'),
          };
          await populateWxPills(merged);
        }
      } catch(omErr) { /* keep dashes */ }
    }
    morphDashboard(currMode);

    if (d.disease_name) {
      lastDiagnosisState = { disease: d.disease_name, mode: currMode, severity: d.severity_score };
      updateDiagBadge(d.disease_name);
    }

    if (currMode === 'yield' || currMode === 'soil') {
      hideMetrics();
    } else {
      document.getElementById('metricsRow').style.display = '';
      const eco = d.sustainability_score || 5;
      animateRing('ecoRing', 'scoreEco', eco + '/10', eco / 10);
      animateRing('roiRing', 'scoreRoi', T.high || 'High', 0.82);
    }

    if (d.govt_subsidy) {
      document.getElementById('subsidyBox').style.display = 'flex';
      document.getElementById('subsidyName').innerText = d.govt_subsidy;
      const linkBtn = document.getElementById('schemeLink');
      if (d.govt_scheme_url) { linkBtn.href = d.govt_scheme_url; linkBtn.style.display = 'block'; }
      else { linkBtn.style.display = 'none'; }
    } else {
      document.getElementById('subsidyBox').style.display = 'none';
    }

    // Scroll result into view smoothly
    resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

  } catch(e) {
    skelScreen.classList.remove('visible');
    if (!isWide) resultCard.style.display = 'none';
    showError('scanError', 'Error: ' + (e.message || e));
  }

  hideProgress();
  btnText.textContent = 'Run Analysis';
  btnIcon.textContent = 'ğŸš€';
  btn.disabled = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DYNAMIC DASHBOARD MORPH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const DASHBOARD_CONFIG = {
  field: {
    icon: 'ğŸ¦ ', label: 'Disease Analysis',
    colorClass: 'mode-disease', labelColor: 'var(--c-green-400)',
    iconStyle: 'background:linear-gradient(135deg,#1a5c2a,#2d8a44);box-shadow:0 6px 18px rgba(45,138,68,0.4);',
  },
  yield: {
    icon: 'ğŸ‡', label: 'Yield & Harvest',
    colorClass: 'mode-yield', labelColor: 'var(--c-gold-light)',
    iconStyle: 'background:linear-gradient(135deg,#5c3a1a,#8a6a2d);box-shadow:0 6px 18px rgba(138,106,45,0.4);',
  },
  soil: {
    icon: 'ğŸŒ', label: 'Soil Health',
    colorClass: 'mode-soil', labelColor: '#c9813a',
    iconStyle: 'background:linear-gradient(135deg,#3a2a1a,#6b4c2a);box-shadow:0 6px 18px rgba(107,76,42,0.4);',
  },
  crate: {
    icon: 'ğŸ“¦', label: 'Produce Grading',
    colorClass: 'mode-crate', labelColor: '#6ea6e0',
    iconStyle: 'background:linear-gradient(135deg,#1a2e5c,#2d558a);box-shadow:0 6px 18px rgba(45,85,138,0.4);',
  },
};

function morphDashboard(mode) {
  const cfg = DASHBOARD_CONFIG[mode] || DASHBOARD_CONFIG.field;

  const rmhIcon = document.getElementById('rmhIcon');
  if (rmhIcon) {
    rmhIcon.textContent = cfg.icon;
    rmhIcon.className = 'rmh-icon ' + cfg.colorClass;
    rmhIcon.setAttribute('style', cfg.iconStyle);
  }

  const rmhLabel = document.getElementById('rmhLabel');
  if (rmhLabel) {
    rmhLabel.textContent = cfg.label;
    rmhLabel.style.color = cfg.labelColor;
  }

  // Morph the scan card title area
  const statusEl = document.getElementById('scannerStatusText');
  if (statusEl) statusEl.textContent = `${cfg.label} complete â€” scroll to view results`;

  // Indicate whether auto-detected or manually set
  const pill = document.getElementById('autoDetectPill');
  if (pill) pill.textContent = manualOverrideActive ? 'âš™ Manual mode' : 'âœ¦ Auto-detected';
}


async function shareReport() {
  // Grab the data currently displayed on the screen
  const disease = document.querySelector('.diag-value').innerText;
  const treatment = document.querySelectorAll('.diag-value')[2].innerText;
  const ecoScore = document.getElementById('scoreEco').innerText;

  const shareText = `*AgriUstaad Field Report* ğŸŒ¿\n\n*Diagnosis:* ${disease}\n*Treatment:* ${treatment}\n*Eco Score:* ${ecoScore}\n\nGenerated by Team AgriCore at HackNovation 2.0!`;

  if (navigator.share) {
    try {
      await navigator.share({
        title: 'AgriUstaad Diagnosis',
        text: shareText,
        url: window.location.href // Or link to your deployed app
      });
    } catch (err) {
      console.log('User cancelled share or error:', err);
    }
  } else {
    // Fallback if browser doesn't support native sharing
    alert(T.shareNotSupported || "Sharing is not supported on this browser. Copying to clipboard instead!");
    navigator.clipboard.writeText(shareText);
  }
}

function hideMetrics() {
  document.getElementById('metricsRow').style.display = 'none';
  document.getElementById('subsidyBox').style.display = 'none';
  document.getElementById('marketGrid').style.display = 'none';
}

/* â”€â”€ Gather current screen context for AI â”€â”€ */
function getScreenContext() {
  const parts = [];

  // Are we in the calendar panel?
  const calPanel = document.getElementById('calendarPanel');
  const inCalendar = calPanel && calPanel.classList.contains('open');

  if (inCalendar) {
    parts.push('[Screen: Smart Cultivation Calendar]');

    // Crop & sow date setup
    const crop     = document.getElementById('calCrop')?.value;
    const cropText = document.getElementById('calCrop')?.selectedOptions?.[0]?.text;
    const sowDate  = document.getElementById('calSowDate')?.value;
    const location = document.getElementById('calLocation')?.value;
    if (crop)     parts.push(`Crop: ${cropText || crop}`);
    if (sowDate)  parts.push(`Sowing date: ${sowDate}`);
    if (location) parts.push(`Location: ${location}`);

    // Weather banner
    const wxTemp = document.getElementById('calWxTemp')?.textContent;
    const wxDesc = document.getElementById('calWxDesc')?.textContent;
    const wxHum  = document.getElementById('calWxHum')?.textContent;
    const wxRain = document.getElementById('calWxRain')?.textContent;
    if (wxTemp && wxTemp !== '--Â°C') parts.push(`Current weather: ${wxTemp}, ${wxDesc}, Humidity ${wxHum}, Rain ${wxRain}`);

    // Risk banner
    const riskTitle = document.getElementById('calRiskTitle')?.textContent;
    const riskBadge = document.getElementById('calRiskBadgeText')?.textContent;
    if (riskTitle && riskBadge && riskBadge !== 'â€”') parts.push(`Disease risk: ${riskBadge} â€” ${riskTitle}`);

    // AI insight text
    const aiText = document.getElementById('calAiText')?.textContent;
    if (aiText && aiText !== 'Generating AI analysisâ€¦') parts.push(`AI insight: ${aiText.slice(0, 300)}`);

    // Expanded week card
    const expandedCard = document.querySelector('.cal-week-card.expanded');
    if (expandedCard) {
      const weekHeader = expandedCard.querySelector('h4')?.textContent;
      const weekDesc   = expandedCard.querySelector('.cal-week-header p')?.textContent;
      const stage      = expandedCard.querySelector('.cal-stage-pill')?.textContent?.trim();
      const activities = [...expandedCard.querySelectorAll('.cal-ws-tags')][0]?.textContent?.trim();
      const diseases   = [...expandedCard.querySelectorAll('.cal-ws-tags')][1]?.textContent?.trim();
      const spray      = expandedCard.querySelector('.cal-ws-text')?.textContent?.trim();
      if (weekHeader) parts.push(`Currently viewing week: ${weekHeader}`);
      if (weekDesc)   parts.push(`Week weather: ${weekDesc}`);
      if (stage)      parts.push(`Crop stage: ${stage}`);
      if (activities) parts.push(`Recommended activities: ${activities}`);
      if (diseases)   parts.push(`Pest/disease risks: ${diseases}`);
      if (spray)      parts.push(`Spray suggestion: ${spray}`);
    }
  } else {
    // Main app â€” try to identify active section
    const activeSection = document.querySelector('.nav-item.active')?.textContent?.trim()
                       || document.querySelector('[data-section].active')?.dataset?.section
                       || 'Main dashboard';
    parts.push(`[Screen: ${activeSection}]`);

    // Scan result if visible
    const resultCard = document.getElementById('resultCard');
    if (resultCard && resultCard.style.display !== 'none') {
      const disease  = document.getElementById('diseaseName')?.textContent;
      const severity = document.getElementById('severityBadge')?.textContent;
      const treatment= document.getElementById('treatmentText')?.textContent?.slice(0, 200);
      if (disease)   parts.push(`Scan result â€” Disease: ${disease}`);
      if (severity)  parts.push(`Severity: ${severity}`);
      if (treatment) parts.push(`Treatment: ${treatment}`);
    }
  }

  return parts.length > 1 ? parts.join(' | ') : '';
}

async function sendChat() {
  const inp = document.getElementById('chatInput');
  const txt = inp.value.trim(); if (!txt) return;
  const body = document.getElementById('chatBody');
  body.innerHTML += `<div class="msg user">${escapeHtml(txt)}</div>`;
  inp.value = ''; body.scrollTop = body.scrollHeight;
  const tid = 'typing_' + Date.now();
  body.innerHTML += `<div class="msg bot typing" id="${tid}"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
  body.scrollTop = body.scrollHeight;

  const screenCtx = getScreenContext();
  const contextNote = screenCtx
    ? `CONTEXT â€” what the farmer is currently looking at on screen: ${screenCtx}. Use this context to give specific, relevant answers. Reference actual crop names, weather values, disease names, spray suggestions etc. from the context when applicable.`
    : '';
  const langNote = selectedLang !== 'en'
    ? `IMPORTANT: You must reply entirely in ${selectedLangName}. Do not use English unless it is a technical term with no equivalent.`
    : '';

  try {
    const res  = await fetch(API_BASE + '/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
      message: txt,
      lang: selectedLang,
      lang_name: selectedLangName,
      system_note: [contextNote, langNote].filter(Boolean).join(' ')
    }) });
    const data = await res.json();
    document.getElementById(tid)?.remove();
    let reply = data.reply || '';
    // If backend doesn't natively support the language, translate the reply
    if (selectedLang !== 'en' && reply && !data.translated) {
      try {
        const turl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${selectedLang}&dt=t&q=${encodeURIComponent(reply)}`;
        const tres = await fetch(turl);
        if (tres.ok) {
          const tdata = await tres.json();
          let translated = '';
          for (const seg of tdata[0]) { if (seg && seg[0]) translated += seg[0]; }
          if (translated) reply = translated;
        }
      } catch(e) { /* use original reply if translation fails */ }
    }
    body.innerHTML += `<div class="msg bot">${escapeHtml(reply)}</div>`;
  } catch(e) {
    document.getElementById(tid)?.remove();
    body.innerHTML += `<div class="msg bot">${escapeHtml(T.chatError || 'âš ï¸ Couldn\'t reach the server.')}</div>`;
  }
  body.scrollTop = body.scrollHeight;
}

function handleChatKey(e) { if (e.key === 'Enter') sendChat(); }
function escapeHtml(str) { return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ¥ PLANT HEALTH PASSPORT â€” Client-side PDF Generator
   Generates a formal "Medical Prescription" PDF in-browser
   using jsPDF â€” no server needed, works offline.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function exportHealthPassport() {
  if (!lastPassportData) { alert('Please run a scan first.'); return; }
  if (typeof window.jspdf === 'undefined') { alert('PDF library not loaded. Check your internet connection.'); return; }

  const btn = document.getElementById('exportPassportBtn');
  btn.classList.add('generating');
  // Safely update button label â€” find by class OR fall back to the title span
  const btnTitle = btn.querySelector('.passport-btn-title') || btn.querySelector('span[style*="font-weight"]') || btn.querySelector('div span');
  const originalBtnLabel = btnTitle ? btnTitle.textContent : '';
  if (btnTitle) btnTitle.textContent = 'Generating PDFâ€¦';

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const W = 210; const H = 297;
    const MARGIN = 14;
    const GREEN  = [45, 138, 68];
    const DKGREEN= [10, 46, 20];
    const LTGREEN= [184, 240, 194];
    const GOLD   = [201, 168, 76];
    const DARK   = [8, 15, 11];
    const OFFWHT = [232, 244, 235];
    const GREY   = [140, 160, 145];

    const d   = lastPassportData.diagnosis;
    const w   = lastPassportData.weather;
    const ts  = lastPassportData.timestamp;
    const mode= lastPassportData.mode;
    const dateStr = ts.toLocaleDateString('en-IN', { day:'2-digit', month:'long', year:'numeric' });
    const timeStr = ts.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
    const rxId = 'RX-' + (lastPassportData.scanId || Math.random().toString(36).slice(2,8).toUpperCase());

    // â”€â”€ Helper: rounded rect â”€â”€
    function rrect(x, y, w, h, r, fill, stroke) {
      if (fill) { doc.setFillColor(...fill); }
      if (stroke) { doc.setDrawColor(...stroke); } else { doc.setDrawColor(0,0,0,0); }
      doc.roundedRect(x, y, w, h, r, r, fill && stroke ? 'FD' : fill ? 'F' : 'D');
    }

    // â”€â”€ Helper: text with overflow wrap â”€â”€
    function wrapText(text, x, y, maxW, lineH) {
      const lines = doc.splitTextToSize(String(text || 'â€”'), maxW);
      doc.text(lines, x, y);
      return y + lines.length * lineH;
    }

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       PAGE BACKGROUND
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    doc.setFillColor(252, 255, 252);
    doc.rect(0, 0, W, H, 'F');

    // Top dark header band
    rrect(0, 0, W, 42, 0, DKGREEN, null);

    // Decorative top stripe
    doc.setFillColor(...GREEN);
    doc.rect(0, 0, W, 3, 'F');

    // Gold accent line
    doc.setFillColor(...GOLD);
    doc.rect(0, 3, W, 1.2, 'F');

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       HEADER: LOGO + BRAND
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    // Logo badge
    rrect(MARGIN, 7, 22, 22, 5, GREEN, null);
    doc.setFontSize(13); doc.setFont('helvetica', 'bold'); doc.setTextColor(255,255,255);
    doc.text('[AU]', MARGIN + 11, 21, { align: 'center' });

    // Brand name
    doc.setFontSize(19); doc.setFont('helvetica', 'bold');
    doc.setTextColor(...OFFWHT);
    doc.text('AgriUstaad', MARGIN + 26, 17);

    // Sub-tagline
    doc.setFontSize(8); doc.setFont('helvetica', 'normal');
    doc.setTextColor(...LTGREEN);
    doc.text('AI-Powered Farm Intelligence Platform', MARGIN + 26, 23);

    // Right side: RX badge + date
    rrect(W - MARGIN - 38, 8, 38, 26, 5, [20,60,30], GOLD);
    doc.setFontSize(22); doc.setFont('helvetica', 'bold');
    doc.setTextColor(...GOLD);
    doc.text('Rx', W - MARGIN - 19, 20, { align: 'center' });
    doc.setFontSize(6.5); doc.setFont('helvetica', 'normal');
    doc.setTextColor(...LTGREEN);
    doc.text(rxId, W - MARGIN - 19, 27, { align: 'center' });

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       PRESCRIPTION TITLE RIBBON
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    rrect(MARGIN, 47, W - MARGIN*2, 13, 4, [235, 248, 237], [GREEN[0], GREEN[1], GREEN[2]]);
    doc.setFontSize(12); doc.setFont('helvetica', 'bold');
    doc.setTextColor(...GREEN);
    doc.text('PLANT HEALTH PASSPORT  Â·  MEDICAL PRESCRIPTION', W/2, 55.5, { align: 'center' });

    // Date / time strip
    doc.setFontSize(8); doc.setFont('helvetica', 'normal');
    doc.setTextColor(...GREY);
    doc.text(`Issued: ${dateStr}  Â·  ${timeStr}    |    Mode: ${mode.toUpperCase()}    |    Scan ID: ${rxId}`, W/2, 66, { align: 'center' });

    let curY = 73;

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       SCAN IMAGE  +  DIAGNOSIS PANEL (side by side)
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    const imgW = 68; const imgH = 58;
    const diagX = MARGIN + imgW + 8;
    const diagW = W - MARGIN*2 - imgW - 8;

    // Image frame
    rrect(MARGIN, curY, imgW, imgH, 5, [240,248,241], GREEN);
    try {
      doc.addImage(lastPassportData.imageDataUrl, 'JPEG', MARGIN + 2, curY + 2, imgW - 4, imgH - 4, '', 'FAST');
    } catch(e) {
      // If image fails, show placeholder
      doc.setFontSize(9); doc.setTextColor(...GREY);
      doc.text('Scan Image', MARGIN + imgW/2, curY + imgH/2, { align:'center' });
    }

    // Image label
    doc.setFontSize(7); doc.setFont('helvetica', 'normal');
    doc.setTextColor(...GREY);
    doc.text('Scanned Crop Image', MARGIN + imgW/2, curY + imgH + 4, { align:'center' });

    // Diagnosis panel
    rrect(diagX, curY, diagW, imgH, 5, [240,248,241], [GREEN[0], GREEN[1], GREEN[2]]);

    // Disease / Condition
    const condLabel = mode === 'yield' ? 'Yield Estimate' : mode === 'soil' ? 'Soil Type' : 'Condition Detected';
    const condValue = mode === 'yield' ? d.yield_estimate : mode === 'soil' ? d.soil_type : d.disease_name;
    doc.setFontSize(7.5); doc.setFont('helvetica', 'bold');
    doc.setTextColor(...GREY);
    doc.text(condLabel.toUpperCase(), diagX + 5, curY + 9);
    doc.setFontSize(13); doc.setFont('helvetica', 'bold');
    doc.setTextColor(...DKGREEN);
    const condLines = doc.splitTextToSize(String(condValue || 'No data'), diagW - 10);
    doc.text(condLines, diagX + 5, curY + 16);

    // Severity bar (for disease mode)
    if (mode !== 'yield' && mode !== 'soil' && d.severity_score != null) {
      const sev = Math.min(parseFloat(d.severity_score) || 0, 100);
      const sevY = curY + 23 + condLines.length * 4;
      doc.setFontSize(7); doc.setFont('helvetica', 'normal'); doc.setTextColor(...GREY);
      doc.text(`SEVERITY: ${sev}%`, diagX + 5, sevY);
      // Track
      rrect(diagX + 5, sevY + 2, diagW - 10, 4, 2, [210,230,215], null);
      // Fill
      const sevColor = sev > 66 ? [200,60,60] : sev > 33 ? [230,160,30] : GREEN;
      rrect(diagX + 5, sevY + 2, (diagW - 10) * sev/100, 4, 2, sevColor, null);
    }

    // Confidence
    if (d.confidence != null) {
      doc.setFontSize(7); doc.setFont('helvetica', 'normal');
      doc.setTextColor(...GREY);
      doc.text(`AI Confidence: ${d.confidence}%`, diagX + 5, curY + imgH - 18);
    }

    // AI Verified badge
    rrect(diagX + 5, curY + imgH - 12, diagW - 10, 9, 3, GREEN, null);
    doc.setFontSize(7.5); doc.setFont('helvetica', 'bold'); doc.setTextColor(255,255,255);
    doc.text('âœ“ AI VERIFIED DIAGNOSIS', diagX + diagW/2, curY + imgH - 6.5, { align:'center' });

    curY += imgH + 10;

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       PRESCRIPTION SECTION (Rx box)
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    rrect(MARGIN, curY, W - MARGIN*2, 6, 2, DKGREEN, null);
    doc.setFontSize(9); doc.setFont('helvetica', 'bold'); doc.setTextColor(...GOLD);
    doc.text('Rx  PRESCRIPTION & TREATMENT ADVISORY', MARGIN + 6, curY + 4.2);
    curY += 9;

    rrect(MARGIN, curY, W - MARGIN*2, 52, 4, [244,250,245], GREEN);
    curY += 5;

    // Treatment text
    doc.setFontSize(7.5); doc.setFont('helvetica', 'bold'); doc.setTextColor(...DKGREEN);
    doc.text('RECOMMENDED TREATMENT:', MARGIN + 5, curY);
    curY += 5;
    doc.setFontSize(8.5); doc.setFont('helvetica', 'normal'); doc.setTextColor(30,50,35);
    curY = wrapText(d.treatment_advice || 'Consult your local agricultural extension officer.', MARGIN + 5, curY, W - MARGIN*2 - 10, 5);
    curY += 4;

    // Harvest / Market / Soil advice (secondary)
    const secondary = mode === 'yield'
      ? `Harvest Readiness: ${d.harvest_readiness || 'â€”'}   |   Market Advice: ${d.market_advice || 'â€”'}`
      : mode === 'soil'
      ? `Moisture Level: ${d.moisture_level || 'â€”'}   |   Soil Condition: ${d.soil_type || 'â€”'}`
      : `Sustainability Score: ${d.sustainability_score || 'â€”'}/10   |   Govt Scheme: ${d.govt_subsidy || 'None'}`;

    doc.setFontSize(7.5); doc.setFont('helvetica', 'bold'); doc.setTextColor(...GREY);
    curY = wrapText(secondary, MARGIN + 5, curY, W - MARGIN*2 - 10, 4.5);
    curY += 8;

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       WEATHER-SAFE ADVISORY
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    rrect(MARGIN, curY, W - MARGIN*2, 6, 2, [20,60,30], null);
    doc.setFontSize(9); doc.setFont('helvetica', 'bold'); doc.setTextColor(255,255,255);
    doc.text('WEATHER-SAFE ADVISORY', MARGIN + 6, curY + 4.2);
    curY += 9;

    rrect(MARGIN, curY, W - MARGIN*2, 26, 4, [232, 244, 235], GREEN);
    curY += 6;

    // Weather stats row
    const wxStats = [
      ['ğŸŒ¡', 'Temperature', `${w.temp_max || '--'}Â°C max / ${w.temp_min || '--'}Â°C min`],
      ['ğŸ’§', 'Humidity',    `${w.humidity || '--'}%`],
      ['ğŸŒ§', 'Rainfall',   `${w.rainfall || '--'}mm`],
      ['ğŸ’¨', 'Wind',        `${w.wind_speed || '--'} km/h`],
    ];
    const colW = (W - MARGIN*2 - 10) / 4;
    wxStats.forEach(([icon, label, val], i) => {
      const cx = MARGIN + 5 + i * colW;
      doc.setFontSize(7); doc.setFont('helvetica', 'bold'); doc.setTextColor(...GREY);
      doc.text(label.toUpperCase(), cx, curY);
      doc.setFontSize(9); doc.setFont('helvetica', 'bold'); doc.setTextColor(...DKGREEN);
      doc.text(val, cx, curY + 5);
    });
    curY += 12;

    doc.setFontSize(8); doc.setFont('helvetica', 'normal'); doc.setTextColor(40,70,45);
    curY = wrapText(w.status_reason || 'Weather data unavailable for this location.', MARGIN + 5, curY, W - MARGIN*2 - 10, 4.5);
    curY += 10;

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       SHOPKEEPER INSTRUCTIONS BOX
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    rrect(MARGIN, curY, W - MARGIN*2, 34, 5, [255,252,235], GOLD);
    // Gold top stripe on box
    doc.setFillColor(...GOLD);
    doc.roundedRect(MARGIN, curY, W - MARGIN*2, 7, 5, 5, 'F');
    doc.rect(MARGIN, curY+4, W - MARGIN*2, 3, 'F');

    doc.setFontSize(9); doc.setFont('helvetica', 'bold'); doc.setTextColor(60,40,0);
    doc.text('FOR PESTICIDE SHOPKEEPER', MARGIN + 6, curY + 5.5);
    curY += 10;

    doc.setFontSize(8); doc.setFont('helvetica', 'normal'); doc.setTextColor(80,60,0);
    const shopNote = 'This is an AI-certified Plant Health Passport. The farmer has been diagnosed with the condition above. Please supply the exact treatment listed in the Prescription section. No further explanation from the farmer is required.';
    curY = wrapText(shopNote, MARGIN + 5, curY, W - MARGIN*2 - 10, 4.8);
    curY += 3;
    doc.setFontSize(7.5); doc.setFont('helvetica', 'bold'); doc.setTextColor(...GOLD);
    doc.text('Issued by AgriUstaad AI  Â·  Powered by Team AgriCore', MARGIN + 5, curY);
    curY += 10;

    /* â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
       FOOTER
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” */
    // Bottom green band
    rrect(0, H - 16, W, 16, 0, DKGREEN, null);
    doc.setFillColor(...GREEN);
    doc.rect(0, H - 2, W, 2, 'F');
    doc.setFillColor(...GOLD);
    doc.rect(0, H - 3, W, 1, 'F');

    doc.setFontSize(7); doc.setFont('helvetica', 'normal'); doc.setTextColor(...LTGREEN);
    doc.text('AgriUstaad  Â·  Plant Health Passport  Â·  AI-Certified Document', W/2, H - 9, { align:'center' });
    doc.setTextColor(...GREY);
    doc.text('This document is computer-generated by AI. Always consult a certified agronomist for critical decisions.', W/2, H - 4.5, { align:'center' });

    // Save
    const fname = `AgriUstaad_Passport_${rxId}_${ts.toISOString().slice(0,10)}.pdf`;
    doc.save(fname);

  } catch(err) {
    console.error('Passport generation error:', err);
    alert('Could not generate PDF: ' + err.message);
  } finally {
    btn.classList.remove('generating');
    if (btnTitle) btnTitle.textContent = originalBtnLabel || 'Download PDF';
  }
}


const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
if (SR) {
  const r = new SR();
  r.onstart  = () => document.getElementById('voiceBtn').classList.add('listening');
  r.onend    = () => document.getElementById('voiceBtn').classList.remove('listening');
  r.onresult = e => { const t = e.results[0][0].transcript.toLowerCase(); if(t.includes('scan')||t.includes('analyze')) runAnalysis(); };
  window.startVoiceScan = () => r.start();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ“¶ OFFLINE MODE: SCAN NOW, SYNC LATER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  let offlineDB = null;

  // Safely initialize the database only when needed
  function initDB() {
    return new Promise((resolve, reject) => {
      if (offlineDB) return resolve(offlineDB);
      const req = indexedDB.open("AgriUstaad_Offline", 1);
      req.onupgradeneeded = (e) => {
        let db = e.target.result;
        if (!db.objectStoreNames.contains("scans")) {
          db.createObjectStore("scans", { keyPath: "id", autoIncrement: true });
        }
      };
      req.onsuccess = (e) => {
        offlineDB = e.target.result;
        resolve(offlineDB);
      };
      req.onerror = (e) => reject(e.target.error);
    });
  }

  // Save the scan with a reliable Promise
  async function saveOfflineScan(data) {
    const db = await initDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction("scans", "readwrite");
      tx.objectStore("scans").add(data);
      tx.oncomplete = () => resolve();
      tx.onerror = (e) => reject(e.target.error);
    });
  }

  // Background Sync Logic
  async function checkOfflineQueue() {
    if (!navigator.onLine) return; // Don't sync if still offline

    try {
      const db = await initDB();
      const tx = db.transaction("scans", "readonly");
      const req = tx.objectStore("scans").getAll();

      req.onsuccess = async () => {
        const scans = req.result;
        if (scans && scans.length > 0) {
          
          // Notify the user sync is happening
          showError('scanError', `ğŸ”„ ${T.syncingScans || 'Internet restored! Syncing ' + scans.length + ' offline scans to the cloud...'}`);
          document.getElementById('scanError').style.background = 'rgba(201,168,76,0.15)'; 
          document.getElementById('scanError').style.borderColor = 'var(--c-gold)';

          for (let s of scans) {
            try {
              // Convert Base64 back to an image file
              const res = await fetch(s.image);
              const blob = await res.blob();
              
              const fd = new FormData();
              fd.append('image', blob, 'offline_scan.jpg');
              fd.append('mode', s.mode);
              fd.append('lat', s.lat);
              fd.append('lon', s.lon);

              // Silently send to Flask backend
              await fetch(API_BASE + '/analyze', { method: 'POST', body: fd });

              // Remove from local queue
              const delTx = db.transaction("scans", "readwrite");
              delTx.objectStore("scans").delete(s.id);
            } catch (err) {
              console.error("Background sync failed for a scan", err);
            }
          }
          
          // Success cleanup
          dismissError('scanError');
          alert(T.syncDone || "âœ… All offline scans have been successfully analyzed and saved to your History Map!");
          document.getElementById('scanError').style.background = ''; // Reset color
          document.getElementById('scanError').style.borderColor = '';
        }
      };
    } catch (e) {
      console.error("Queue check failed:", e);
    }
  }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UNIFIED COMMAND DECK â€” Macro-to-Micro Toggle Engine
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Global State â”€â”€ */
let dashMode           = 'micro';
let radarMapInstance   = null;
let radarHeatLayer     = null;
let radarMarkersLayer  = null;
let lastDiagnosisState = null;
let lastPassportData = null; // stores full data for PDF export

/* â”€â”€ Toggle Track Positioning â”€â”€ */
function positionToggleTrack(mode) {
  const pill  = document.getElementById('deckTogglePill');
  const track = document.getElementById('deckTrack');
  const btnMi = document.getElementById('btnMicro');
  const btnMa = document.getElementById('btnMacro');
  if (!pill || !track || !btnMi || !btnMa) return;
  const pillRect = pill.getBoundingClientRect();
  const r = mode === 'micro' ? btnMi.getBoundingClientRect() : btnMa.getBoundingClientRect();
  track.style.left  = (r.left - pillRect.left) + 'px';
  track.style.width = r.width + 'px';
  if (mode === 'micro') { btnMi.classList.add('active'); btnMa.classList.remove('active'); }
  else                  { btnMa.classList.add('active'); btnMi.classList.remove('active'); }
}
window.addEventListener('load', () => requestAnimationFrame(() => positionToggleTrack('micro')));
window.addEventListener('resize', () => positionToggleTrack(dashMode));

/* â”€â”€ Activate MICRO View â”€â”€ */
function activateMicroView() {
  if (dashMode === 'micro') return;
  dashMode = 'micro';
  positionToggleTrack('micro');

  const micro   = document.getElementById('microPanel');
  const macro   = document.getElementById('macroPanel');
  const container = document.getElementById('panelContainer');
  const liveBdg = document.getElementById('deckLiveBadge');

  document.getElementById('deckTitleMain').textContent = 'ğŸ”¬ AI Field Scanner';
  document.getElementById('deckTitleSub').textContent  = 'Select a tool to begin analysis';
  liveBdg.style.display = 'none';
  document.getElementById('commandDeck').classList.remove('wide-mode');

  // Lock height to current size before swap
  container.style.height = container.offsetHeight + 'px';

  macro.classList.remove('panel-visible');

  setTimeout(() => {
    macro.style.visibility = 'hidden';
    micro.classList.remove('panel-hidden');
    // After micro renders, release the locked height
    setTimeout(() => { container.style.height = ''; }, 300);
  }, 220);
}

/* â”€â”€ Activate MACRO View â”€â”€ */
function activateMacroView() {
  if (dashMode === 'macro') return;
  dashMode = 'macro';
  positionToggleTrack('macro');

  const micro   = document.getElementById('microPanel');
  const macro   = document.getElementById('macroPanel');
  const container = document.getElementById('panelContainer');
  const liveBdg = document.getElementById('deckLiveBadge');

  document.getElementById('deckTitleMain').textContent = 'ğŸŒ Community Disease Radar';
  document.getElementById('deckTitleSub').textContent  = 'Live regional disease intelligence Â· 50km radius';
  liveBdg.style.display = 'flex';
  document.getElementById('commandDeck').classList.add('wide-mode');

  // Lock height to current size before swap
  container.style.height = container.offsetHeight + 'px';

  micro.classList.add('panel-hidden');

  setTimeout(() => {
    macro.style.visibility = 'visible';
    macro.classList.add('panel-visible');
    // After macro renders, release the locked height
    setTimeout(() => {
      container.style.height = '';
      initOrRefreshRadarMap();
      if (!document.getElementById('wd-7day').querySelector('.wd-day-card')) initWeatherDashboard();
    }, 300);
  }, 220);

  if (lastDiagnosisState) updateLogicBoxWithDiagnosis(lastDiagnosisState);
}

/* â”€â”€ Simulated Disease Hotspot Data (Odisha region) â”€â”€ */
const HOTSPOT_DATA = [
  { lat:20.296, lon:85.824, i:0.9,  disease:'Leaf Blast (Pyricularia)',    severity:'Critical', time:'2h ago',  crop:'Rice',   marker:true },
  { lat:20.321, lon:85.867, i:0.85, disease:'Leaf Blast (Pyricularia)',    severity:'High',     time:'4h ago',  crop:'Rice',   marker:true },
  { lat:20.258, lon:85.801, i:0.80, disease:'Leaf Blast (Pyricularia)',    severity:'High',     time:'6h ago',  crop:'Rice',   marker:false },
  { lat:21.462, lon:85.931, i:0.75, disease:'Brown Plant Hopper',          severity:'High',     time:'1h ago',  crop:'Paddy',  marker:true },
  { lat:21.491, lon:85.898, i:0.70, disease:'Brown Plant Hopper',          severity:'Medium',   time:'5h ago',  crop:'Paddy',  marker:false },
  { lat:21.430, lon:85.960, i:0.65, disease:'Brown Plant Hopper',          severity:'Medium',   time:'8h ago',  crop:'Paddy',  marker:false },
  { lat:21.489, lon:85.970, i:0.60, disease:'Brown Plant Hopper',          severity:'High',     time:'3h ago',  crop:'Paddy',  marker:true },
  { lat:21.500, lon:85.910, i:0.55, disease:'Brown Plant Hopper',          severity:'Medium',   time:'9h ago',  crop:'Paddy',  marker:false },
  { lat:21.450, lon:85.880, i:0.58, disease:'Brown Plant Hopper',          severity:'Medium',   time:'11h ago', crop:'Paddy',  marker:false },
  { lat:21.490, lon:86.010, i:0.50, disease:'Brown Plant Hopper',          severity:'Low',      time:'14h ago', crop:'Paddy',  marker:false },
  { lat:20.450, lon:85.880, i:0.60, disease:'Early Blight (Alternaria)',   severity:'Medium',   time:'3h ago',  crop:'Tomato', marker:true },
  { lat:20.480, lon:85.920, i:0.55, disease:'Early Blight (Alternaria)',   severity:'Low',      time:'12h ago', crop:'Tomato', marker:false },
  { lat:20.950, lon:84.010, i:0.65, disease:'Yellow Rust (Stripe Rust)',   severity:'Medium',   time:'7h ago',  crop:'Wheat',  marker:true },
  { lat:20.970, lon:84.060, i:0.60, disease:'Yellow Rust (Stripe Rust)',   severity:'Medium',   time:'10h ago', crop:'Wheat',  marker:false },
  { lat:20.930, lon:83.980, i:0.55, disease:'Yellow Rust (Stripe Rust)',   severity:'Low',      time:'16h ago', crop:'Wheat',  marker:false },
  { lat:19.810, lon:85.020, i:0.70, disease:'Late Blight (Phytophthora)',  severity:'High',     time:'2h ago',  crop:'Potato', marker:true },
  { lat:19.830, lon:85.060, i:0.65, disease:'Late Blight (Phytophthora)',  severity:'Medium',   time:'6h ago',  crop:'Potato', marker:false },
  { lat:22.250, lon:84.860, i:0.50, disease:'Smut (Ustilago)',             severity:'Low',      time:'20h ago', crop:'Maize',  marker:true },
  { lat:21.930, lon:86.730, i:0.60, disease:'Sheath Blight (Rhizoctonia)',severity:'Medium',    time:'5h ago',  crop:'Rice',   marker:true },
  { lat:21.960, lon:86.760, i:0.55, disease:'Sheath Blight (Rhizoctonia)',severity:'Medium',    time:'11h ago', crop:'Rice',   marker:false },
  { lat:20.150, lon:85.680, i:0.45, disease:'Bacterial Leaf Blight',       severity:'Low',      time:'18h ago', crop:'Rice',   marker:false },
  { lat:20.500, lon:84.900, i:0.50, disease:'Bacterial Leaf Blight',       severity:'Medium',   time:'8h ago',  crop:'Rice',   marker:true },
  { lat:20.700, lon:83.870, i:0.40, disease:'Powdery Mildew',              severity:'Low',      time:'22h ago', crop:'Wheat',  marker:false },
];

function diseaseColor(disease) {
  if (/Blast|Blight|Late|Rot/i.test(disease))     return '#e05252';
  if (/Hopper|Rust|Smut|Worm/i.test(disease))     return '#f0a830';
  return '#5ecb74';
}

/* â”€â”€ Init / refresh Leaflet radar map â”€â”€ */
function initOrRefreshRadarMap() {
  const container = document.getElementById('communityMap');
  if (!container) return;

  const userLat = parseFloat(document.getElementById('lat')?.value || 20.296);
  const userLon = parseFloat(document.getElementById('lon')?.value || 85.824);

  if (radarMapInstance) {
    radarMapInstance.invalidateSize();
    return;
  }

  radarMapInstance = L.map('communityMap', {
    center: [20.5, 85.0], zoom: 7,
    zoomControl: true, attributionControl: true,
  });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 18,
  }).addTo(radarMapInstance);

  // Heatmap layer
  if (typeof L.heatLayer === 'function') {
    L.heatLayer(HOTSPOT_DATA.map(p => [p.lat, p.lon, p.i]), {
      radius: 40, blur: 30, maxZoom: 12,
      gradient: { 0.2:'#1a5c2a', 0.45:'#f0a830', 0.70:'#e05252', 1.0:'#ff2020' },
      max: 1.0, minOpacity: 0.3,
    }).addTo(radarMapInstance);
  }

  // Cluster markers
  const markerGroup = L.layerGroup().addTo(radarMapInstance);
  HOTSPOT_DATA.filter(p => p.marker).forEach(p => {
    const col  = diseaseColor(p.disease);
    const icon = L.divIcon({
      className: '',
      html: `<div style="width:30px;height:30px;border-radius:50%;background:${col}99;border:2px solid ${col};display:flex;align-items:center;justify-content:center;box-shadow:0 0 12px ${col}88;cursor:pointer;">
               <span style="color:#fff;font-size:13px;font-weight:700;">âš </span>
             </div>`,
      iconSize: [30, 30], iconAnchor: [15, 15],
    });
    L.marker([p.lat, p.lon], { icon })
     .bindPopup(`<div class="map-pin-popup">
       <div class="pp-disease">${p.disease}</div>
       <div class="pp-meta">ğŸŒ¾ ${p.crop} Â· ğŸ• ${p.time}</div>
       <div class="pp-severity">âš ï¸ Severity: <b>${p.severity}</b></div>
     </div>`, { maxWidth: 230 })
     .addTo(markerGroup);
  });

  // User location
  const userIcon = L.divIcon({
    className: '',
    html: `<div style="width:18px;height:18px;border-radius:50%;background:#5ecb74;border:3px solid #fff;box-shadow:0 0 14px #5ecb74aa;"></div>`,
    iconSize: [18, 18], iconAnchor: [9, 9],
  });
  L.marker([userLat, userLon], { icon: userIcon, zIndexOffset: 1000 })
   .bindPopup('<div class="map-pin-popup"><div class="pp-disease" style="color:#5ecb74;">ğŸ“ Your Location</div></div>')
   .addTo(radarMapInstance);

  // 5km radius
  L.circle([userLat, userLon], {
    radius: 5000,
    color: 'rgba(45,138,68,0.7)', weight: 1.5, dashArray: '6,5',
    fillColor: 'rgba(45,138,68,0.05)', fillOpacity: 1,
  }).addTo(radarMapInstance);

  setTimeout(() => radarMapInstance.invalidateSize(), 250);
}

/* â”€â”€ Update AI logic box when a diagnosis is present â”€â”€ */
function updateLogicBoxWithDiagnosis(diag) {
  if (!diag || !diag.disease) return;
  const name = diag.disease;
  const matches = HOTSPOT_DATA.filter(p => {
    const pD = p.disease.toLowerCase(), nD = name.toLowerCase();
    return pD.includes(nD.split(' ')[0]) || nD.includes(pD.split(' ')[0]);
  });

  const banner = document.getElementById('diagMatchBanner');
  const txt    = document.getElementById('diagMatchText');
  if (matches.length > 0) {
    txt.innerHTML = `Your scan of <b>${name}</b> matches <b>${matches.length} nearby community report${matches.length>1?'s':''}</b> â€” tap red markers for details.`;
    banner.classList.add('visible');
    document.getElementById('lsActiveThreats').textContent = Math.min(matches.length + 2, 9);
    document.getElementById('lsNearbyReports').textContent = matches.length + 5;
    const alerts = document.getElementById('logicAlerts');
    if (alerts && alerts.children[0]) {
      alerts.children[0].querySelector('.alert-txt').innerHTML =
        `<b>${name}:</b> Your scan confirmed. ${matches.length} nearby case${matches.length>1?'s':''}. ${diag.severity ? 'Severity: ' + diag.severity + '%.' : ''} Take preventive action immediately.`;
    }
  } else {
    if (banner) banner.classList.remove('visible');
  }
}

/* â”€â”€ Update deck diagnosis badge â”€â”€ */
function updateDiagBadge(diseaseName) {
  const badge = document.getElementById('deckDiagBadge');
  const label = document.getElementById('deckDiagLabel');
  if (!badge || !label) return;
  label.textContent = diseaseName.length > 22 ? diseaseName.substring(0,20) + 'â€¦' : diseaseName;
  badge.classList.add('visible');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SMART CULTIVATION CALENDAR â€” COMPLETE ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ Crop Knowledge Base â”€â”€ */
const CROP_DB = {
  rice: {
    name: "Rice / Paddy", emoji: "ğŸŒ¾", duration: 120,
    stages: [
      { name:"Germination",  weeks:[1,2],   activities:["Prepare nursery beds","Apply basal fertiliser","Ensure uniform moisture"], icon:"ğŸŒ±" },
      { name:"Vegetative",   weeks:[3,6],   activities:["Transplant seedlings","First weeding","Apply nitrogen (N) top-dress","Monitor for stem borer"], icon:"ğŸŒ¿" },
      { name:"Tillering",    weeks:[7,10],  activities:["Second nitrogen dose","Deep water irrigation","Monitor for BPH (Brown Plant Hopper)"], icon:"ğŸŒ¾" },
      { name:"Reproductive", weeks:[11,14], activities:["Spray fungicide for blast","Maintain water level","Avoid stress during panicle initiation"], icon:"ğŸŒ¸" },
      { name:"Ripening",     weeks:[15,17], activities:["Drain field 2 weeks before harvest","Scout for neck blast","Arrange harvesting equipment"], icon:"ğŸš" },
    ],
    diseases: {
      high_humidity: ["Blast (Pyricularia oryzae)","Brown Spot","Sheath Blight"],
      high_temp:     ["Bacterial Leaf Blight","Tungro Virus (via leafhopper)"],
      low_temp:      ["Cold Injury","Spikelet Sterility"],
      rain:          ["Stem Rot","Foot Rot"],
      dry:           ["White Ear","Spikelet Sterility (drought stress)"],
    },
    sprays: {
      fungal:  ["Tricyclazole 75% WP @ 0.6g/L","Propiconazole 25% EC @ 1ml/L","Hexaconazole @ 2ml/L"],
      insect:  ["Chlorpyrifos 20% EC @ 2.5ml/L","Thiamethoxam 25% WG @ 0.3g/L","Cartap Hydrochloride @ 1g/L"],
      bacterial:["Copper Oxychloride 50% WP @ 2.5g/L","Streptomycin + Copper Oxychloride"],
    }
  },
  wheat: {
    name: "Wheat", emoji: "ğŸŒ¿", duration: 120,
    stages: [
      { name:"Sowing",       weeks:[1,2],   activities:["Treat seeds with Thiram","Apply phosphorus basal dose","Sow at optimum depth 5-6cm"], icon:"ğŸŒ±" },
      { name:"CRI Stage",    weeks:[3,4],   activities:["First irrigation at CRI","Apply nitrogen split dose","Watch for aphids"], icon:"ğŸŒ¿" },
      { name:"Tillering",    weeks:[5,7],   activities:["Apply 2nd nitrogen","Scout for rust symptoms","Weed management"], icon:"ğŸŒ¾" },
      { name:"Jointing",     weeks:[8,10],  activities:["Irrigation critical","Spray for yellow rust if observed","Apply potassium"], icon:"ğŸ”—" },
      { name:"Grain Fill",   weeks:[11,14], activities:["Protect from rust","Avoid heat stress irrigation","Monitor for Karnal Bunt"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Yellow Rust (Stripe Rust)","Brown Rust","Powdery Mildew"],
      high_temp:     ["Karnal Bunt","Head Scab","Flag Leaf Blight"],
      low_temp:      ["Frost Damage"],
      rain:          ["Loose Smut","Crown Rot"],
      dry:           ["Drought Stress","Reduced Grain Fill"],
    },
    sprays: {
      fungal:  ["Propiconazole 25% EC @ 1ml/L","Tebuconazole 25.9% EC @ 1ml/L","Mancozeb 75% WP @ 2.5g/L"],
      insect:  ["Dimethoate 30% EC @ 2ml/L","Imidacloprid 17.8% SL @ 0.5ml/L"],
      bacterial:["Copper Hydroxide 77% WP @ 2g/L"],
    }
  },
  tomato: {
    name: "Tomato", emoji: "ğŸ…", duration: 90,
    stages: [
      { name:"Nursery",      weeks:[1,3],   activities:["Sterilise nursery soil","Sow seeds in raised beds","Apply Trichoderma @ 5g/kg seed"], icon:"ğŸŒ±" },
      { name:"Transplanting",weeks:[4,5],   activities:["Transplant 25-day seedlings","Apply starter fertiliser","Stake plants","Mulch for moisture"], icon:"ğŸŒ¿" },
      { name:"Vegetative",   weeks:[6,8],   activities:["Train vines","Apply NPK 19:19:19","Scout for whiteflies & leaf curl virus"], icon:"ğŸŒ¿" },
      { name:"Flowering",    weeks:[9,11],  activities:["Spray Boron for fruit set","Monitor for early blight","Avoid excess nitrogen"], icon:"ğŸŒ¸" },
      { name:"Fruiting",     weeks:[12,13], activities:["Spray calcium for blossom end rot","Control fruit borer","Reduce irrigation before harvest"], icon:"ğŸ…" },
    ],
    diseases: {
      high_humidity: ["Early Blight (Alternaria)","Late Blight (Phytophthora)","Botrytis","Septoria Leaf Spot"],
      high_temp:     ["Fruit Cracking","Blossom Drop","Bacterial Canker"],
      low_temp:      ["Chilling Injury","Flower Abortion"],
      rain:          ["Late Blight","Root Rot","Damping Off"],
      dry:           ["Blossom End Rot","Spider Mites"],
    },
    sprays: {
      fungal:  ["Mancozeb 75% WP @ 2g/L","Cymoxanil + Mancozeb @ 2g/L","Azoxystrobin 23% SC @ 1ml/L"],
      insect:  ["Spinosad 45% SC @ 0.3ml/L","Imidacloprid 17.8% @ 0.5ml/L","Abamectin 1.8% EC @ 1ml/L"],
      bacterial:["Copper Oxychloride @ 3g/L","Kasugamycin 3% SL @ 2ml/L"],
    }
  },
  cotton: {
    name: "Cotton", emoji: "ğŸŒ¸", duration: 180,
    stages: [
      { name:"Germination",  weeks:[1,2],   activities:["Treat seeds with Imidacloprid","Maintain optimum soil moisture","Gap filling after 1 week"], icon:"ğŸŒ±" },
      { name:"Seedling",     weeks:[3,5],   activities:["First hoeing","Apply basal NPK","Scout for sucking pests"], icon:"ğŸŒ¿" },
      { name:"Vegetative",   weeks:[6,10],  activities:["Apply nitrogen","Monitor for pink bollworm","Install pheromone traps"], icon:"ğŸŒ¿" },
      { name:"Boll Formation",weeks:[11,15],activities:["Spray for bollworm","Apply potassium","Irrigate at critical stages"], icon:"ğŸŒ¸" },
      { name:"Boll Opening", weeks:[16,20], activities:["Defoliation if required","Harvest open bolls","Control sucking pests"], icon:"â˜ï¸" },
    ],
    diseases: {
      high_humidity: ["Grey Mildew (Ramularia)","Bacterial Blight","Leaf Spots"],
      high_temp:     ["Heat Stress","Premature Boll Drop"],
      low_temp:      ["Stunted Growth"],
      rain:          ["Root Rot","Seedling Damping Off"],
      dry:           ["Drought Stress","Square Shedding"],
    },
    sprays: {
      fungal:  ["Copper Oxychloride @ 3g/L","Mancozeb 75% WP @ 2.5g/L"],
      insect:  ["Profenofos 50% EC @ 2ml/L","Emamectin Benzoate 5% SG @ 0.4g/L","Lambda-cyhalothrin 5% EC @ 1ml/L"],
      bacterial:["Streptomycin Sulfate @ 0.1g/L + Copper @ 3g/L"],
    }
  },
  maize: {
    name: "Maize / Corn", emoji: "ğŸŒ½", duration: 100,
    stages: [
      { name:"Emergence",    weeks:[1,2],   activities:["Ensure uniform germination","Watch for cutworm","Apply starter N-P-K"], icon:"ğŸŒ±" },
      { name:"V-Stage",      weeks:[3,5],   activities:["Side-dress nitrogen","Scout for Fall Armyworm","First irrigation"], icon:"ğŸŒ¿" },
      { name:"Tasseling",    weeks:[6,8],   activities:["Critical water stage","Spray for FAW if needed","Detassel in hybrid seed production"], icon:"ğŸŒ½" },
      { name:"Grain Fill",   weeks:[9,11],  activities:["Maintain adequate moisture","Watch for ear rot","Apply potassium foliar"], icon:"ğŸŒ½" },
      { name:"Maturity",     weeks:[12,14], activities:["Check for aflatoxin risk","Harvest at 25% moisture","Dry to 12-13% for storage"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Turcicum Leaf Blight","Common Rust","Banded Leaf & Sheath Blight"],
      high_temp:     ["Silk Clipping","Heat Stress on Pollen"],
      low_temp:      ["Chilling Injury at Germination"],
      rain:          ["Ear Rot (Fusarium)","Root Rot","Crazy Top Downy Mildew"],
      dry:           ["Drought Stress","Poor Grain Fill"],
    },
    sprays: {
      fungal:  ["Tebuconazole 25.9% EC @ 1ml/L","Mancozeb 75% WP @ 2g/L","Propiconazole @ 1ml/L"],
      insect:  ["Spinosad 45% SC @ 0.3ml/L","Chlorantraniliprole 18.5% SC @ 0.5ml/L","Emamectin @ 0.4g/L"],
      bacterial:["Copper Hydroxide @ 2g/L"],
    }
  },
  soybean: {
    name: "Soybean", emoji: "ğŸ«˜", duration: 90,
    stages: [
      { name:"Germination",  weeks:[1,2],   activities:["Rhizobium inoculation","Apply phosphorus","Avoid waterlogging"], icon:"ğŸŒ±" },
      { name:"Vegetative",   weeks:[3,5],   activities:["Weed management","Apply micronutrients","Scout for girdle beetle"], icon:"ğŸŒ¿" },
      { name:"Flowering",    weeks:[6,8],   activities:["Spray Boron","Avoid stress","Monitor for pod borer"], icon:"ğŸŒ¸" },
      { name:"Pod Fill",     weeks:[9,11],  activities:["Protect from pod borer","Apply potassium","Irrigation if dry"], icon:"ğŸ«˜" },
      { name:"Maturity",     weeks:[12,13], activities:["Harvest at 13-15% moisture","Control pod shatter","Dry and store"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Bacterial Pustule","Frogeye Leaf Spot","Aerial Blight"],
      high_temp:     ["Heat Stress on Pods","White Fly (vector)"],
      low_temp:      ["Delayed Maturity"],
      rain:          ["Phytophthora Root Rot","Sudden Death Syndrome"],
      dry:           ["Drought Stress","Reduced Nodulation"],
    },
    sprays: {
      fungal:  ["Carbendazim 50% WP @ 1g/L","Hexaconazole 5% EC @ 2ml/L"],
      insect:  ["Quinalphos 25% EC @ 2ml/L","Triazophos 40% EC @ 2ml/L"],
      bacterial:["Copper Oxychloride @ 3g/L"],
    }
  },
  potato: {
    name: "Potato", emoji: "ğŸ¥”", duration: 90,
    stages: [
      { name:"Planting",     weeks:[1,2],   activities:["Use certified seed tubers","Treat with Carbendazim","Apply basal fertiliser","Bed/ridge preparation"], icon:"ğŸŒ±" },
      { name:"Emergence",    weeks:[3,4],   activities:["Earthing up","Apply split nitrogen","Scout for aphids (PVY vector)"], icon:"ğŸŒ¿" },
      { name:"Vegetative",   weeks:[5,7],   activities:["Hilling","Apply potassium","Monitor for late blight"], icon:"ğŸŒ¿" },
      { name:"Tuber Bulking",weeks:[8,10],  activities:["Spray fungicide for late blight","Maintain moisture","Foliar potassium"], icon:"ğŸ¥”" },
      { name:"Maturity",     weeks:[11,13], activities:["Vine killing 2 weeks before harvest","Reduce irrigation","Harvest at skin set"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Late Blight (Phytophthora infestans)","Early Blight","Soft Rot"],
      high_temp:     ["Heat Canker","Hollow Heart","Second Growth"],
      low_temp:      ["Blackleg","Frost Damage"],
      rain:          ["Late Blight","Scab","Wet Rot"],
      dry:           ["Common Scab","Drought Stress","Internal Browning"],
    },
    sprays: {
      fungal:  ["Cymoxanil 8% + Mancozeb 64% @ 3g/L","Metalaxyl 8% + Mancozeb 64% @ 2.5g/L","Fluopicolide 39.35% SC @ 0.75ml/L"],
      insect:  ["Dimethoate 30% @ 2ml/L","Imidacloprid 17.8% SL @ 0.5ml/L"],
      bacterial:["Copper Hydroxide 77% WP @ 2g/L","Streptomycin @ 0.5g/L"],
    }
  },
  onion: {
    name: "Onion", emoji: "ğŸ§…", duration: 120,
    stages: [
      { name:"Nursery",      weeks:[1,4],   activities:["Raise nursery in raised beds","Apply Trichoderma","Water twice daily"], icon:"ğŸŒ±" },
      { name:"Transplanting",weeks:[5,6],   activities:["Transplant 6-week seedlings","Apply basal NPK","Irrigate at transplanting"], icon:"ğŸŒ¿" },
      { name:"Vegetative",   weeks:[7,10],  activities:["Weed management","Apply nitrogen","Scout for Thrips"], icon:"ğŸŒ¿" },
      { name:"Bulbing",      weeks:[11,14], activities:["Apply potassium for bulb size","Reduce nitrogen","Manage Purple Blotch"], icon:"ğŸ§…" },
      { name:"Maturity",     weeks:[15,17], activities:["Stop irrigation 10 days before","Bend tops","Harvest when 50% tops fall"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Purple Blotch","Downy Mildew","Botrytis Leaf Blight"],
      high_temp:     ["Bolting","Reduced Bulb Size"],
      low_temp:      ["Bolting (vernalisation)"],
      rain:          ["Neck Rot","Base Rot","Soft Rot"],
      dry:           ["Drought Stress","Thrips Surge"],
    },
    sprays: {
      fungal:  ["Iprodione 50% WP @ 1.5g/L","Mancozeb 75% WP @ 2g/L","Propiconazole 25% EC @ 1ml/L"],
      insect:  ["Fipronil 5% SC @ 1.5ml/L","Spinosad 45% SC @ 0.3ml/L","Dimethoate 30% EC @ 2ml/L"],
      bacterial:["Copper Oxychloride @ 3g/L"],
    }
  },
  sugarcane: {
    name: "Sugarcane", emoji: "ğŸ‹", duration: 300,
    stages: [
      { name:"Planting",     weeks:[1,4],   activities:["Use 3-budded setts","Treat with Carbendazim","Apply basal NPK","Furrow irrigation"], icon:"ğŸŒ±" },
      { name:"Germination",  weeks:[5,8],   activities:["Gap filling","Scout for top borer","Apply nitrogen"], icon:"ğŸŒ¿" },
      { name:"Tillering",    weeks:[9,16],  activities:["Earthing up","Apply 2nd N dose","Propping if required"], icon:"ğŸŒ¿" },
      { name:"Grand Growth", weeks:[17,28], activities:["Irrigate every 10-15 days","Spray for red rot","Remove ratoon stumps"], icon:"ğŸ‹" },
      { name:"Maturity",     weeks:[29,40], activities:["Trash mulching","Check Brix %","Harvest when Brix 18-20%"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Red Rot","Smut","Pokkah Boeng"],
      high_temp:     ["Ratoon Stunting Disease","Heat Stress"],
      low_temp:      ["Frost Damage"],
      rain:          ["Root Rot","Pythium Root Disease"],
      dry:           ["Drought Stress","Reduced Juice Quality"],
    },
    sprays: {
      fungal:  ["Carbendazim 50% WP @ 1g/L","Copper Oxychloride @ 3g/L"],
      insect:  ["Chlorpyrifos 20% EC @ 2.5ml/L","Fipronil 5% SC @ 1.5ml/L"],
      bacterial:["Copper Hydroxide @ 2g/L"],
    }
  },
  groundnut: {
    name: "Groundnut", emoji: "ğŸ¥œ", duration: 100,
    stages: [
      { name:"Germination",  weeks:[1,2],   activities:["Use treated seeds (Thiram+Carbendazim)","Ensure good tilth","Apply gypsum at sowing"], icon:"ğŸŒ±" },
      { name:"Vegetative",   weeks:[3,5],   activities:["Weed management","Apply gypsum at pegging","Scout for leaf miner"], icon:"ğŸŒ¿" },
      { name:"Pegging",      weeks:[6,8],   activities:["Light irrigation","Apply calcium","Monitor for white mould"], icon:"ğŸŒ¸" },
      { name:"Pod Fill",     weeks:[9,11],  activities:["Maintain moisture","Apply potassium","Spray for tikka leaf spot"], icon:"ğŸ¥œ" },
      { name:"Maturity",     weeks:[12,14], activities:["Harvest test (nut hardness)","Reduce irrigation","Avoid over-mature harvesting"], icon:"ğŸŒ¾" },
    ],
    diseases: {
      high_humidity: ["Early Leaf Spot (Tikka)","Late Leaf Spot","Bud Necrosis (TSWV)"],
      high_temp:     ["Aflatoxin Risk","Heat Stress at Pegging"],
      low_temp:      ["Stunted Growth"],
      rain:          ["Crown Rot","Stem Rot","Sclerotinia Blight"],
      dry:           ["Drought Stress","Aspergillus Crown Rot"],
    },
    sprays: {
      fungal:  ["Tebuconazole 25.9% EC @ 1ml/L","Chlorothalonil 75% WP @ 2g/L","Iprodione 50% WP @ 1.5g/L"],
      insect:  ["Thiamethoxam 25% WG @ 0.3g/L","Dimethoate 30% EC @ 2ml/L"],
      bacterial:["Copper Oxychloride @ 3g/L"],
    }
  }
};

/* â”€â”€ Calendar State â”€â”€ */
let calWeatherData    = null;
let calCurrentLat     = null;
let calCurrentLon     = null;
let calCurrentCrop    = null;
let calCurrentSowDate = null;

/* â”€â”€ Open / Close Panel â”€â”€ */
function openCalendar() {
  document.getElementById('calendarPanel').classList.add('open');
  document.body.style.overflow = 'hidden';
  // Set today as default sowing date if not set
  const sd = document.getElementById('calSowDate');
  if (!sd.value) {
    sd.value = new Date().toISOString().split('T')[0];
  }
}
function closeCalendar() {
  document.getElementById('calendarPanel').classList.remove('open');
  document.body.style.overflow = '';
}

/* â”€â”€ Auto-detect location â”€â”€ */
function detectCalLocation() {
  const btn = document.getElementById('calDetectBtn');
  btn.classList.add('detecting');
  btn.textContent = 'âŒ› Detectingâ€¦';
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      calCurrentLat = pos.coords.latitude.toFixed(4);
      calCurrentLon = pos.coords.longitude.toFixed(4);
      document.getElementById('calLocation').value = `${calCurrentLat}, ${calCurrentLon}`;
      btn.classList.remove('detecting');
      btn.textContent = 'âœ“ Located';
      setTimeout(() => { btn.textContent = 'ğŸ“ Auto'; }, 2000);
    },
    () => {
      btn.classList.remove('detecting');
      btn.textContent = 'ğŸ“ Auto';
      // Fallback to hidden lat/lon from main app
      calCurrentLat = document.getElementById('lat')?.value || '20.296';
      calCurrentLon = document.getElementById('lon')?.value || '85.824';
      document.getElementById('calLocation').value = `${calCurrentLat}, ${calCurrentLon}`;
    },
    { timeout: 8000 }
  );
}

/* â”€â”€ Geocode city name to lat/lon â”€â”€ */
async function geocodeLocation(loc) {
  if (!loc) return null;
  // If already lat,lon format
  const latLonMatch = loc.match(/^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/);
  if (latLonMatch) return { lat: parseFloat(latLonMatch[1]), lon: parseFloat(latLonMatch[2]) };
  // Use Open-Meteo geocoding API
  try {
    const r = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(loc)}&count=1&language=en&format=json`);
    const d = await r.json();
    if (d.results && d.results.length > 0) {
      return { lat: d.results[0].latitude, lon: d.results[0].longitude, name: d.results[0].name };
    }
  } catch(e) {}
  return null;
}

/* â”€â”€ Fetch 14-day weather forecast â”€â”€ */
async function fetchWeatherForecast(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
    `&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,relative_humidity_2m_max,relative_humidity_2m_min,weathercode` +
    `&timezone=auto&forecast_days=14`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('Weather API error');
  return await res.json();
}

/* â”€â”€ WMO weather code â†’ icon and description â”€â”€ */
function wmoToIcon(code) {
  if (code === 0) return { icon:'â˜€ï¸', desc:'Clear sky' };
  if (code <= 2)  return { icon:'ğŸŒ¤ï¸', desc:'Partly cloudy' };
  if (code <= 3)  return { icon:'â˜ï¸', desc:'Overcast' };
  if (code <= 49) return { icon:'ğŸŒ«ï¸', desc:'Foggy' };
  if (code <= 57) return { icon:'ğŸŒ¦ï¸', desc:'Drizzle' };
  if (code <= 67) return { icon:'ğŸŒ§ï¸', desc:'Rain' };
  if (code <= 77) return { icon:'â„ï¸', desc:'Snowfall' };
  if (code <= 82) return { icon:'ğŸŒ§ï¸', desc:'Rain showers' };
  if (code <= 86) return { icon:'ğŸŒ¨ï¸', desc:'Snow showers' };
  if (code <= 99) return { icon:'â›ˆï¸', desc:'Thunderstorm' };
  return { icon:'ğŸŒ¤ï¸', desc:'Variable' };
}

/* â”€â”€ Calculate risk level for a day â”€â”€ */
function calcDayRisk(maxTemp, minTemp, humidity, rain, cropKey) {
  const crop = CROP_DB[cropKey];
  if (!crop) return { level:'low', score:20 };
  let score = 10;

  // Humidity-based fungal risk
  if (humidity >= 90) score += 40;
  else if (humidity >= 80) score += 25;
  else if (humidity >= 70) score += 12;

  // Temperature-based
  if (maxTemp >= 38) score += 20; // heat stress
  else if (maxTemp >= 32 && humidity >= 75) score += 15; // warm+humid = fungal
  else if (maxTemp >= 28 && humidity >= 80) score += 20; // optimal fungal zone
  if (minTemp <= 10) score += 15; // cold stress
  if (minTemp <= 5)  score += 10;

  // Rainfall
  if (rain >= 25) score += 25; // heavy rain
  else if (rain >= 10) score += 15;
  else if (rain >= 3)  score += 8;

  // Crop-specific: rice needs extra fungal caution in heat+humidity
  if (cropKey === 'rice' && maxTemp >= 28 && humidity >= 80) score += 10;
  if (cropKey === 'potato' && humidity >= 80) score += 15; // late blight
  if (cropKey === 'tomato' && humidity >= 75) score += 12;

  score = Math.min(score, 100);
  const level = score >= 65 ? 'high' : score >= 40 ? 'medium' : 'low';
  return { level, score };
}

/* â”€â”€ Determine current crop stage by week â”€â”€ */
function getCropStage(cropKey, weekNum) {
  const crop = CROP_DB[cropKey];
  if (!crop) return null;
  for (const stage of crop.stages) {
    if (weekNum >= stage.weeks[0] && weekNum <= stage.weeks[1]) return stage;
  }
  return crop.stages[crop.stages.length - 1]; // default last stage
}

/* â”€â”€ Get sowing week offset â”€â”€ */
function getSowingWeek(sowDate) {
  const sow = new Date(sowDate);
  const now = new Date();
  const diffDays = Math.floor((now - sow) / (1000 * 60 * 60 * 24));
  return Math.max(1, Math.ceil(diffDays / 7));
}

/* â”€â”€ Identify likely diseases given conditions â”€â”€ */
function getDiseasesForConditions(cropKey, maxTemp, humidity, rain) {
  const crop = CROP_DB[cropKey];
  if (!crop) return [];
  let diseases = [];
  if (humidity >= 75) diseases.push(...(crop.diseases.high_humidity || []));
  if (maxTemp >= 35)  diseases.push(...(crop.diseases.high_temp || []));
  if (maxTemp <= 12)  diseases.push(...(crop.diseases.low_temp || []));
  if (rain >= 10)     diseases.push(...(crop.diseases.rain || []));
  if (humidity <= 40 && rain < 2) diseases.push(...(crop.diseases.dry || []));
  return [...new Set(diseases)].slice(0, 3);
}

/* â”€â”€ Get spray recommendation based on dominant risk â”€â”€ */
function getSprayRecommendation(cropKey, maxTemp, humidity, rain) {
  const crop = CROP_DB[cropKey];
  if (!crop) return '';
  let type = 'fungal';
  if (humidity >= 75 || rain >= 10) type = 'fungal';
  if (maxTemp >= 35 && humidity < 60) type = 'insect';
  const sprays = crop.sprays[type] || [];
  return sprays[0] || 'Consult local KVK for recommendations';
}

/* â”€â”€ Build weekly schedule data from weather â”€â”€ */
function buildWeeklySchedule(weatherData, cropKey, sowDate) {
  const daily = weatherData.daily;
  const dates = daily.time;
  const weeks = [];
  const sowWeekNum = getSowingWeek(sowDate);

  for (let w = 0; w < 2; w++) { // 2 weeks from weather data (14 days)
    const dayStart = w * 7;
    const dayEnd   = Math.min(dayStart + 7, dates.length);
    if (dayStart >= dates.length) break;

    // Aggregate week stats
    let totalRain = 0, maxHum = 0, maxTempMax = 0, minTempMin = 100, totalWx = 0;
    const days = [];
    for (let d = dayStart; d < dayEnd; d++) {
      const r = daily.precipitation_sum[d] || 0;
      const h = daily.relative_humidity_2m_max[d] || 50;
      const tmax = daily.temperature_2m_max[d] || 25;
      const tmin = daily.temperature_2m_min[d] || 18;
      const code = daily.weathercode?.[d] || 1;
      totalRain += r; maxHum = Math.max(maxHum, h);
      maxTempMax = Math.max(maxTempMax, tmax);
      minTempMin = Math.min(minTempMin, tmin);
      totalWx += code;
      const dayRisk = calcDayRisk(tmax, tmin, h, r, cropKey);
      days.push({
        date: dates[d],
        rain: r.toFixed(1), temp: tmax.toFixed(0),
        risk: dayRisk.level, code
      });
    }

    const avgCode = Math.round(totalWx / days.length);
    const weekRisk = calcDayRisk(maxTempMax, minTempMin, maxHum, totalRain / days.length, cropKey);
    const wx = wmoToIcon(avgCode);
    const weekNum = sowWeekNum + w;
    const stage = getCropStage(cropKey, weekNum);
    const diseases = getDiseasesForConditions(cropKey, maxTempMax, maxHum, totalRain);
    const spray = getSprayRecommendation(cropKey, maxTempMax, maxHum, totalRain);

    weeks.push({
      weekNum, dayStart, days,
      wxIcon: wx.icon, wxDesc: wx.desc,
      maxTemp: maxTempMax.toFixed(0), minTemp: minTempMin.toFixed(0),
      humidity: maxHum.toFixed(0), rain: totalRain.toFixed(1),
      risk: weekRisk.level, riskScore: weekRisk.score,
      stage, diseases, spray,
      dateRange: `${formatDate(dates[dayStart])} â€“ ${formatDate(dates[Math.min(dayEnd-1, dates.length-1)])}`
    });
  }

  // Add 2 more weeks with estimated data (beyond forecast)
  const lastWx = weeks.length > 0 ? weeks[weeks.length - 1] : null;
  for (let w = 2; w < 4; w++) {
    const weekNum = sowWeekNum + w;
    const stage = getCropStage(cropKey, weekNum);
    const estRain = lastWx ? parseFloat(lastWx.rain) * 0.9 : 5;
    const estHum  = lastWx ? parseFloat(lastWx.humidity) * 0.95 : 60;
    const estTemp = lastWx ? parseFloat(lastWx.maxTemp) : 28;
    const estMin  = lastWx ? parseFloat(lastWx.minTemp) : 18;
    const weekRisk = calcDayRisk(estTemp, estMin, estHum, estRain / 7, cropKey);
    const diseases = getDiseasesForConditions(cropKey, estTemp, estHum, estRain / 7);
    const spray = getSprayRecommendation(cropKey, estTemp, estHum, estRain / 7);

    // Build 7 simulated days
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + w * 7);
    const simDays = [];
    for (let d = 0; d < 7; d++) {
      const dd = new Date(startDate); dd.setDate(dd.getDate() + d);
      const r = (estRain / 7 + (Math.random() - 0.5) * 2).toFixed(1);
      const t = (estTemp + (Math.random() - 0.5) * 3).toFixed(0);
      const risk = calcDayRisk(parseFloat(t), estMin, estHum, parseFloat(r), cropKey);
      simDays.push({ date: dd.toISOString().split('T')[0], rain: r, temp: t, risk: risk.level });
    }

    weeks.push({
      weekNum, days: simDays,
      wxIcon: w % 2 === 0 ? 'ğŸŒ¤ï¸' : 'â›…', wxDesc: 'Estimated',
      maxTemp: estTemp.toFixed(0), minTemp: estMin.toFixed(0),
      humidity: estHum.toFixed(0), rain: estRain.toFixed(1),
      risk: weekRisk.level, riskScore: weekRisk.score,
      stage, diseases, spray,
      dateRange: `Week ${weekNum} (Estimated)`,
      isEstimated: true
    });
  }

  return weeks;
}

function formatDate(str) {
  const d = new Date(str);
  return d.toLocaleDateString('en-IN', { day:'numeric', month:'short' });
}

/* â”€â”€ Compute overall risk across weeks â”€â”€ */
function computeOverallRisk(weeks) {
  if (!weeks.length) return { level:'low', score: 20 };
  const highCount   = weeks.filter(w => w.risk === 'high').length;
  const medCount    = weeks.filter(w => w.risk === 'medium').length;
  const avgScore    = weeks.reduce((a,b) => a + b.riskScore, 0) / weeks.length;
  if (highCount >= 2 || avgScore >= 65) return { level:'high', score: Math.round(avgScore) };
  if (highCount >= 1 || medCount >= 2 || avgScore >= 40) return { level:'medium', score: Math.round(avgScore) };
  return { level:'low', score: Math.round(avgScore) };
}

/* â”€â”€ Render weather banner â”€â”€ */
function renderWeatherBanner(weatherData) {
  const d = weatherData.daily;
  const code = d.weathercode?.[0] || 1;
  const wx = wmoToIcon(code);
  const maxT = d.temperature_2m_max[0]?.toFixed(1) || '--';
  const minT = d.temperature_2m_min[0]?.toFixed(1) || '--';
  const hum  = d.relative_humidity_2m_max[0]?.toFixed(0) || '--';
  const rain = d.precipitation_sum[0]?.toFixed(1) || '0';

  document.getElementById('calWxIcon').textContent = wx.icon;
  document.getElementById('calWxTemp').textContent = maxT + 'Â°C';
  document.getElementById('calWxDesc').textContent = wx.desc + ' Â· Today\'s Forecast';
  document.getElementById('calWxHum').textContent  = hum + '%';
  document.getElementById('calWxRain').textContent = rain + 'mm';
  document.getElementById('calWxMin').textContent  = minT + 'Â°C';
  document.getElementById('calWxMax').textContent  = maxT + 'Â°C';
  document.getElementById('calWeatherBanner').classList.add('visible');
}

/* â”€â”€ Render risk banner â”€â”€ */
function renderRiskBanner(overall, crop, weeks) {
  const banner = document.getElementById('calRiskBanner');
  const icons = { low:'ğŸŸ¢', medium:'ğŸŸ¡', high:'ğŸ”´' };
  const titles = {
    low:    'LOW RISK â€” Favourable Conditions',
    medium: 'MEDIUM RISK â€” Monitor Closely',
    high:   'HIGH RISK â€” Immediate Action Required'
  };
  // Build description
  const highWeeks = weeks.filter(w => w.risk === 'high');
  const diseases  = [...new Set(weeks.flatMap(w => w.diseases))].slice(0, 4);
  let desc = '';
  if (overall.level === 'high') {
    desc = `Critical weather conditions over the next ${highWeeks.length} week(s) create high risk of ${diseases.slice(0,2).join(' and ') || 'disease outbreaks'}. Immediate preventive action recommended.`;
  } else if (overall.level === 'medium') {
    desc = `Moderate risk detected. Watch for ${diseases.slice(0,2).join(' and ') || 'potential disease pressure'}. Scout fields every 3-4 days.`;
  } else {
    desc = `Conditions are generally favourable for ${CROP_DB[crop]?.name}. Continue regular scouting and preventive management.`;
  }

  document.getElementById('calRiskIcon').textContent    = icons[overall.level];
  document.getElementById('calRiskTitle').textContent   = titles[overall.level];
  document.getElementById('calRiskDesc').textContent    = desc;
  document.getElementById('calRiskBadgeText').textContent = overall.level.toUpperCase();
  const dot = document.getElementById('calRiskDot');
  dot.className = `risk-dot ${overall.level}`;
  const badge = document.getElementById('calRiskBadge');
  badge.className = `risk-badge ${overall.level}`;
  banner.className = `cal-risk-banner visible risk-${overall.level}`;
}

/* â”€â”€ Render AI insight card â”€â”€ */
async function renderAIInsight(crop, weeks, weatherData, sowDate) {
  const card = document.getElementById('calAiCard');
  card.classList.add('visible');
  const aiText = document.getElementById('calAiText');
  aiText.textContent = 'Generating AI analysisâ€¦';

  const d = weatherData.daily;
  const avgMaxTemp = (d.temperature_2m_max.slice(0,7).reduce((a,b)=>a+b,0)/7).toFixed(1);
  const avgHum     = (d.relative_humidity_2m_max.slice(0,7).reduce((a,b)=>a+b,0)/7).toFixed(1);
  const totalRain  = d.precipitation_sum.slice(0,7).reduce((a,b)=>a+b,0).toFixed(1);
  const cropName   = CROP_DB[crop]?.name || crop;
  const sowWeek    = getSowingWeek(sowDate);
  const diseases   = [...new Set(weeks.flatMap(w => w.diseases))].slice(0, 5);
  const overall    = computeOverallRisk(weeks);

  // Build probability items
  const fungalRisk   = Math.min(Math.round((parseFloat(avgHum) - 40) * 1.8 + parseFloat(totalRain) * 0.8), 98);
  const pestRisk     = Math.min(Math.round(30 + (parseFloat(avgMaxTemp) - 25) * 2.2), 95);
  const heatStress   = Math.min(Math.round(Math.max(0, (parseFloat(avgMaxTemp) - 30) * 5)), 90);
  const probRow = document.getElementById('calProbRow');
  probRow.innerHTML = '';
  const probs = [
    { label:'Fungal Risk', pct: Math.max(10, fungalRisk), level: fungalRisk >= 65 ? 'high' : fungalRisk >= 40 ? 'medium' : 'low' },
    { label:'Pest Pressure', pct: Math.max(10, pestRisk), level: pestRisk >= 65 ? 'high' : pestRisk >= 40 ? 'medium' : 'low' },
    { label:'Heat Stress',  pct: Math.max(5, heatStress), level: heatStress >= 60 ? 'high' : heatStress >= 35 ? 'medium' : 'low' },
  ];
  probs.forEach(p => {
    const div = document.createElement('div');
    div.className = 'cal-prob-item';
    div.innerHTML = `<div class="cal-prob-label">${p.label} <span class="cal-prob-pct">${p.pct}%</span></div><div class="cal-prob-bar-track"><div class="cal-prob-bar-fill ${p.level}" style="width:0%" data-target="${p.pct}%"></div></div>`;
    probRow.appendChild(div);
  });
  // Animate bars after render
  setTimeout(() => {
    document.querySelectorAll('.cal-prob-bar-fill').forEach(el => {
      el.style.width = el.dataset.target;
    });
  }, 300);

  // Use /api/chat for AI insight (with language context)
  try {
    const prompt = `You are an expert agronomist AI. Based on these conditions, give a concise 2-3 sentence farming intelligence advisory (no headings, plain paragraph):
Crop: ${cropName}, Current week after sowing: ${sowWeek}, Avg max temperature: ${avgMaxTemp}Â°C, Avg humidity: ${avgHum}%, Rainfall (7 days): ${totalRain}mm, Likely diseases: ${diseases.join(', ') || 'none specific'}, Overall risk level: ${overall.level}.
Include the estimated disease probability percentage. Be specific to the crop and conditions. ${selectedLang !== 'en' ? 'Reply in ' + selectedLangName + '.' : ''}`;

    const res  = await fetch(API_BASE + '/api/chat', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ message: prompt, lang: selectedLang, lang_name: selectedLangName })
    });
    const data = await res.json();
    let reply  = data.reply || '';
    // If language translation needed on client side
    if (selectedLang !== 'en' && reply && !data.translated) {
      try {
        const turl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=${selectedLang}&dt=t&q=${encodeURIComponent(reply)}`;
        const tres = await fetch(turl);
        if (tres.ok) {
          const tdata = await tres.json();
          let translated = '';
          for (const seg of tdata[0]) { if (seg && seg[0]) translated += seg[0]; }
          if (translated) reply = translated;
        }
      } catch(e) {}
    }
    aiText.textContent = reply || `Based on ${avgMaxTemp}Â°C temperature and ${avgHum}% humidity, disease probability is approximately ${Math.round((parseFloat(avgHum)-40)*1.2)}% for ${cropName}. ${overall.level === 'high' ? 'Immediate protective sprays are recommended.' : overall.level === 'medium' ? 'Preventive measures advised.' : 'Conditions are generally favourable.'}`;
  } catch(e) {
    // Fallback AI text if API unavailable
    const prob = Math.round(Math.max(15, (parseFloat(avgHum) - 40) * 1.5 + parseFloat(totalRain) * 0.5));
    aiText.textContent = `Based on rising temperatures of ${avgMaxTemp}Â°C and ${avgHum}% humidity, disease probability for ${cropName} is approximately ${Math.min(prob, 95)}%. ${diseases.length > 0 ? 'Watch for ' + diseases[0] + ' in the coming week.' : ''} ${overall.level === 'high' ? 'High humidity with intermittent rainfall creates critical fungal infection risk â€” preventive sprays are strongly recommended.' : overall.level === 'medium' ? 'Scout fields every 3-4 days and be prepared with fungicide applications if symptoms appear.' : 'Continue regular scouting; conditions are currently favourable for crop growth.'}`;
  }
}

/* â”€â”€ Render week cards â”€â”€ */
function renderWeekCards(weeks, cropKey) {
  const cropName = CROP_DB[cropKey]?.name || cropKey;
  const grid = document.getElementById('calWeeksGrid');
  grid.innerHTML = '';
  const crop = CROP_DB[cropKey];
  const riskColors = { low: 'var(--c-green-400)', medium: 'var(--c-gold)', high: 'var(--c-error)' };

  weeks.forEach((week, idx) => {
    const card = document.createElement('div');
    card.className = 'cal-week-card';
    card.setAttribute('data-week', idx);

    // Day strip HTML
    const daysHtml = week.days.map(day => `
      <div class="cal-day-pip">
        <div class="d-name">${new Date(day.date + 'T12:00:00').toLocaleDateString('en-IN', {weekday:'short'}).slice(0,2)}</div>
        <div class="d-tmp">${day.temp}Â°</div>
        <div class="d-rain">${parseFloat(day.rain) > 0 ? 'ğŸ’§' : 'â˜€'}</div>
        <div class="d-risk ${day.risk}"></div>
      </div>`).join('');

    // Diseases list
    const diseaseHtml = week.diseases.length > 0
      ? week.diseases.map(d => `<span class="cal-ws-tag ${week.risk === 'high' ? 'danger' : week.risk === 'medium' ? 'warn' : ''}">${d}</span>`).join('')
      : `<span class="cal-ws-tag">No major disease risk</span>`;

    // Activities
    const activitiesHtml = (week.stage?.activities || []).map(a => `<span class="cal-ws-tag">${a}</span>`).join('');

    const riskBadgeHtml = `<div class="risk-badge ${week.risk}"><span class="risk-dot ${week.risk}"></span>${week.risk.toUpperCase()}</div>`;
    const estimatedBadge = week.isEstimated ? '<span style="font-size:10px;color:var(--c-text-3);margin-left:6px;">(Estimated)</span>' : '';
    const stagePillHtml  = week.stage ? `<div class="cal-stage-pill">${week.stage.icon} ${week.stage.name}</div>` : '';

    card.innerHTML = `
      <div class="cal-week-header" onclick="toggleWeekCard(this.parentElement)">
        <div class="cal-week-left">
          <div class="cal-week-num">W${week.weekNum}</div>
          <div class="cal-week-info">
            <h4>${week.wxIcon} ${week.dateRange}${estimatedBadge}</h4>
            <p>${week.wxDesc} Â· ${week.maxTemp}Â°C max Â· ${week.humidity}% humidity Â· ${week.rain}mm rain</p>
          </div>
        </div>
        <div class="cal-week-right">
          ${riskBadgeHtml}
          <div class="cal-week-chevron">â–¼</div>
        </div>
      </div>
      <div class="cal-week-body">
        <div class="cal-week-inner">
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px;align-items:center;">
            ${stagePillHtml}
            <span style="font-size:12px;color:var(--c-text-3);">Crop Stage Â· ${cropName}</span>
          </div>
          <div class="cal-day-strip">${daysHtml}</div>
          <div class="cal-week-sections" style="margin-top:14px;">
            <div class="cal-week-section">
              <div class="cal-ws-icon">âœ…</div>
              <div class="cal-ws-content">
                <div class="cal-ws-label">Recommended Activities</div>
                <div class="cal-ws-tags">${activitiesHtml || '<span class="cal-ws-tag">Monitor crop status</span>'}</div>
              </div>
            </div>
            <div class="cal-week-section">
              <div class="cal-ws-icon">ğŸ¦ </div>
              <div class="cal-ws-content">
                <div class="cal-ws-label">Likely Pests / Diseases</div>
                <div class="cal-ws-tags">${diseaseHtml}</div>
              </div>
            </div>
            <div class="cal-week-section">
              <div class="cal-ws-icon">ğŸ’Š</div>
              <div class="cal-ws-content">
                <div class="cal-ws-label">Preventive Spray Suggestion</div>
                <div class="cal-ws-text">${week.spray}</div>
              </div>
            </div>
            <div class="cal-week-section">
              <div class="cal-ws-icon">ğŸŒ¤ï¸</div>
              <div class="cal-ws-content">
                <div class="cal-ws-label">Weather Summary</div>
                <div class="cal-ws-text">${week.wxIcon} ${week.wxDesc} â€” Max ${week.maxTemp}Â°C, Min ${week.minTemp}Â°C, Humidity up to ${week.humidity}%, Rainfall ${week.rain}mm${week.isEstimated ? ' (forecast estimated)':''}</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;

    grid.appendChild(card);

    // Auto-expand first week
    if (idx === 0) setTimeout(() => card.classList.add('expanded'), 300);
  });

  // Set subtitle
  document.getElementById('calWeekSubtitle').textContent = `for ${cropName}`;
}

/* â”€â”€ Toggle week card expand/collapse â”€â”€ */
function toggleWeekCard(card) {
  const wasExpanded = card.classList.contains('expanded');
  document.querySelectorAll('.cal-week-card').forEach(c => c.classList.remove('expanded'));
  if (!wasExpanded) card.classList.add('expanded');
}

/* â”€â”€ Set loading state â”€â”€ */
function setCalLoading(text) {
  document.getElementById('calLoading').classList.add('visible');
  document.getElementById('calLoadText').textContent = text;
  document.getElementById('calPlaceholder').style.display = 'none';
  document.getElementById('calDynamicContent').style.display = 'none';
}
function hideCalLoading() {
  document.getElementById('calLoading').classList.remove('visible');
}

/* â”€â”€ MAIN: Generate Calendar â”€â”€ */
async function generateCalendar() {
  const crop    = document.getElementById('calCrop').value;
  const sowDate = document.getElementById('calSowDate').value;
  const locStr  = document.getElementById('calLocation').value.trim();

  // Validation
  if (!crop) { alert('Please select a crop type.'); return; }
  if (!sowDate) { alert('Please enter the sowing date.'); return; }
  if (!locStr) { alert('Please enter your location or use Auto-detect.'); return; }

  const btn = document.getElementById('calGenerateBtn');
  btn.disabled = true;
  document.getElementById('calGenBtnText').textContent = 'â³ Generatingâ€¦';

  try {
    // 1. Geocode location
    setCalLoading('ğŸ“ Locating your farmâ€¦');
    let lat, lon;
    if (calCurrentLat && document.getElementById('calLocation').value.includes(calCurrentLat)) {
      lat = parseFloat(calCurrentLat); lon = parseFloat(calCurrentLon);
    } else {
      const geo = await geocodeLocation(locStr);
      if (!geo) throw new Error('Location not found. Try entering "City, State" or use Auto-detect.');
      lat = geo.lat; lon = geo.lon;
    }

    // 2. Fetch weather
    setCalLoading('ğŸŒ¦ï¸ Fetching 14-day forecastâ€¦');
    const weatherData = await fetchWeatherForecast(lat, lon);
    calWeatherData = weatherData;

    // 3. Build schedule
    setCalLoading('ğŸ§  Building your cultivation planâ€¦');
    const weeks = buildWeeklySchedule(weatherData, crop, sowDate);
    const overall = computeOverallRisk(weeks);

    // 4. Render all sections
    hideCalLoading();
    document.getElementById('calDynamicContent').style.display = 'block';
    renderWeatherBanner(weatherData);
    renderRiskBanner(overall, crop, weeks);
    renderWeekCards(weeks, crop);

    // 5. AI insight (async, non-blocking)
    setCalLoading('ğŸ¤– Generating AI insightsâ€¦');
    hideCalLoading();
    document.getElementById('calDynamicContent').style.display = 'block';
    renderAIInsight(crop, weeks, weatherData, sowDate);

    // 6. Scroll to results
    document.getElementById('calDynamicContent').scrollIntoView({ behavior:'smooth', block:'start' });

  } catch(err) {
    hideCalLoading();
    document.getElementById('calPlaceholder').style.display = 'flex';
    document.getElementById('calPlaceholder').innerHTML = `
      <div class="ph-icon">âš ï¸</div>
      <h3>Could Not Generate Calendar</h3>
      <p>${err.message || 'Please check your inputs and try again.'}</p>`;
  }

  btn.disabled = false;
  document.getElementById('calGenBtnText').textContent = 'ğŸš€ Generate My Calendar';
  calCurrentCrop    = crop;
  calCurrentSowDate = sowDate;
}

/* â”€â”€ Close on Escape key â”€â”€ */
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && document.getElementById('calendarPanel').classList.contains('open')) {
    closeCalendar();
  }
});

</script> <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Offline Mode Activated! Scope:', reg.scope))
        .catch(err => console.error('Offline Mode Failed:', err));
    });
  }
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH & PROFILE OVERLAYS CSS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<style>
/* â”€â”€ Nav Auth Button â”€â”€ */
.nav-auth-btn {
  display:flex;align-items:center;gap:6px;
  padding:7px 14px;
  background:rgba(45,138,68,0.12);
  border:1.5px solid rgba(45,138,68,0.35);
  border-radius:var(--r-full);
  color:var(--c-green-300);
  font-family:var(--ff-body);font-size:13px;font-weight:500;
  cursor:pointer;transition:all 0.25s ease;
  letter-spacing:0.02em;
}
.nav-auth-btn:hover {
  background:rgba(45,138,68,0.22);border-color:var(--c-green-400);
  transform:translateY(-1px);box-shadow:0 4px 16px rgba(45,138,68,0.2);
}
.nav-auth-btn.logged-in { background:rgba(45,138,68,0.2);border-color:var(--c-green-300); }

/* â”€â”€ Auth Overlay â”€â”€ */
.auth-overlay {
  position:fixed;inset:0;z-index:100000;
  background:rgba(0,0,0,0.75);
  backdrop-filter:blur(8px);
  display:flex;align-items:center;justify-content:center;
  padding:20px;
  animation:authFadeIn 0.3s ease both;
}
@keyframes authFadeIn { from{opacity:0;} to{opacity:1;} }

.auth-card {
  position:relative;width:100%;max-width:420px;
  background:rgba(10,18,12,0.95);
  backdrop-filter:blur(40px);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:32px;
  padding:40px 32px 36px;
  box-shadow:0 40px 100px rgba(0,0,0,0.7), 0 0 60px rgba(45,138,68,0.1);
  animation:authCardIn 0.4s cubic-bezier(0.34,1.3,0.64,1) both;
}
@keyframes authCardIn {
  from{opacity:0;transform:translateY(30px) scale(0.95);}
  to{opacity:1;transform:translateY(0) scale(1);}
}
.auth-close {
  position:absolute;top:16px;right:18px;
  background:none;border:none;color:var(--c-text-3);
  font-size:18px;cursor:pointer;line-height:1;padding:4px 8px;
  border-radius:8px;transition:all 0.2s;
}
.auth-close:hover { color:var(--c-text);background:rgba(255,255,255,0.06); }
.auth-logo { font-size:36px;margin-bottom:6px; }
.auth-title { font-family:var(--ff-display);font-size:28px;font-weight:600;color:var(--c-text);margin-bottom:2px; }
.auth-subtitle { font-size:12px;color:var(--c-text-3);margin-bottom:24px; }

.auth-tabs { display:flex;gap:6px;margin-bottom:24px;background:rgba(255,255,255,0.04);padding:4px;border-radius:12px; }
.auth-tab {
  flex:1;padding:8px;border:none;background:none;color:var(--c-text-2);
  font-family:var(--ff-body);font-size:13.5px;font-weight:500;border-radius:9px;cursor:pointer;transition:all 0.2s;
}
.auth-tab.active { background:rgba(45,138,68,0.25);color:var(--c-green-300); }

.auth-field { margin-bottom:14px; }
.auth-field label { display:block;font-size:11.5px;color:var(--c-text-3);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px; }
.auth-field input {
  width:100%;padding:11px 14px;
  background:rgba(255,255,255,0.05);
  border:1.5px solid rgba(255,255,255,0.08);
  border-radius:12px;color:var(--c-text);font-family:var(--ff-body);font-size:14px;
  outline:none;transition:border-color 0.2s;
}
.auth-field input:focus { border-color:rgba(45,138,68,0.5); }
.auth-error { font-size:12.5px;color:#e05252;min-height:18px;margin-bottom:8px; }
.auth-submit {
  width:100%;padding:12px;
  background:linear-gradient(135deg,var(--c-green-700),var(--c-green-500));
  border:none;border-radius:12px;color:white;font-family:var(--ff-body);
  font-size:14.5px;font-weight:600;cursor:pointer;
  transition:all 0.25s;letter-spacing:0.02em;
  box-shadow:0 4px 16px rgba(45,138,68,0.3);
}
.auth-submit:hover { transform:translateY(-2px);box-shadow:0 8px 24px rgba(45,138,68,0.4); }

/* â”€â”€ Profile Dashboard â”€â”€ */
.profile-overlay {
  position:fixed;inset:0;z-index:100000;
  background:rgba(0,0,0,0.65);backdrop-filter:blur(8px);
  display:flex;justify-content:flex-end;
  animation:authFadeIn 0.3s ease both;
}
.profile-panel {
  width:100%;max-width:560px;height:100vh;
  background:linear-gradient(180deg,rgba(10,22,14,0.98) 0%,rgba(8,15,11,0.99) 100%);
  backdrop-filter:blur(40px);
  border-left:1px solid rgba(255,255,255,0.08);
  display:flex;flex-direction:column;overflow:hidden;
  animation:slidePanelIn 0.4s cubic-bezier(0.34,1.1,0.64,1) both;
}
@keyframes slidePanelIn { from{transform:translateX(100%);} to{transform:translateX(0);} }

.profile-header {
  display:flex;align-items:center;gap:14px;
  padding:24px 24px 16px;
  border-bottom:1px solid var(--c-border);
  background:rgba(45,138,68,0.06);
  flex-shrink:0;
}
.profile-avatar {
  width:52px;height:52px;border-radius:50%;
  background:linear-gradient(135deg,var(--c-green-700),var(--c-green-500));
  display:grid;place-items:center;font-size:24px;flex-shrink:0;
}
.profile-name { font-family:var(--ff-display);font-size:20px;font-weight:600;color:var(--c-text); }
.profile-email { font-size:12px;color:var(--c-text-3);margin-top:2px; }
.profile-close {
  margin-left:auto;background:none;border:none;color:var(--c-text-3);
  font-size:20px;cursor:pointer;padding:4px 8px;border-radius:8px;transition:all 0.2s;
}
.profile-close:hover { color:var(--c-text);background:rgba(255,255,255,0.06); }

.profile-tabs { display:flex;gap:4px;padding:12px 16px 0;border-bottom:1px solid var(--c-border);flex-shrink:0; }
.ptab {
  padding:8px 16px;border:none;background:none;color:var(--c-text-3);
  font-family:var(--ff-body);font-size:13px;font-weight:500;border-radius:10px 10px 0 0;
  cursor:pointer;transition:all 0.2s;border-bottom:2px solid transparent;
}
.ptab.active { color:var(--c-green-300);border-bottom-color:var(--c-green-400);background:rgba(45,138,68,0.08); }

.ptab-content {
  flex:1;overflow-y:auto;padding:20px;
  scrollbar-width:thin;scrollbar-color:rgba(45,138,68,0.3) transparent;
}

/* Profile form */
.pform-grid { display:grid;grid-template-columns:1fr 1fr;gap:12px; }
.pform-full { grid-column:1/-1; }
.pform-group label { display:block;font-size:11px;color:var(--c-text-3);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:5px; }
.pform-group input,
.pform-group select,
.pform-group textarea {
  width:100%;padding:9px 12px;
  background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,255,255,0.08);
  border-radius:10px;color:var(--c-text);font-family:var(--ff-body);font-size:13.5px;
  outline:none;transition:border-color 0.2s;resize:none;
}
.pform-group input:focus,
.pform-group select:focus,
.pform-group textarea:focus { border-color:rgba(45,138,68,0.5); }
.pform-group select option { background:#0a1a0f; }

.profile-save-btn {
  flex:1;padding:11px;
  background:linear-gradient(135deg,var(--c-green-700),var(--c-green-500));
  border:none;border-radius:12px;color:white;font-family:var(--ff-body);
  font-size:14px;font-weight:600;cursor:pointer;transition:all 0.25s;
}
.profile-save-btn:hover { transform:translateY(-1px);box-shadow:0 6px 20px rgba(45,138,68,0.35); }
.profile-logout-btn {
  padding:11px 18px;background:rgba(224,82,82,0.1);border:1.5px solid rgba(224,82,82,0.25);
  border-radius:12px;color:#e05252;font-family:var(--ff-body);font-size:13px;cursor:pointer;transition:all 0.2s;
}
.profile-logout-btn:hover { background:rgba(224,82,82,0.18); }

/* â”€â”€ Recommendations â”€â”€ */
.rec-intro { margin-bottom:16px; }
.rec-intro p { font-size:13px;color:var(--c-text-2);margin-bottom:12px;line-height:1.55; }
.rec-generate-btn {
  width:100%;padding:12px;
  background:linear-gradient(135deg,rgba(45,138,68,0.3),rgba(45,138,68,0.15));
  border:1.5px solid rgba(45,138,68,0.4);border-radius:12px;
  color:var(--c-green-300);font-family:var(--ff-body);font-size:14px;font-weight:600;
  cursor:pointer;transition:all 0.25s;
}
.rec-generate-btn:hover { background:rgba(45,138,68,0.3);transform:translateY(-1px); }
.rec-loading { display:flex;align-items:center;gap:12px;padding:20px;color:var(--c-text-2);font-size:13.5px; }
.rec-spinner {
  width:22px;height:22px;border:2.5px solid rgba(45,138,68,0.2);
  border-top-color:var(--c-green-400);border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg);} }
.rec-section-label { font-size:11px;text-transform:uppercase;letter-spacing:0.09em;color:var(--c-green-400);font-weight:600;margin-bottom:10px; }

/* Oversupply warning */
.rec-warn-card {
  background:rgba(240,168,48,0.08);border:1.5px solid rgba(240,168,48,0.25);
  border-radius:12px;padding:12px 14px;margin-bottom:14px;font-size:13px;
  color:var(--c-amber);display:flex;gap:10px;align-items:flex-start;
}

/* Crop cards */
.rec-crops-grid { display:flex;flex-direction:column;gap:10px; }
.rec-crop-card {
  background:rgba(255,255,255,0.04);border:1px solid var(--c-border);
  border-radius:14px;padding:14px;cursor:default;transition:border-color 0.2s;
}
.rec-crop-card:hover { border-color:rgba(45,138,68,0.35); }
.rcc-top { display:flex;align-items:center;justify-content:space-between;margin-bottom:8px; }
.rcc-name { font-family:var(--ff-display);font-size:18px;font-weight:600;color:var(--c-text); }
.rcc-score {
  font-size:11px;font-weight:700;padding:3px 9px;border-radius:var(--r-full);
  background:rgba(45,138,68,0.2);color:var(--c-green-300);
}
.rcc-reason { font-size:12.5px;color:var(--c-text-2);margin-bottom:10px; }
.rcc-stats { display:flex;gap:8px;flex-wrap:wrap; }
.rcc-stat {
  font-size:11.5px;padding:4px 10px;border-radius:8px;
  background:rgba(255,255,255,0.05);color:var(--c-text-2);
}
.rcc-risk-low { color:#4cd964; }
.rcc-risk-med { color:var(--c-amber); }
.rcc-risk-hi  { color:#e05252; }

/* Market table */
.rec-market-table { border:1px solid var(--c-border);border-radius:12px;overflow:hidden;font-size:13px; }
.rmt-row { display:grid;grid-template-columns:2fr 1.5fr 1fr 1fr;padding:9px 14px;gap:8px; }
.rmt-head { background:rgba(45,138,68,0.1);color:var(--c-green-400);font-size:11px;text-transform:uppercase;letter-spacing:0.06em;font-weight:600; }
.rmt-row:not(.rmt-head) { border-top:1px solid var(--c-border);color:var(--c-text-2); }
.rmt-row:not(.rmt-head):hover { background:rgba(255,255,255,0.02); }
.rmt-up { color:#4cd964; } .rmt-dn { color:#e05252; }

/* Sustain tip */
.rec-sustain-tip {
  margin-top:14px;background:rgba(45,138,68,0.08);border:1px solid rgba(45,138,68,0.2);
  border-radius:12px;padding:12px 14px;font-size:13px;color:var(--c-text-2);
}
.rec-sustain-tip::before { content:'ğŸŒ¿ ';font-size:14px; }

/* Schemes */
.scheme-card {
  background:rgba(255,255,255,0.04);border:1px solid var(--c-border);
  border-radius:14px;padding:14px;margin-bottom:10px;
}
.scheme-name { font-weight:600;color:var(--c-text);margin-bottom:4px;font-size:14px; }
.scheme-benefit { font-size:12.5px;color:var(--c-text-2);margin-bottom:8px; }
.scheme-link {
  font-size:12px;color:var(--c-green-400);text-decoration:none;
  border:1px solid rgba(45,138,68,0.3);padding:4px 10px;border-radius:8px;
  display:inline-block;transition:all 0.2s;
}
.scheme-link:hover { background:rgba(45,138,68,0.1); }
.equip-card {
  background:rgba(255,255,255,0.04);border:1px solid var(--c-border);
  border-radius:14px;padding:12px 14px;margin-bottom:8px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.equip-tool { font-size:13.5px;color:var(--c-text);font-weight:500; }
.equip-cost { font-size:13px;color:var(--c-green-300); }
.equip-where { font-size:11.5px;color:var(--c-text-3);margin-top:2px; }

@media(max-width:600px) {
  .profile-panel { max-width:100%; }
  .pform-grid { grid-template-columns:1fr; }
  .pform-full { grid-column:1; }
}

/* â”€â”€ Notification Bell Button â”€â”€ */
.nav-notif-btn {
  position:relative;display:flex;align-items:center;justify-content:center;
  width:38px;height:38px;border-radius:50%;
  background:rgba(255,255,255,0.05);
  border:1.5px solid rgba(255,255,255,0.1);
  cursor:pointer;transition:all 0.25s ease;flex-shrink:0;
}
.nav-notif-btn:hover { background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2);transform:translateY(-1px); }
.nav-notif-btn.active { background:rgba(45,138,68,0.15);border-color:rgba(45,138,68,0.4); }
.notif-bell { font-size:16px;line-height:1;display:block; }
.notif-badge {
  position:absolute;top:-4px;right:-4px;
  min-width:17px;height:17px;padding:0 4px;
  background:#e05252;border-radius:var(--r-full);
  font-size:10px;font-weight:700;color:white;
  display:flex;align-items:center;justify-content:center;
  border:1.5px solid var(--c-bg);
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.nav-notif-btn:hover .notif-badge { transform:scale(1.15); }
.notif-badge.zero { display:none; }

/* â”€â”€ Notification Panel â”€â”€ */
.notif-panel {
  position:fixed;top:64px;right:16px;z-index:99998;
  width:340px;
  background:rgba(10,20,13,0.97);
  backdrop-filter:blur(40px) saturate(180%);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;
  box-shadow:0 24px 60px rgba(0,0,0,0.6), 0 0 40px rgba(45,138,68,0.08);
  overflow:hidden;
  transform-origin:top right;
  animation:notifPanelIn 0.3s cubic-bezier(0.34,1.3,0.64,1) both;
}
@keyframes notifPanelIn {
  from { opacity:0; transform:scale(0.88) translateY(-10px); }
  to   { opacity:1; transform:scale(1) translateY(0); }
}
.notif-panel-header {
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px 10px;
  border-bottom:1px solid var(--c-border);
}
.notif-panel-title { font-family:var(--ff-display);font-size:17px;font-weight:600;color:var(--c-text); }
.notif-clear-btn {
  font-size:11px;color:var(--c-text-3);background:none;border:none;cursor:pointer;
  padding:4px 8px;border-radius:8px;transition:all 0.2s;
}
.notif-clear-btn:hover { color:var(--c-green-300);background:rgba(45,138,68,0.1); }
.notif-list { max-height:380px;overflow-y:auto;padding:8px 0;scrollbar-width:thin;scrollbar-color:rgba(45,138,68,0.3) transparent; }
.notif-item {
  display:flex;gap:12px;align-items:flex-start;
  padding:11px 16px;transition:background 0.2s;cursor:default;
  border-left:3px solid transparent;
}
.notif-item:hover { background:rgba(255,255,255,0.03); }
.notif-item.unread { border-left-color:var(--c-green-400);background:rgba(45,138,68,0.05); }
.notif-item.warn   { border-left-color:var(--c-amber); }
.notif-item.alert  { border-left-color:#e05252; }
.notif-icon { font-size:20px;flex-shrink:0;margin-top:1px; }
.notif-body { flex:1;min-width:0; }
.notif-title { font-size:13px;font-weight:600;color:var(--c-text);margin-bottom:2px;line-height:1.3; }
.notif-desc  { font-size:12px;color:var(--c-text-2);line-height:1.45; }
.notif-time  { font-size:10.5px;color:var(--c-text-3);margin-top:4px; }
.notif-empty { padding:30px;text-align:center;color:var(--c-text-3);font-size:13px; }
.notif-dot { width:7px;height:7px;border-radius:50%;background:var(--c-green-400);flex-shrink:0;margin-top:5px; }

/* â”€â”€ Location status pill â”€â”€ */
.loc-status-pill {
  display:inline-flex;align-items:center;gap:5px;
  font-size:11px;color:var(--c-green-400);
  background:rgba(45,138,68,0.1);border:1px solid rgba(45,138,68,0.2);
  padding:3px 10px;border-radius:var(--r-full);
  position:fixed;bottom:14px;left:14px;z-index:3500;
  opacity:0;transition:opacity 0.5s ease;pointer-events:none;
}
.loc-status-pill.show { opacity:1; }
.loc-dot { width:6px;height:6px;border-radius:50%;background:var(--c-green-400);animation:locPulse 2s ease-in-out infinite; }
@keyframes locPulse { 0%,100%{opacity:1;}50%{opacity:0.4;} }
</style>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH OVERLAYS HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Auth Overlay (Login / Sign-Up) -->
<div id="authOverlay" class="auth-overlay" style="display:none;" onclick="if(event.target===this)closeAuthPanel()">
  <div class="auth-card">
    <button class="auth-close" onclick="closeAuthPanel()">âœ•</button>
    <div class="auth-logo">ğŸŒ¿</div>
    <h2 class="auth-title">AgriUstaad</h2>
    <p class="auth-subtitle">Your AI farming companion</p>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Login</button>
      <button class="auth-tab" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>
    <!-- Login Form -->
    <div id="formLogin" class="auth-form">
      <div class="auth-field"><label>Email</label><input type="email" id="loginEmail" placeholder="you@example.com" onkeydown="if(event.key==='Enter')doLogin()"/></div>
      <div class="auth-field"><label>Password</label><input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
      <div class="auth-error" id="loginError"></div>
      <button class="auth-submit" onclick="doLogin()"><span id="loginBtnText">Login â†’</span></button>
    </div>
    <!-- Sign-Up Form -->
    <div id="formSignup" class="auth-form" style="display:none;">
      <div class="auth-field"><label>Email</label><input type="email" id="signupEmail" placeholder="you@example.com"/></div>
      <div class="auth-field"><label>Phone (optional)</label><input type="tel" id="signupPhone" placeholder="+91 98765 43210"/></div>
      <div class="auth-field"><label>Password (min 6 chars)</label><input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doSignup()"/></div>
      <div class="auth-error" id="signupError"></div>
      <button class="auth-submit" onclick="doSignup()"><span id="signupBtnText">Create Account â†’</span></button>
    </div>
  </div>
</div>

<!-- Farmer Profile Dashboard -->
<div id="profileOverlay" class="profile-overlay" style="display:none;" onclick="if(event.target===this)closeProfilePanel()">
  <div class="profile-panel" onclick="event.stopPropagation()">
    <div class="profile-header">
      <div class="profile-avatar">ğŸŒ¾</div>
      <div>
        <div class="profile-name" id="profileName">Farmer</div>
        <div class="profile-email" id="profileEmail"></div>
      </div>
      <button class="profile-close" onclick="closeProfilePanel()">âœ•</button>
    </div>
    <div class="profile-tabs">
      <button class="ptab active" id="ptab-btn-info" onclick="switchProfileTab('info',this)">ğŸ‘¤ Profile</button>
      <button class="ptab" id="ptab-btn-recommend" onclick="switchProfileTab('recommend',this)">ğŸŒ± AI Crops</button>
      <button class="ptab" id="ptab-btn-schemes" onclick="switchProfileTab('schemes',this)">ğŸ›ï¸ Schemes</button>
    </div>

    <!-- Tab: Profile Info -->
    <div id="ptab-info" class="ptab-content">
      <div class="pform-grid">
        <div class="pform-group"><label>Full Name</label><input type="text" id="pFullName" placeholder="e.g. Ramesh Kumar"/></div>
        <div class="pform-group"><label>Age</label><input type="number" id="pAge" placeholder="42" min="18" max="100"/></div>
        <div class="pform-group pform-full"><label>Location / Village, District</label><input type="text" id="pLocation" placeholder="e.g. Bargarh, Odisha"/></div>
        <div class="pform-group"><label>Field Size (acres)</label><input type="number" id="pFieldSize" placeholder="3.5" step="0.5" min="0"/></div>
        <div class="pform-group"><label>Budget / Investment (â‚¹)</label><input type="number" id="pBudget" placeholder="15000"/></div>
        <div class="pform-group"><label>Soil Type</label>
          <select id="pSoilType"><option value="">Selectâ€¦</option><option>Clay Loam</option><option>Sandy Loam</option><option>Silty Loam</option><option>Black Cotton</option><option>Red Laterite</option><option>Alluvial</option></select></div>
        <div class="pform-group"><label>Soil pH</label><input type="number" id="pSoilPh" placeholder="6.5" step="0.1" min="3" max="10"/></div>
        <div class="pform-group"><label>Irrigation</label>
          <select id="pIrrigation"><option value="">Selectâ€¦</option><option>Drip</option><option>Flood</option><option>Sprinkler</option><option>Rain-fed</option><option>None</option></select></div>
        <div class="pform-group pform-full"><label>Previously Grown Crops (comma separated)</label><input type="text" id="pPrevCrops" placeholder="Rice, Maize, Groundnut"/></div>
        <div class="pform-group pform-full"><label>Planned Crops for Next Season (comma separated)</label><input type="text" id="pPlannedCrops" placeholder="Tomato, Onion"/></div>
        <div class="pform-group pform-full"><label>Soil Quality Notes</label><textarea id="pSoilNotes" rows="2" placeholder="e.g. Waterlogged in monsoon, low organic matter"></textarea></div>
        <div class="pform-group pform-full"><label>Other Notes</label><textarea id="pOtherNotes" rows="2" placeholder="Any other relevant infoâ€¦"></textarea></div>
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;">
        <button class="profile-save-btn" onclick="saveProfile()"><span id="saveBtnText">ğŸ’¾ Save Profile</span></button>
        <button class="profile-logout-btn" onclick="doLogout()">ğŸšª Logout</button>
      </div>
    </div>

    <!-- Tab: AI Crop Recommendations -->
    <div id="ptab-recommend" class="ptab-content" style="display:none;">
      <div class="rec-intro">
        <p>Based on your soil type, field size, budget, and local market trends, our AI recommends the best crops for your next season.</p>
        <button class="rec-generate-btn" onclick="loadRecommendations()"><span id="recBtnText">ğŸŒ± Get AI Recommendations</span></button>
      </div>
      <div id="recLoading" style="display:none;" class="rec-loading"><div class="rec-spinner"></div><span>Analysing your farm dataâ€¦</span></div>
      <div id="recResults" style="display:none;">
        <div id="recWarnings"></div>
        <div class="rec-section-label">ğŸ† Top Crop Recommendations</div>
        <div id="recCrops" class="rec-crops-grid"></div>
        <div class="rec-section-label" style="margin-top:20px;">ğŸ“ˆ Current Market Prices (Demo)</div>
        <div class="rec-market-table">
          <div class="rmt-row rmt-head"><span>Crop</span><span>Price</span><span>Demand</span><span>Trend</span></div>
          <div id="recMarketRows"></div>
        </div>
        <div id="recSustainTip" class="rec-sustain-tip"></div>
      </div>
    </div>

    <!-- Tab: Govt Schemes & Equipment -->
    <div id="ptab-schemes" class="ptab-content" style="display:none;">
      <div id="schemesContent"><p style="color:var(--c-text-3);text-align:center;padding:30px 0;font-size:13px;">Load AI Recommendations first to see relevant schemes &amp; equipment.</p></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NOTIFICATION PANEL HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="notifPanel" class="notif-panel" style="display:none;">
  <div class="notif-panel-header">
    <span class="notif-panel-title">ğŸ”” Alerts & Advisories</span>
    <button class="notif-clear-btn" onclick="clearAllNotifs()">Mark all read</button>
  </div>
  <div class="notif-list" id="notifList">
    <!-- populated by JS -->
  </div>
</div>

<!-- Location status pill -->
<div class="loc-status-pill" id="locStatusPill">
  <span class="loc-dot"></span>
  <span id="locStatusText">Detecting locationâ€¦</span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH & PROFILE JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _authUser = null;
let _recData  = null;

// â”€â”€ On page load: check if already logged in â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function initAuth() {
  try {
    const r = await fetch('/api/auth/me');
    const d = await r.json();
    if (d.logged_in) {
      _authUser = d.user;
      onLoginSuccess(d.user, d.profile);
    }
  } catch(e) {}
})();

// â”€â”€ Open/close auth overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAuthPanel() {
  if (_authUser) { openProfilePanel(); return; }
  document.getElementById('authOverlay').style.display = 'flex';
  setTimeout(() => document.getElementById('loginEmail')?.focus(), 100);
}
function closeAuthPanel() {
  document.getElementById('authOverlay').style.display = 'none';
}
function switchAuthTab(tab) {
  document.getElementById('formLogin').style.display  = tab === 'login'  ? '' : 'none';
  document.getElementById('formSignup').style.display = tab === 'signup' ? '' : 'none';
  document.getElementById('tabLogin').classList.toggle('active',  tab === 'login');
  document.getElementById('tabSignup').classList.toggle('active', tab === 'signup');
  document.getElementById('loginError').textContent  = '';
  document.getElementById('signupError').textContent = '';
}

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl    = document.getElementById('loginError');
  const btn      = document.getElementById('loginBtnText');
  errEl.textContent = '';
  if (!email || !password) { errEl.textContent = 'Please enter email and password.'; return; }
  btn.textContent = 'â³ Logging inâ€¦';
  try {
    const r = await fetch('/api/auth/login', {
      method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, password})
    });
    const d = await r.json();
    if (!r.ok) { errEl.textContent = d.error || 'Login failed.'; return; }
    closeAuthPanel();
    onLoginSuccess(d.user, null);
    fetchFullProfile();
  } catch(e) {
    errEl.textContent = 'Connection error. Please try again.';
  } finally {
    btn.textContent = 'Login â†’';
  }
}

// â”€â”€ Sign-Up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSignup() {
  const email    = document.getElementById('signupEmail').value.trim();
  const phone    = document.getElementById('signupPhone').value.trim();
  const password = document.getElementById('signupPassword').value;
  const errEl    = document.getElementById('signupError');
  const btn      = document.getElementById('signupBtnText');
  errEl.textContent = '';
  if (!email || !password) { errEl.textContent = 'Email and password are required.'; return; }
  if (password.length < 6)  { errEl.textContent = 'Password must be at least 6 characters.'; return; }
  btn.textContent = 'â³ Creating accountâ€¦';
  try {
    const r = await fetch('/api/auth/register', {
      method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({email, phone, password})
    });
    const d = await r.json();
    if (!r.ok) { errEl.textContent = d.error || 'Registration failed.'; return; }
    closeAuthPanel();
    onLoginSuccess(d.user, {});
    openProfilePanel(); // prompt them to fill profile
  } catch(e) {
    errEl.textContent = 'Connection error. Please try again.';
  } finally {
    btn.textContent = 'Create Account â†’';
  }
}

// â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogout() {
  await fetch('/api/auth/logout', {method:'POST'});
  _authUser = null;
  _recData  = null;
  closeProfilePanel();
  const btn = document.getElementById('navAuthBtn');
  document.getElementById('navAuthIcon').textContent = 'ğŸ‘¤';
  document.getElementById('navAuthLabel').textContent = 'Login';
  btn.classList.remove('logged-in');
}

// â”€â”€ After login: update UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onLoginSuccess(user, profile) {
  _authUser = user;
  const btn = document.getElementById('navAuthBtn');
  document.getElementById('navAuthIcon').textContent  = 'ğŸŒ¾';
  document.getElementById('navAuthLabel').textContent = (profile?.full_name || user.email.split('@')[0]);
  btn.classList.add('logged-in');
  if (profile) populateProfileForm(profile);
}

async function fetchFullProfile() {
  try {
    const r = await fetch('/api/auth/me');
    const d = await r.json();
    if (d.logged_in && d.profile) populateProfileForm(d.profile);
  } catch(e) {}
}

// â”€â”€ Profile Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openProfilePanel() {
  if (!_authUser) { openAuthPanel(); return; }
  document.getElementById('profileName').textContent  = _authUser.email.split('@')[0];
  document.getElementById('profileEmail').textContent = _authUser.email;
  document.getElementById('profileOverlay').style.display = 'flex';
}
function closeProfilePanel() {
  document.getElementById('profileOverlay').style.display = 'none';
}
function switchProfileTab(tab, el) {
  ['info','recommend','schemes'].forEach(t => {
    document.getElementById('ptab-' + t).style.display = t === tab ? '' : 'none';
    document.getElementById('ptab-btn-' + t)?.classList.toggle('active', t === tab);
  });
}

function populateProfileForm(p) {
  const s = (id, v) => { const el = document.getElementById(id); if(el && v != null) el.value = v; };
  s('pFullName',    p.full_name);
  s('pAge',         p.age);
  s('pLocation',    p.location);
  s('pFieldSize',   p.field_size_acres);
  s('pBudget',      p.budget_inr);
  s('pSoilType',    p.soil_type);
  s('pSoilPh',      p.soil_ph);
  s('pIrrigation',  p.irrigation);
  s('pSoilNotes',   p.soil_quality_notes);
  s('pOtherNotes',  p.other_notes);
  if (p.previous_crops) s('pPrevCrops', Array.isArray(p.previous_crops) ? p.previous_crops.join(', ') : p.previous_crops);
  if (p.planned_crops)  s('pPlannedCrops', Array.isArray(p.planned_crops) ? p.planned_crops.join(', ') : p.planned_crops);
  // Update nav label with name if available
  if (p.full_name && _authUser) {
    document.getElementById('navAuthLabel').textContent = p.full_name.split(' ')[0];
  }
}

async function saveProfile() {
  const g = id => document.getElementById(id)?.value || '';
  const csvToArr = s => s.split(',').map(x => x.trim()).filter(Boolean);
  const payload = {
    full_name:         g('pFullName'),
    age:               g('pAge'),
    location:          g('pLocation'),
    field_size_acres:  g('pFieldSize'),
    budget_inr:        g('pBudget'),
    soil_type:         g('pSoilType'),
    soil_ph:           g('pSoilPh'),
    irrigation:        g('pIrrigation'),
    soil_quality_notes:g('pSoilNotes'),
    other_notes:       g('pOtherNotes'),
    previous_crops:    csvToArr(g('pPrevCrops')),
    planned_crops:     csvToArr(g('pPlannedCrops')),
  };
  const btn = document.getElementById('saveBtnText');
  btn.textContent = 'â³ Savingâ€¦';
  try {
    const r = await fetch('/api/auth/profile', {
      method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)
    });
    const d = await r.json();
    if (d.success) {
      btn.textContent = 'âœ… Saved!';
      if (payload.full_name) document.getElementById('navAuthLabel').textContent = payload.full_name.split(' ')[0];
      setTimeout(() => btn.textContent = 'ğŸ’¾ Save Profile', 2000);
    } else {
      btn.textContent = 'âŒ Error saving';
      setTimeout(() => btn.textContent = 'ğŸ’¾ Save Profile', 2000);
    }
  } catch(e) {
    btn.textContent = 'âŒ Error';
    setTimeout(() => btn.textContent = 'ğŸ’¾ Save Profile', 2000);
  }
}

// â”€â”€ AI Crop Recommendations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRecommendations() {
  if (!_authUser) { closeProfilePanel(); openAuthPanel(); return; }
  document.getElementById('recLoading').style.display  = 'flex';
  document.getElementById('recResults').style.display  = 'none';
  document.getElementById('recBtnText').textContent    = 'â³ Analysingâ€¦';

  try {
    const r = await fetch('/api/auth/recommend', {method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
    const d = await r.json();
    if (!d.success) throw new Error(d.error || 'Failed');
    _recData = d.recommendation;
    renderRecommendations(_recData, d.demo);
  } catch(e) {
    document.getElementById('recLoading').style.display = 'none';
    document.getElementById('recBtnText').textContent = 'ğŸŒ± Get AI Recommendations';
    alert('Could not load recommendations. Please save your profile first and try again.');
  }
}

function renderRecommendations(rec, isDemo) {
  document.getElementById('recLoading').style.display = 'none';
  document.getElementById('recBtnText').textContent = 'ğŸ”„ Refresh';

  // Oversupply warnings
  const warnEl = document.getElementById('recWarnings');
  warnEl.innerHTML = (rec.oversupply_warnings || []).map(w => `
    <div class="rec-warn-card">âš ï¸ <div><strong>${w.crop}</strong>: ${w.warning}</div></div>
  `).join('');

  // Crop cards
  const riskClass = r => r === 'Low' ? 'rcc-risk-low' : r === 'Medium' ? 'rcc-risk-med' : 'rcc-risk-hi';
  document.getElementById('recCrops').innerHTML = (rec.top_crops || []).map(c => `
    <div class="rec-crop-card">
      <div class="rcc-top">
        <div class="rcc-name">${c.name}</div>
        <div class="rcc-score">${c.suitability_score}% match</div>
      </div>
      <div class="rcc-reason">${c.reason}</div>
      <div class="rcc-stats">
        <div class="rcc-stat">ğŸ’° Return: â‚¹${(c.expected_return_inr||0).toLocaleString()}</div>
        <div class="rcc-stat">ğŸ“¦ Invest: â‚¹${(c.investment_inr||0).toLocaleString()}</div>
        <div class="rcc-stat">â± ${c.duration_days} days</div>
        <div class="rcc-stat ${riskClass(c.risk_level)}">Risk: ${c.risk_level}</div>
        <div class="rcc-stat">ğŸ“ˆ ${c.market_price_qtl}</div>
      </div>
    </div>
  `).join('');

  // Market table (demo prices from top_crops)
  const marketCrops = [
    ...(rec.top_crops || []).map(c => ({name:c.name, price:c.market_price_qtl, demand:c.market_demand, trend: c.risk_level === 'Low' ? 'â–²' : 'â–¼', cls: c.risk_level === 'Low' ? 'rmt-up' : 'rmt-dn'})),
    {name:'Tomato', price:'â‚¹1,800/qtl', demand:'Medium', trend:'â–¼', cls:'rmt-dn'},
    {name:'Potato', price:'â‚¹1,400/qtl', demand:'Low', trend:'â–¼', cls:'rmt-dn'},
  ];
  document.getElementById('recMarketRows').innerHTML = marketCrops.map(c => `
    <div class="rmt-row">
      <span>${c.name}</span>
      <span>${c.price}</span>
      <span>${c.demand}</span>
      <span class="${c.cls}">${c.trend}</span>
    </div>
  `).join('');

  // Sustainability tip
  if (rec.sustainability_tip)
    document.getElementById('recSustainTip').textContent = rec.sustainability_tip;

  document.getElementById('recResults').style.display = 'block';

  // Populate schemes tab
  renderSchemes(rec);
  if (isDemo) {
    const tip = document.createElement('p');
    tip.style.cssText = 'font-size:11px;color:var(--c-text-3);margin-top:8px;text-align:center;';
    tip.textContent = '(Demo data â€” save your profile & connect Gemini API for personalised AI recommendations)';
    document.getElementById('recResults').appendChild(tip);
  }
}

function renderSchemes(rec) {
  const el = document.getElementById('schemesContent');
  const schemes = (rec.govt_schemes || []).map(s => `
    <div class="scheme-card">
      <div class="scheme-name">ğŸ›ï¸ ${s.name}</div>
      <div class="scheme-benefit">${s.benefit}</div>
      <a href="${s.url}" target="_blank" rel="noopener" class="scheme-link">Visit Official Site â†—</a>
    </div>
  `).join('');
  const equip = (rec.equipment_rental || []).map(e => `
    <div class="equip-card">
      <div><div class="equip-tool">ğŸšœ ${e.tool}</div><div class="equip-where">${e.where}</div></div>
      <div class="equip-cost">${e.rental_cost}</div>
    </div>
  `).join('');
  el.innerHTML = `
    <div class="rec-section-label" style="margin-bottom:10px;">Government Schemes</div>
    ${schemes || '<p style="color:var(--c-text-3);font-size:13px;">No schemes listed.</p>'}
    <div class="rec-section-label" style="margin-top:20px;margin-bottom:10px;">Equipment Rental</div>
    ${equip || '<p style="color:var(--c-text-3);font-size:13px;">No equipment listed.</p>'}
  `;
}
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FEATURE 1 â€” NOTIFICATION SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€ Notification data store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const NOTIF_STORAGE_KEY = 'agri_notifications_read';

const DEFAULT_NOTIFICATIONS = [
  {
    id:    'n1',
    type:  'alert',
    icon:  'ğŸ¦ ',
    title: 'Disease Alert: Leaf Blast detected nearby',
    desc:  '3 farmers within 5 km reported Leaf Blast on Paddy. Inspect your crop today and consider preventive Tricyclazole spray.',
    time:  'Today, 9:14 AM',
    unread: true,
  },
  {
    id:    'n2',
    type:  'warn',
    icon:  'ğŸŒ§ï¸',
    title: 'Spray Advisory: Heavy rain expected tomorrow',
    desc:  'Rain probability >70% in next 24 hrs. Postpone any pesticide or fertiliser application until weather clears.',
    time:  'Today, 8:30 AM',
    unread: true,
  },
  {
    id:    'n3',
    type:  'unread',
    icon:  'ğŸ’°',
    title: 'Mandi Price Update: Tomato dropped 18%',
    desc:  'Tomato prices fell to â‚¹1,800/qtl in Cuttack mandi. Consider alternative markets or delay selling.',
    time:  'Today, 7:00 AM',
    unread: true,
  },
  {
    id:    'n4',
    type:  '',
    icon:  'ğŸŒ±',
    title: 'Tip: Best time to sow Green Gram',
    desc:  'Current soil moisture and temperature are ideal for Green Gram (Moong) sowing. Expected yield: 6â€“8 qtl/acre.',
    time:  'Yesterday',
    unread: false,
  },
  {
    id:    'n5',
    type:  '',
    icon:  'ğŸ›ï¸',
    title: 'Scheme Reminder: PM-KISAN installment due',
    desc:  'The next PM-KISAN beneficiary list update is open. Ensure your Aadhaar-linked bank account is active.',
    time:  'Yesterday',
    unread: false,
  },
];

let _notifications = JSON.parse(JSON.stringify(DEFAULT_NOTIFICATIONS));
let _notifOpen = false;

/* â”€â”€ Restore read state from localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function restoreNotifState() {
  try {
    const readIds = JSON.parse(localStorage.getItem(NOTIF_STORAGE_KEY) || '[]');
    _notifications.forEach(n => { if (readIds.includes(n.id)) n.unread = false; });
    updateNotifBadge();
  } catch(e) {}
})();

function updateNotifBadge() {
  const unread = _notifications.filter(n => n.unread).length;
  const badge  = document.getElementById('notifBadge');
  if (!badge) return;
  badge.textContent = unread || '';
  badge.classList.toggle('zero', unread === 0);
}

function renderNotifList() {
  const list = document.getElementById('notifList');
  if (!list) return;
  if (!_notifications.length) {
    list.innerHTML = '<div class="notif-empty">âœ… You\'re all caught up!</div>';
    return;
  }
  list.innerHTML = _notifications.map(n => `
    <div class="notif-item ${n.unread ? n.type || 'unread' : ''}" id="notif-${n.id}" onclick="markRead('${n.id}')">
      <div class="notif-icon">${n.icon}</div>
      <div class="notif-body">
        <div class="notif-title">${n.title}</div>
        <div class="notif-desc">${n.desc}</div>
        <div class="notif-time">${n.time}</div>
      </div>
      ${n.unread ? '<div class="notif-dot"></div>' : ''}
    </div>
  `).join('');
}

function markRead(id) {
  const n = _notifications.find(x => x.id === id);
  if (n) n.unread = false;
  persistReadState();
  renderNotifList();
  updateNotifBadge();
}

function clearAllNotifs() {
  _notifications.forEach(n => n.unread = false);
  persistReadState();
  renderNotifList();
  updateNotifBadge();
}

function persistReadState() {
  try {
    const readIds = _notifications.filter(n => !n.unread).map(n => n.id);
    localStorage.setItem(NOTIF_STORAGE_KEY, JSON.stringify(readIds));
  } catch(e) {}
}

/* â”€â”€ Push a new dynamic notification (called from other features) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pushNotification(icon, title, desc, type = 'unread') {
  const id = 'dyn_' + Date.now();
  _notifications.unshift({ id, type, icon, title, desc, time: 'Just now', unread: true });
  updateNotifBadge();
  // Animate bell
  const bell = document.getElementById('navNotifBtn');
  if (bell) {
    bell.style.animation = 'none';
    bell.offsetHeight; // reflow
    bell.style.animation = 'bellRing 0.5s ease';
  }
}

function toggleNotifPanel() {
  const panel = document.getElementById('notifPanel');
  _notifOpen = !_notifOpen;
  panel.style.display = _notifOpen ? 'block' : 'none';
  document.getElementById('navNotifBtn').classList.toggle('active', _notifOpen);
  if (_notifOpen) renderNotifList();
}

/* Close panel when clicking outside */
document.addEventListener('click', function(e) {
  const panel = document.getElementById('notifPanel');
  const btn   = document.getElementById('navNotifBtn');
  if (_notifOpen && !panel.contains(e.target) && !btn.contains(e.target)) {
    _notifOpen = false;
    panel.style.display = 'none';
    btn.classList.remove('active');
  }
});

/* Bell ring animation */
const bellStyle = document.createElement('style');
bellStyle.textContent = `@keyframes bellRing { 0%{transform:rotate(0);}15%{transform:rotate(18deg);}30%{transform:rotate(-15deg);}45%{transform:rotate(12deg);}60%{transform:rotate(-8deg);}75%{transform:rotate(5deg);}100%{transform:rotate(0);} }`;
document.head.appendChild(bellStyle);
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FEATURE 2 â€” AUTO-DETECT LOCATION ON PAGE LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€ Global location state â€” shared across all features â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window._userLat      = null;
window._userLon      = null;
window._userCity     = null;
window._userState    = null;
window._userCountry  = null;
window._locationReady = false;

async function autoDetectLocation() {
  const pill    = document.getElementById('locStatusPill');
  const pillTxt = document.getElementById('locStatusText');

  /* 1 â€” Try browser Geolocation API */
  const coords = await new Promise(resolve => {
    if (!navigator.geolocation) { resolve(null); return; }
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
      ()  => resolve(null),
      { timeout: 7000, maximumAge: 300000 }
    );
  });

  if (!coords) {
    /* 2 â€” Fallback: IP-based geolocation (no key needed) */
    try {
      const r = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(5000) });
      if (r.ok) {
        const d = await r.json();
        if (d.latitude) {
          coords.lat = d.latitude; coords.lon = d.longitude;
          window._userCity    = d.city;
          window._userState   = d.region;
          window._userCountry = d.country_name;
        }
      }
    } catch(e) {}
  }

  if (!coords) return; // give up silently

  window._userLat = coords.lat;
  window._userLon = coords.lon;

  /* 3 â€” Reverse geocode to get city/state */
  if (!window._userCity) {
    try {
      const g = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${coords.lat}&lon=${coords.lon}&format=json`, { signal: AbortSignal.timeout(5000) });
      if (g.ok) {
        const gd = await g.json();
        window._userCity    = gd.address?.city || gd.address?.town || gd.address?.village || null;
        window._userState   = gd.address?.state || null;
        window._userCountry = gd.address?.country || null;
      }
    } catch(e) {}
  }

  window._locationReady = true;
  const locLabel = [window._userCity, window._userState].filter(Boolean).join(', ') || `${coords.lat.toFixed(2)}, ${coords.lon.toFixed(2)}`;

  /* 4 â€” Update hidden lat/lon fields used by existing analyze form */
  const latField = document.getElementById('lat');
  const lonField = document.getElementById('lon');
  if (latField && !latField.value) latField.value = coords.lat;
  if (lonField && !lonField.value) lonField.value = coords.lon;

  /* 5 â€” Show pill briefly then fade out */
  if (pill && pillTxt) {
    pillTxt.textContent = `ğŸ“ ${locLabel}`;
    pill.classList.add('show');
    setTimeout(() => pill.classList.remove('show'), 4000);
  }

  /* 6 â€” Auto-fill profile location field if empty */
  const pLocField = document.getElementById('pLocation');
  if (pLocField && !pLocField.value && locLabel) {
    pLocField.placeholder = `Detected: ${locLabel}`;
  }

  /* 7 â€” Push a location notification */
  pushNotification('ğŸ“', `Location detected: ${locLabel}`, `Weather & advisories are now personalised for your farm location.`, 'unread');

  /* 8 â€” Auto-trigger weather dashboard refresh with real coordinates */
  if (typeof initWeatherDashboard === 'function') {
    try { initWeatherDashboard(); } catch(e) {}
  }

  console.log(`âœ… Location detected: ${locLabel} (${coords.lat}, ${coords.lon})`);
}

/* Run location detection after language overlay is dismissed (app revealed) */
const _origReveal = window.revealApp;
window.revealApp = async function(...args) {
  if (_origReveal) _origReveal.apply(this, args);
  setTimeout(autoDetectLocation, 800); // slight delay after reveal animation
};

/* Also run if returning user (session restored, no overlay shown) */
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => {
    // If app is already revealed (returning user), run location detection
    const app = document.getElementById('appWrapper');
    if (app && app.classList.contains('revealed')) {
      autoDetectLocation();
    }
  }, 1200);
});
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FEATURE 3 â€” PERSONALISED AI CHAT WITH LOCATION + PROFILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/**
 * Build a rich farmer context string from:
 * - Detected GPS location (city, state)
 * - Logged-in farmer's profile (soil, crops, budget, etc.)
 * Injected into every chat message sent to /api/chat
 */
function buildFarmerContext() {
  const parts = [];

  /* Location context */
  if (window._locationReady && window._userCity) {
    const loc = [window._userCity, window._userState, window._userCountry].filter(Boolean).join(', ');
    parts.push(`Farmer's location: ${loc}`);
    if (window._userLat) parts.push(`GPS: ${window._userLat.toFixed(4)}, ${window._userLon.toFixed(4)}`);
  }

  /* Profile context */
  if (_authUser) {
    parts.push(`Farmer name: ${document.getElementById('pFullName')?.value || _authUser.email.split('@')[0]}`);
    const age       = document.getElementById('pAge')?.value;
    const fieldSz   = document.getElementById('pFieldSize')?.value;
    const soilType  = document.getElementById('pSoilType')?.value;
    const soilPh    = document.getElementById('pSoilPh')?.value;
    const budget    = document.getElementById('pBudget')?.value;
    const irrig     = document.getElementById('pIrrigation')?.value;
    const prev      = document.getElementById('pPrevCrops')?.value;
    const planned   = document.getElementById('pPlannedCrops')?.value;
    const notes     = document.getElementById('pSoilNotes')?.value;

    if (age)      parts.push(`Age: ${age}`);
    if (fieldSz)  parts.push(`Field size: ${fieldSz} acres`);
    if (soilType) parts.push(`Soil type: ${soilType}`);
    if (soilPh)   parts.push(`Soil pH: ${soilPh}`);
    if (budget)   parts.push(`Budget/investment capacity: â‚¹${parseInt(budget).toLocaleString()}`);
    if (irrig)    parts.push(`Irrigation: ${irrig}`);
    if (prev)     parts.push(`Previously grown crops: ${prev}`);
    if (planned)  parts.push(`Planned crops this season: ${planned}`);
    if (notes)    parts.push(`Soil notes: ${notes}`);
  }

  return parts.length
    ? `\n\n--- FARMER PROFILE CONTEXT (use this to personalize your advice) ---\n${parts.join('\n')}\n--- END CONTEXT ---`
    : '';
}

/**
 * Patch the existing sendChat function to inject farmer context.
 * We wrap it non-destructively so all existing logic still works.
 */
(function patchSendChat() {
  /* Wait until sendChat exists in window scope */
  function tryPatch() {
    if (typeof sendChat !== 'function') {
      setTimeout(tryPatch, 200);
      return;
    }
    const _origSendChat = sendChat;

    window.sendChat = async function() {
      /* Grab input before parent clears it */
      const inp = document.getElementById('chatInput');
      const originalMsg = inp?.value?.trim() || '';

      /* Inject farmer context into system_note before original function runs */
      const farmerCtx = buildFarmerContext();

      if (farmerCtx && originalMsg) {
        /* Temporarily patch fetch to intercept the /api/chat call */
        const _origFetch = window.fetch;
        window.fetch = async function(url, options = {}) {
          if (typeof url === 'string' && url.includes('/api/chat') && options.body) {
            try {
              const body = JSON.parse(options.body);
              /* Append farmer context to system_note */
              body.system_note = (body.system_note || '') + farmerCtx;
              body.farmer_location = window._userCity
                ? [window._userCity, window._userState].filter(Boolean).join(', ')
                : null;
              options = { ...options, body: JSON.stringify(body) };
            } catch(e) {}
            /* Restore fetch immediately after this call */
            window.fetch = _origFetch;
          }
          return _origFetch.apply(this, arguments);
        };
      }

      return _origSendChat.apply(this, arguments);
    };
  }
  tryPatch();
})();

/**
 * Also patch the /api/chat endpoint on the backend to use the enriched system_note.
 * The frontend already sends `system_note` in the body â€” we update auth.py's
 * chat_with_agronomist to accept and use it.
 * (Backend patch is in app.py â€” see modified app.py)
 */

/* â”€â”€ Visual indicator: show "Personalised" badge in chat header when logged in â”€â”€ */
function updateChatPersonalisedBadge() {
  const chatHeader = document.querySelector('.chat-header span');
  if (!chatHeader) return;
  const existing = document.getElementById('chatPersonalisedBadge');
  if (existing) existing.remove();

  if (_authUser || window._locationReady) {
    const badge = document.createElement('span');
    badge.id = 'chatPersonalisedBadge';
    badge.style.cssText = `
      font-size:10px;font-weight:600;
      background:rgba(45,138,68,0.2);
      border:1px solid rgba(45,138,68,0.35);
      color:var(--c-green-300);padding:2px 8px;
      border-radius:999px;margin-left:6px;
    `;
    badge.textContent = 'âœ¦ Personalised';
    chatHeader.appendChild(badge);
  }
}

/* Update badge when login state changes */
const _origOnLoginSuccess = window.onLoginSuccess;
window.onLoginSuccess = function(user, profile) {
  if (_origOnLoginSuccess) _origOnLoginSuccess(user, profile);
  setTimeout(updateChatPersonalisedBadge, 300);
};
setTimeout(updateChatPersonalisedBadge, 2000);
</script>
</body>
</html>
